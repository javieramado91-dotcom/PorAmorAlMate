<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Por Amor Al Mate - Gestión</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar personalizada sutil */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        /* Sidebar Scrollbar Dark */
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #44403c; border-radius: 10px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb:hover { background: #57534e; }

        .chart-bar { transition: height 1s ease-out; }
        
        /* Animaciones */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Estilos móvil optimizados */
        .mobile-nav-item {
            @apply flex flex-col items-center justify-center text-stone-400 transition-colors py-2 flex-1 touch-manipulation;
        }
        .mobile-nav-item.active {
            @apply text-emerald-600;
        }
        .mobile-nav-item.active svg {
            @apply stroke-[2.5px];
        }
        
        /* Safe Area para móviles con notch */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#FAFAF9] text-stone-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Check, X, TrendingUp, Package, DollarSign, Calendar, Search, 
            Trash2, Leaf, Award, Zap, Plus, AlertCircle, BarChart3, 
            BrainCircuit, Home, PieChart, Star, Pencil, Filter, 
            MoreHorizontal, Sun, Cloud, CloudRain, ChevronLeft, 
            ChevronRight, Wind, CloudLightning, MapPin, Settings, Loader2,
            Wallet, ArrowUpRight, ArrowDownLeft, Banknote, CreditCard,
            TrendingDown, Activity, Info, FileJson, LogOut, Lock, Shield, User, Wifi, WifiOff, Stethoscope, Coins, ShoppingBag, Minus, Layers, AlertTriangle, Tag, List, Receipt, CheckCircle2, Circle, Repeat, Truck, Phone, Mail, Code, ArrowUpCircle, ArrowDownCircle
        } from 'lucide-react';

        // --- FIREBASE SETUP ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch } from "firebase/firestore";

        // ==========================================
        // CONFIGURACIÓN ROBUSTA DE FIREBASE
        // ==========================================
        const localConfig = {
            apiKey: "AIzaSyDnsoEp_t5lvF4K1vkhK7cWJ-B3NGE3_AI",
            authDomain: "por-amor-al-mate.firebaseapp.com",
            projectId: "por-amor-al-mate",
            storageBucket: "por-amor-al-mate.firebasestorage.app",
            messagingSenderId: "136176515954",
            appId: "1:136176515954:web:1e530cab217c2bf5b67beb",
            measurementId: "G-GWN0PYZ2PK"
        };

        let firebaseConfig;
        let isConfigured = true;

        // Prioridad a la configuración inyectada por el entorno
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = localConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            isConfigured = false;
        }

        // --- PANTALLA DE ERROR DE CONFIGURACIÓN ---
        const ConfigErrorScreen = () => (
            <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-3xl p-8 shadow-2xl text-stone-800 text-center">
                    <div className="bg-red-100 text-red-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 mx-auto"><AlertCircle size={32} /></div>
                    <h1 className="text-2xl font-bold mb-2">Error de Conexión</h1>
                    <p className="text-stone-500 mb-6">No se pudo establecer conexión con la base de datos.</p>
                    <button onClick={() => window.location.reload()} className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">Reintentar</button>
                </div>
            </div>
        );

        // --- PANTALLA DE LOGIN (PIN) ---
        const LoginScreen = ({ onLogin, credentials }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                // Simulamos un pequeño delay para feedback visual
                setTimeout(() => {
                    if (username === credentials.user && password === credentials.pass) {
                        onLogin();
                    } else {
                        setError('Credenciales incorrectas');
                        setIsLoading(false);
                    }
                }, 600);
            };

            return (
                <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-500 relative">
                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-emerald-600 to-teal-700 opacity-10 pointer-events-none"></div>

                        <div className="p-8 pb-6 flex flex-col items-center justify-center relative z-10">
                            <div className="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-5 rounded-2xl mb-5 shadow-xl shadow-emerald-900/20 transform hover:scale-105 transition-transform duration-300">
                                <MateIcon size={48} strokeWidth={1.5} />
                            </div>
                            <h2 className="font-bold text-2xl text-stone-800 mb-1 tracking-tight text-center">Por Amor Al Mate</h2>
                            <p className="text-stone-500 text-sm font-medium tracking-wide uppercase">Acceso Seguro</p>
                        </div>

                        <form onSubmit={handleSubmit} className="px-8 pb-8 pt-2 space-y-5">
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Usuario</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Info size={18} /></div>
                                    <input 
                                        type="text" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="Ingrese usuario" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        autoFocus 
                                    />
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Contraseña</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Lock size={18} /></div>
                                    <input 
                                        type="password" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="••••••••" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                    />
                                </div>
                            </div>
                            {error && <div className="text-red-500 text-sm font-medium flex items-center gap-2 bg-red-50 p-3.5 rounded-xl animate-in slide-in-from-top-2 border border-red-100"><AlertCircle size={16} /> {error}</div>}
                            
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-gradient-to-r from-stone-800 to-stone-900 hover:from-stone-700 hover:to-stone-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-stone-900/20 transition-all active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4"
                            >
                                {isLoading ? <Loader2 size={20} className="animate-spin text-emerald-400" /> : 'Entrar'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- UTILS & COMPONENTS ---
        const getHash = (str) => {
            if (!str) return 0;
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return hash;
        };

        const GenerativePattern = ({ hash, color }) => {
            const patternType = Math.abs(hash) % 4; 
            return (
                <svg width="100%" height="100%" className="absolute inset-0 opacity-10 pointer-events-none">
                    <pattern id={`pattern-${hash}`} x="0" y="0" width="12" height="12" patternUnits="userSpaceOnUse">
                        {patternType === 0 && <circle cx="6" cy="6" r="2" fill={color} />}
                        {patternType === 1 && <path d="M0 12L12 0M-2 2L2 -2M10 14L14 10" stroke={color} strokeWidth="1.5" />}
                        {patternType === 2 && <rect x="3" y="3" width="6" height="6" rx="1" stroke={color} strokeWidth="1.5" fill="none" />}
                        {patternType === 3 && <path d="M6 0L6 12M0 6L12 6" stroke={color} strokeWidth="1" />}
                    </pattern>
                    <rect width="100%" height="100%" fill={`url(#pattern-${hash})`} />
                </svg>
            );
        };

        const MateIcon = ({ size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M7 10c0 4.5 2.5 8 7 8s7-3.5 7-8" /> <ellipse cx="14" cy="10" rx="7" ry="2.5" /> <path d="M14 10l-3-8" /> <path d="M11 2l-2 2" />
            </svg>
        );

        const SmartIcon = ({ iconName, color, detail }) => {
            const hash = getHash(detail);
            const IconMap = { 'pen-tool': Zap, 'leaf': Leaf, 'flask-conical': Package, 'crown': Award, 'mate': MateIcon };
            const IconComponent = IconMap[iconName] || MateIcon;
            return (
                <div className="relative w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden shadow-sm transition-transform hover:scale-105 duration-300 bg-white border border-stone-100">
                    <div className="absolute inset-0 opacity-20" style={{ backgroundColor: color }}></div>
                    <GenerativePattern hash={hash} color={color} />
                    <div className="relative z-10 drop-shadow-sm" style={{ color: color }}>
                        <IconComponent size={26} strokeWidth={2} />
                    </div>
                </div>
            );
        };

        const identifyCategory = (text) => {
            if (!text) return 'Varios';
            const t = text.toLowerCase();
            if (t.includes('imperial')) return 'Imperial';
            if (t.includes('camionero')) return 'Camionero';
            if (t.includes('torpedo')) return 'Torpedo';
            if (t.includes('bombilla')) return 'Accesorios';
            if (t.includes('termo') || t.includes('set') || t.includes('canasta')) return 'Sets';
            if (t.includes('yerba')) return 'Consumibles';
            return 'Varios';
        };

        const getSmartIconName = (description) => {
            if (!description) return 'mate';
            const lowerDesc = description.toLowerCase();
            if (lowerDesc.includes('bombilla')) return 'pen-tool'; 
            if (lowerDesc.includes('yerba')) return 'leaf';
            if (lowerDesc.includes('termo') || lowerDesc.includes('set')) return 'flask-conical';
            if (lowerDesc.includes('imperial') || lowerDesc.includes('camionero')) return 'crown';
            return 'mate'; 
        };

        const generateColorFromText = (text) => {
            if (!text) return '#5D8C57';
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center px-6 py-4 border-b border-stone-100 bg-stone-50/50 shrink-0">
                            <h3 className="font-bold text-lg text-stone-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-stone-200 rounded-full transition-colors text-stone-400 hover:text-stone-600"><X size={20} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, title, message, onConfirm, isDanger }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-300">
                        <div className="p-6 flex flex-col items-center text-center">
                            <div className={`p-4 rounded-full mb-4 ${isDanger ? 'bg-red-50 text-red-500' : 'bg-stone-100 text-stone-500'}`}>
                                {isDanger ? <Trash2 size={32} /> : <AlertCircle size={32} />}
                            </div>
                            <h3 className="text-xl font-bold text-stone-800 mb-2">{title}</h3>
                            <p className="text-stone-500 text-sm mb-6">{message}</p>
                            <div className="flex gap-3 w-full">
                                <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors">Cancelar</button>
                                <button onClick={() => { onConfirm(); onClose(); }} className={`flex-1 py-3 rounded-xl font-bold text-white transition-colors ${isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-stone-900 hover:bg-stone-800'}`}>Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgClass = type === 'success' ? 'bg-stone-900 text-white' : 'bg-red-500 text-white';
            return (
                <div className={`toast-enter fixed bottom-4 right-4 z-[80] px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 ${bgClass}`}>
                    {type === 'success' ? <Check size={18} /> : <AlertCircle size={18} />}
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const DailyVibe = ({ onOpenSettings, customLocation }) => {
            const [weather, setWeather] = useState({ icon: Sun, temp: 24, label: 'Soleado', city: 'Cargando...' });
            const [phrase, setPhrase] = useState('');
            
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        let lat, lon, city;
                        if (customLocation?.lat) { lat = customLocation.lat; lon = customLocation.lon; city = customLocation.name; } 
                        else {
                            // Default location
                            lat = -34.7633; lon = -61.8942; city = "General Pinto";
                        }
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const data = await response.json();
                        if (data.current_weather) {
                            const { temperature, weathercode } = data.current_weather;
                            let icon = Sun; let label = 'Soleado';
                            if (weathercode === 0) { icon = Sun; label = 'Despejado'; }
                            else if (weathercode >= 1 && weathercode <= 3) { icon = Cloud; label = 'Nublado'; }
                            else if (weathercode >= 45 && weathercode <= 48) { icon = Cloud; label = 'Neblina'; }
                            else if (weathercode >= 51 && weathercode <= 67) { icon = CloudRain; label = 'Lluvioso'; }
                            else if (weathercode >= 80 && weathercode <= 82) { icon = CloudRain; label = 'Lluvias'; }
                            else if (weathercode >= 95) { icon = CloudLightning; label = 'Tormenta'; }
                            setWeather({ icon, temp: Math.round(temperature), label, city });
                        }
                    } catch { setWeather(prev => ({ ...prev, city: customLocation?.name || 'Sin conexión' })); }
                };
                fetchWeather();
                const phrases = ["Hoy es un buen día para unos amargos.", "El mate no se le niega a nadie.", "Cebando sueños, cosechando momentos.", "La vida es como el mate, hay que saber cebarla.", "Arrancando la jornada con buena energía.", "Mate en mano, problemas volando.", "Unos verdes para aclarar las ideas.", "Charla que va, mate que viene."];
                setPhrase(phrases[Math.floor(Math.random() * phrases.length)]);
            }, [customLocation]);

            const today = new Date();
            const dateStr = new Intl.DateTimeFormat('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(today);
            const WeatherIcon = weather.icon;

            return (
                <div className="bg-stone-900 text-white px-5 py-4 rounded-3xl shadow-md mb-4 relative overflow-hidden group flex-shrink-0">
                    <div className="absolute top-0 right-0 p-4 opacity-10 transform translate-x-4 -translate-y-4"><WeatherIcon size={80} /></div>
                    <div className="relative z-10 flex items-center justify-between">
                        <div className="flex-1">
                            <div className="flex items-center gap-3 text-stone-400 text-xs font-medium mb-1 uppercase tracking-wider">
                                <span>{dateStr.charAt(0).toUpperCase() + dateStr.slice(1)}</span>
                                <div className="h-1 w-1 rounded-full bg-stone-600"></div>
                                <div className="flex items-center gap-1 text-emerald-400"><MapPin size={10} /><span>{weather.city}</span></div>
                            </div>
                            <div className="flex items-center gap-4">
                                <h2 className="text-lg md:text-xl font-bold leading-tight text-[#e8dcc0] flex-1">"{phrase}"</h2>
                                <div className="flex items-center gap-2 text-white bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm border border-white/5 shrink-0">
                                    <WeatherIcon size={16} /><span className="font-bold text-sm">{weather.temp}°</span>
                                </div>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="ml-4 p-2 rounded-full bg-white/5 hover:bg-white/10 text-stone-400 hover:text-white transition-colors" title="Cambiar ubicación"><Settings size={16} /></button>
                    </div>
                </div>
            );
        };

        const SimpleChart = ({ data, scope }) => {
            if (!data || data.length === 0) return <div className="h-32 flex items-center justify-center text-stone-400 text-sm">Sin datos para graficar</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="flex items-end gap-2 h-40 pt-4 pb-2 w-full overflow-x-auto">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center gap-1 group min-w-[20px]">
                            <div className="w-full bg-emerald-500/20 rounded-t-sm relative group-hover:bg-emerald-500 transition-colors chart-bar" style={{ height: maxVal > 0 ? `${(d.value / maxVal) * 100}%` : '0%' }}>
                                <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-stone-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10">${d.value.toLocaleString()}</div>
                            </div>
                            <span className="text-[10px] text-stone-400 font-medium rotate-0 truncate w-full text-center">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const MateManagerApp = () => {
            // AUTH & STATE
            const [isLocked, setIsLocked] = useState(true);
            const [credentials, setCredentials] = useState(() => {
                const saved = localStorage.getItem('mate_credentials');
                return saved ? JSON.parse(saved) : { user: 'Mate', pass: '9193' };
            });
            
            // CORE DATA
            const [user, setUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [connectionStatus, setConnectionStatus] = useState('checking'); 
            const [authErrorDetails, setAuthErrorDetails] = useState('');
            
            // APP DATA
            const [activeTab, setActiveTab] = useState('orders');
            const [orders, setOrders] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [debts, setDebts] = useState([]);
            const [incomes, setIncomes] = useState([]); 
            
            // UI STATE
            const [toasts, setToasts] = useState([]);
            const [orderFilter, setOrderFilter] = useState('all');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [statScope, setStatScope] = useState('month'); 
            const isFirstLoad = useRef(true); 
            
            // MODALS STATE
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [form, setForm] = useState({ client: '', detail: '', price: '', paid: false, paymentMethod: null, delivered: false, important: false, date: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
            const [pendingPaymentId, setPendingPaymentId] = useState(null);
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
            const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });
            const [isIncomeModalOpen, setIsIncomeModalOpen] = useState(false);
            const [incomeForm, setIncomeForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });
            const [isInventoryModalOpen, setIsInventoryModalOpen] = useState(false);
            const [editingProductId, setEditingProductId] = useState(null);
            const [inventoryForm, setInventoryForm] = useState({ name: '', detail: '', price: '' });
            const [searchProduct, setSearchProduct] = useState('');
            const [isDebtModalOpen, setIsDebtModalOpen] = useState(false);
            const [isDebtStatsOpen, setIsDebtStatsOpen] = useState(false);
            const [debtForm, setDebtForm] = useState({ detail: '', type: 'unique', installments: '', amount: '' });
            const [editingDebtId, setEditingDebtId] = useState(null);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDanger: false });
            const [isSaving, setIsSaving] = useState(false);
            const [isContactModalOpen, setIsContactModalOpen] = useState(false);

            // SETTINGS STATE
            const DEFAULT_LOCATION = { name: 'General Pinto', lat: -34.7633, lon: -61.8942, country: 'Argentina' };
            const [locationConfig, setLocationConfig] = useState(DEFAULT_LOCATION);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [settingsTab, setSettingsTab] = useState('location');
            const [settingsCity, setSettingsCity] = useState('');
            const [isSearchingCity, setIsSearchingCity] = useState(false);
            const [tempCredentials, setTempCredentials] = useState({ user: '', pass: '' });
            const [diagMessage, setDiagMessage] = useState(null);

            // --- INITIALIZATION ---
            useEffect(() => {
                if (!isConfigured) {
                    setConnectionStatus('disconnected');
                    return; 
                }

                // Configurar Auth
                const initAuth = async () => {
                    try { 
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth error:", e);
                        setConnectionStatus('disconnected');
                        setAuthErrorDetails(e.message);
                        addToast('Error de autenticación', 'error');
                    }
                };

                initAuth();

                // Listener de Auth Global
                const unsubscribe = onAuthStateChanged(auth, (u) => { 
                    setUser(u); 
                    setIsAuthLoading(false);
                    if (u) {
                        setConnectionStatus('connected');
                        // Verificar bloqueo local
                        const savedAuth = localStorage.getItem('mate_auth_token');
                        if (savedAuth === `valid_${credentials.pass}`) {
                            setIsLocked(false);
                        }
                    } else {
                        setConnectionStatus('disconnected');
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- DATA SYNC (FIRESTORE) ---
            useEffect(() => {
                if (!user || !isConfigured) return;

                // Callbacks de error para manejar desconexiones móviles
                const handleError = (context, error) => {
                    console.error(`Error fetching ${context}:`, error);
                    if (error.code === 'unavailable') {
                        setConnectionStatus('disconnected');
                        addToast('Sin conexión a internet', 'error');
                    }
                };

                // SETTINGS
                const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'general');
                const unsubSettings = onSnapshot(settingsRef, (s) => { 
                    if (s.exists() && s.data().location) setLocationConfig(s.data().location); 
                }, (e) => handleError('settings', e));
                
                // ORDERS
                const ordersRef = collection(db, 'artifacts', appId, 'users', user.uid, 'orders');
                const unsubOrders = onSnapshot(query(ordersRef), (s) => {
                    const loaded = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                    setOrders(loaded);
                    if (isFirstLoad.current && loaded.length > 0) { 
                        setCurrentDate(new Date(loaded[loaded.length - 1].date)); 
                        isFirstLoad.current = false; 
                    }
                }, (e) => handleError('orders', e));
                
                // EXPENSES
                const expensesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'expenses');
                const unsubExpenses = onSnapshot(query(expensesRef), (s) => {
                    setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, (e) => handleError('expenses', e));

                // INVENTORY
                const inventoryRef = collection(db, 'artifacts', appId, 'users', user.uid, 'inventory');
                const unsubInventory = onSnapshot(query(inventoryRef), (s) => {
                    setInventory(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                }, (e) => handleError('inventory', e));

                // DEBTS
                const debtsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'debts');
                const unsubDebts = onSnapshot(query(debtsRef), (s) => {
                    setDebts(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, (e) => handleError('debts', e));
                
                // INCOMES
                const incomesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'extra_incomes');
                const unsubIncomes = onSnapshot(query(incomesRef), (s) => {
                    setIncomes(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, (e) => handleError('incomes', e));

                return () => { 
                    unsubSettings(); unsubOrders(); unsubExpenses(); unsubIncomes(); unsubInventory(); unsubDebts(); 
                };
            }, [user]);

            // --- LOCAL AUTH HANDLERS ---
            const handleAppUnlock = () => {
                localStorage.setItem('mate_auth_token', `valid_${credentials.pass}`);
                setIsLocked(false);
                addToast('¡Bienvenido de nuevo!');
            };

            const handleLogout = () => {
                localStorage.removeItem('mate_auth_token');
                setIsLocked(true);
            };

            // --- HELPERS ---
            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            
            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };

            const monthLabel = new Intl.DateTimeFormat('es-AR', { month: 'long', year: 'numeric' }).format(currentDate);
            const capitalizedMonthLabel = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            // --- COMPUTED DATA ---
            const filteredOrders = useMemo(() => orders.filter(o => {
                const d = new Date(o.date);
                const matchesDate = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                const matchesSearch = (o.client + o.detail).toLowerCase().includes(searchTerm.toLowerCase());
                let matchesFilter = true;
                if (orderFilter === 'pending_pay') matchesFilter = !o.paid;
                if (orderFilter === 'pending_delivery') matchesFilter = !o.delivered;
                return matchesDate && matchesSearch && matchesFilter;
            }).sort((a, b) => (b.important - a.important) || (new Date(b.date) - new Date(a.date))), [orders, currentDate, searchTerm, orderFilter]);

            const filteredInventory = useMemo(() => inventory.filter(item => item.name.toLowerCase().includes(searchProduct.toLowerCase()) || (item.detail && item.detail.toLowerCase().includes(searchProduct.toLowerCase()))), [inventory, searchProduct]);

            const filteredDebts = useMemo(() => debts.filter(d => { const date = new Date(d.date); return date.getMonth() === currentDate.getMonth() && date.getFullYear() === currentDate.getFullYear(); }), [debts, currentDate]);

            const finances = useMemo(() => {
                const monthOrders = orders.filter(o => o.paid && new Date(o.date).getMonth() === currentDate.getMonth() && new Date(o.date).getFullYear() === currentDate.getFullYear());
                const monthExpenses = expenses.filter(e => new Date(e.date).getMonth() === currentDate.getMonth() && new Date(e.date).getFullYear() === currentDate.getFullYear());
                const monthIncomes = incomes.filter(i => new Date(i.date).getMonth() === currentDate.getMonth() && new Date(i.date).getFullYear() === currentDate.getFullYear());

                const incomeMonth = monthOrders.reduce((acc, o) => acc + o.price, 0) + monthIncomes.reduce((acc, i) => acc + i.amount, 0);
                const expenseMonth = monthExpenses.reduce((acc, e) => acc + e.amount, 0);
                const netProfitMonth = incomeMonth - expenseMonth;

                const movements = [
                    ...monthOrders.map(o => ({ ...o, type: 'income', description: `Pedido: ${o.client} - ${o.detail}`, amount: o.price, method: o.paymentMethod || 'cash' })),
                    ...monthIncomes.map(i => ({ ...i, type: 'income', description: `Ingreso: ${i.description}`, amount: i.amount, method: i.method || 'cash' })),
                    ...monthExpenses.map(e => ({ ...e, type: 'expense', method: e.method || 'cash' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const allPaid = orders.filter(o => o.paid);
                const totalCash = allPaid.filter(o => o.paymentMethod === 'cash').reduce((s,o) => s + o.price, 0) + incomes.filter(i => i.method === 'cash').reduce((s,i) => s + i.amount, 0) - expenses.filter(e => e.method === 'cash').reduce((s,e) => s + e.amount, 0);
                const totalTransfer = allPaid.filter(o => o.paymentMethod === 'transfer').reduce((s,o) => s + o.price, 0) + incomes.filter(i => i.method === 'transfer').reduce((s,i) => s + i.amount, 0) - expenses.filter(e => e.method === 'transfer').reduce((s,e) => s + e.amount, 0);
                
                return { movements, incomeMonth, expenseMonth, netProfitMonth, totalCash, totalTransfer, totalBalance: totalCash + totalTransfer };
            }, [orders, expenses, incomes, currentDate]);

            const statsAnalytics = useMemo(() => {
                const isMonth = statScope === 'month';
                const dataset = orders.filter(o => {
                    const d = new Date(o.date);
                    if (!o.paid) return false;
                    return isMonth ? (d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear()) : (d.getFullYear() === currentDate.getFullYear());
                });
                const totalRevenue = dataset.reduce((acc, o) => acc + o.price, 0);
                
                // Simplified Chart Data
                const chartData = [];
                if (isMonth) {
                    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                    for(let i=1; i<=daysInMonth; i++) {
                        const val = dataset.filter(o => new Date(o.date).getDate() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: `${i}`, value: val });
                    }
                } else {
                    ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"].forEach((m, i) => {
                        const val = dataset.filter(o => new Date(o.date).getMonth() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: m, value: val });
                    });
                }
                
                // Products Stats
                const counts = {}; const revenues = {};
                dataset.forEach(o => {
                    const words = o.detail.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(w => w.length > 3 && !['mate','el','la','con','de','un','premium'].includes(w));
                    let main = words.length > 0 ? words[0] : "varios";
                    if (main.endsWith('s')) main = main.slice(0, -1);
                    main = main.charAt(0).toUpperCase() + main.slice(1);
                    counts[main] = (counts[main] || 0) + 1;
                    revenues[main] = (revenues[main] || 0) + o.price;
                });
                const products = Object.keys(counts).map(k => ({ name: k, count: counts[k], revenue: revenues[k] })).sort((a,b) => b.revenue - a.revenue);
                
                const avgTicket = dataset.length > 0 ? Math.round(totalRevenue / dataset.length) : 0;
                const cashTotal = dataset.filter(o => o.paymentMethod === 'cash').reduce((s,o) => s + o.price, 0);
                const transferTotal = dataset.filter(o => o.paymentMethod === 'transfer').reduce((s,o) => s + o.price, 0);

                return { totalRevenue, chartData, products, avgTicket, paymentStats: { cash: cashTotal, transfer: transferTotal }, insight: totalRevenue > 0 ? `Ingresos totales: $${totalRevenue.toLocaleString()}` : "Sin datos suficientes." };
            }, [orders, currentDate, statScope]);

            // --- ACTIONS ---
            const handleSaveOrder = async (e) => {
                e.preventDefault(); 
                if (isSaving || !user) return;
                setIsSaving(true);
                
                const parts = form.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                const orderData = {
                    client: form.client, detail: form.detail, price: parseFloat(form.price) || 0,
                    paid: form.paid, paymentMethod: form.paid ? (form.paymentMethod || 'cash') : null,
                    delivered: form.delivered, important: form.important,
                    date: selectedDate.toISOString(),
                    aiColor: generateColorFromText(form.detail), aiIcon: getSmartIconName(form.detail), category: identifyCategory(form.detail)
                };
                
                try {
                    const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'orders');
                    if (editingId) await updateDoc(doc(colRef, editingId), orderData);
                    else { await addDoc(colRef, orderData); setCurrentDate(selectedDate); }
                    addToast(editingId ? 'Pedido actualizado' : 'Pedido guardado');
                    closeModal();
                } catch (err) { addToast('Error al guardar', 'error'); } finally { setIsSaving(false); }
            };

            const toggle = async (id, field) => {
                if(!user) return;
                const order = orders.find(o => o.id === id);
                if (order) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'orders', id), { [field]: !order[field] });
            };

            const removeOrder = (id) => { 
                setConfirmModal({
                    isOpen: true, title: 'Eliminar Pedido', message: '¿Estás seguro?', isDanger: true,
                    onConfirm: async () => {
                        if(user) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'orders', id));
                        addToast('Pedido eliminado');
                    }
                });
            };

            const closeModal = () => setIsModalOpen(false);

            // --- RENDER ---
            if (!isConfigured) return <ConfigErrorScreen />;
            if (isLocked) return <LoginScreen onLogin={handleAppUnlock} credentials={credentials} />;
            if (isAuthLoading) return <div className="h-full w-full flex flex-col items-center justify-center bg-[#FAFAF9] text-stone-500 gap-4"><Loader2 size={40} className="animate-spin text-[#5D8C57]" /><p className="font-medium animate-pulse">Cargando sistema...</p></div>;

            return (
                <div className="h-full w-full bg-[#FAFAF9] font-sans text-stone-800 flex flex-col md:flex-row overflow-hidden">
                    {toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}
                    
                    <ConfirmModal isOpen={confirmModal.isOpen} onClose={() => setConfirmModal({...confirmModal, isOpen: false})} title={confirmModal.title} message={confirmModal.message} onConfirm={confirmModal.onConfirm} isDanger={confirmModal.isDanger} />

                    {/* SIDEBAR (DESKTOP) */}
                    <aside className="hidden md:flex flex-col w-64 bg-stone-900 border-r border-stone-800 h-full flex-shrink-0 sticky top-0">
                        <div className="p-8 pb-4 flex items-center gap-3">
                            <div className="bg-emerald-600 text-white p-2 rounded-xl"><MateIcon size={24} /></div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-white">Por Amor Al Mate</h1>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <div className={`w-2 h-2 rounded-full ${connectionStatus === 'connected' ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                                    <p className="text-xs text-stone-400">{connectionStatus === 'connected' ? 'En línea' : 'Offline'}</p>
                                </div>
                            </div>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto sidebar-scrollbar">
                            {['orders:Pedidos:Home', 'inventory:Lista Precios:Tag', 'debts:Deudas:Receipt', 'finances:Finanzas:Wallet', 'stats:Estadísticas:BarChart3'].map(item => {
                                const [key, label, icon] = item.split(':');
                                const IconCmp = { Home, Tag, Receipt, Wallet, BarChart3 }[icon];
                                return (
                                    <button key={key} onClick={() => setActiveTab(key)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === key ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}>
                                        <IconCmp size={20} /> {label}
                                    </button>
                                );
                            })}
                        </nav>
                        <div className="p-4 border-t border-stone-800">
                             <button onClick={() => { setEditingId(null); setForm({ ...form, client: '', detail: '', price: '', paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3.5 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 mb-3">
                                <Plus size={20} /> Nuevo Pedido
                            </button>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-xs font-bold text-stone-500 hover:text-white transition-colors py-2"><LogOut size={14} /> Salir</button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 pb-24 md:pb-8 relative h-full overflow-y-auto custom-scrollbar">
                         {/* MOBILE HEADER */}
                        <div className="md:hidden bg-white/80 backdrop-blur-md sticky top-0 z-30 px-4 py-3 border-b border-stone-100 flex items-center justify-between">
                            <div className="flex items-center gap-2"><div className="bg-emerald-600 text-white p-1.5 rounded-lg"><MateIcon size={18} /></div><span className="font-bold text-stone-800">Por Amor Al Mate</span></div>
                            <button onClick={handleLogout} className="h-8 w-8 bg-stone-100 rounded-full flex items-center justify-center text-stone-500"><LogOut size={14} /></button>
                        </div>

                        <div className="p-4 md:p-8 max-w-5xl mx-auto space-y-6 animate-in fade-in duration-500">
                            <DailyVibe onOpenSettings={() => { setIsSettingsOpen(true); setSettingsTab('location'); }} customLocation={locationConfig} />

                            {/* DATE NAV */}
                            <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-stone-100">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronLeft size={20} /></button>
                                <div className="flex items-center gap-2"><Calendar size={16} className="text-stone-400" /><span className="font-bold text-lg text-stone-800 capitalize">{capitalizedMonthLabel}</span></div>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronRight size={20} /></button>
                            </div>

                            {/* TAB: ORDERS */}
                            {activeTab === 'orders' && (
                                <>
                                    <div className="relative"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder={`Buscar en ${monthLabel}...`} className="w-full pl-11 pr-4 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-stone-200 text-stone-700 placeholder:text-stone-400" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                    <div className="flex gap-2 pb-2 overflow-x-auto no-scrollbar">
                                        {[
                                            {id: 'all', label: 'Todos'}, 
                                            {id: 'pending_pay', label: 'Por Cobrar', activeClass: 'bg-amber-100 text-amber-700 border-amber-200'}, 
                                            {id: 'pending_delivery', label: 'Por Entregar', activeClass: 'bg-blue-100 text-blue-700 border-blue-200'}
                                        ].map(f => (
                                            <button key={f.id} onClick={() => setOrderFilter(f.id)} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap border ${orderFilter === f.id ? (f.activeClass || 'bg-stone-800 text-white border-stone-800') : 'bg-white text-stone-500 border-stone-200'}`}>{f.label}</button>
                                        ))}
                                    </div>

                                    <div className="space-y-4">
                                        {filteredOrders.length === 0 ? <div className="flex flex-col items-center justify-center py-20 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200"><Package size={48} className="mb-4 opacity-20" /><p>No hay pedidos.</p></div> : 
                                            filteredOrders.map(order => (
                                                <div key={order.id} className={`bg-white rounded-3xl p-5 border transition-all duration-300 relative overflow-hidden ${order.important ? 'border-amber-200 ring-4 ring-amber-50' : 'border-stone-100 shadow-sm'}`}>
                                                    <div className="flex justify-between items-start mb-3 relative z-10">
                                                        <div className="flex items-center gap-3">
                                                             <div className="bg-stone-50 p-2.5 rounded-2xl text-stone-600"><SmartIcon iconName={order.aiIcon} color={order.aiColor} detail={order.detail} /></div>
                                                             <div>
                                                                <h3 className="font-bold text-stone-900 text-lg leading-tight">{order.client}</h3>
                                                                <span className="text-[11px] font-bold tracking-wide uppercase text-stone-400">{order.category} • {new Date(order.date).toLocaleDateString()}</span>
                                                             </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                             <button onClick={() => toggle(order.id, 'important')} className={`p-2 rounded-xl transition-all ${order.important ? 'text-amber-400 bg-amber-50' : 'text-stone-300 hover:bg-stone-100 hover:text-stone-500'}`}><Star size={18} fill={order.important ? "currentColor" : "none"} /></button>
                                                             <button onClick={() => { setEditingId(order.id); setForm(order); setIsModalOpen(true); }} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-xl transition-colors"><Pencil size={18} /></button>
                                                        </div>
                                                    </div>
                                                    <p className="text-stone-600 text-sm mb-5 leading-relaxed pl-1">{order.detail}</p>
                                                    <div className="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-dashed border-stone-100">
                                                        <div className="flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-xl"><span className="text-lg font-black text-stone-800">${order.price.toLocaleString()}</span>{order.paymentMethod && (<div className={`flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ${order.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{order.paymentMethod === 'cash' ? <Banknote size={12}/> : <CreditCard size={12}/>}<span>{order.paymentMethod === 'cash' ? 'Efvo' : 'Transf'}</span></div>)}</div>
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => { if(order.paid) toggle(order.id,'paid'); else { setPendingPaymentId(order.id); setIsPaymentModalOpen(true); } }} className={`px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 ${order.paid ? 'bg-emerald-100 text-emerald-700' : 'bg-stone-100 text-stone-400'}`}>{order.paid ? <CheckCircle2 size={16} /> : <Circle size={16} />}{order.paid ? 'Pagado' : 'Cobrar'}</button>
                                                            <button onClick={() => toggle(order.id, 'delivered')} className={`px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 ${order.delivered ? 'bg-blue-100 text-blue-700' : 'bg-stone-100 text-stone-400'}`}><Package size={16} />{order.delivered ? 'Entregado' : 'Pendiente'}</button>
                                                            <button onClick={() => removeOrder(order.id)} className="p-2 text-stone-300 hover:text-red-500 bg-stone-50 rounded-xl ml-1"><Trash2 size={18} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </>
                            )}

                            {/* TAB: INVENTORY */}
                            {activeTab === 'inventory' && (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center"><h3 className="font-bold text-lg">Lista de Precios</h3><button onClick={() => { setEditingProductId(null); setInventoryForm({name:'',detail:'',price:''}); setIsInventoryModalOpen(true); }} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar</button></div>
                                    <div className="space-y-3">
                                        {filteredInventory.map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                                                <div className="flex items-center gap-4"><div className="bg-stone-50 p-2.5 rounded-xl text-stone-500"><Tag size={20} /></div><div><h4 className="font-bold text-stone-800 text-lg leading-tight">{item.name}</h4>{item.detail && <p className="text-sm text-stone-500 mt-1">{item.detail}</p>}</div></div>
                                                <div className="flex items-center gap-4"><span className="block text-xl font-bold text-stone-900">${item.price.toLocaleString()}</span><div className="flex gap-1"><button onClick={() => { setEditingProductId(item.id); setInventoryForm(item); setIsInventoryModalOpen(true); }} className="p-2 text-stone-400 hover:text-stone-800 bg-stone-50 rounded-lg"><Pencil size={18} /></button><button onClick={() => { if(user) deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'inventory',item.id)); }} className="p-2 text-stone-400 hover:text-red-500 bg-stone-50 rounded-lg"><Trash2 size={18} /></button></div></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                             {/* TAB: DEBTS */}
                             {activeTab === 'debts' && (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center"><h3 className="font-bold text-lg">Deudas</h3><button onClick={() => { setEditingDebtId(null); setDebtForm({detail:'',type:'unique',installments:'',amount:''}); setIsDebtModalOpen(true); }} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar</button></div>
                                    <div className="space-y-3">
                                        {filteredDebts.map(debt => (
                                            <div key={debt.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                                                <div className="flex items-center gap-4"><button onClick={() => { if(user) updateDoc(doc(db,'artifacts',appId,'users',user.uid,'debts',debt.id),{paid:!debt.paid}); }} className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${debt.paid ? 'bg-emerald-100 text-emerald-600' : 'bg-stone-100 text-stone-400'}`}>{debt.paid ? <CheckCircle2 size={20} /> : <Circle size={20} />}</button><div><h4 className={`font-bold text-lg leading-tight ${debt.paid ? 'text-stone-400 line-through' : 'text-stone-800'}`}>{debt.detail}</h4><p className="text-xs text-stone-400">{new Date(debt.date).toLocaleDateString()}</p></div></div>
                                                <span className={`block text-xl font-bold ${debt.paid ? 'text-stone-300' : 'text-stone-900'}`}>${debt.amount.toLocaleString()}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MOBILE NAVIGATION BAR (FIXED BOTTOM) */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-0 pb-safe pt-1 z-50 flex justify-between items-end shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)]">
                        <button onClick={() => setActiveTab('orders')} className={`mobile-nav-item ${activeTab === 'orders' ? 'active' : ''} pb-3 pt-2`}><Home size={20} strokeWidth={activeTab === 'orders' ? 2.5 : 2} /><span className="text-[10px] mt-1">Pedidos</span></button>
                        <button onClick={() => setActiveTab('inventory')} className={`mobile-nav-item ${activeTab === 'inventory' ? 'active' : ''} pb-3 pt-2`}><Tag size={20} strokeWidth={activeTab === 'inventory' ? 2.5 : 2} /><span className="text-[10px] mt-1">Precios</span></button>
                        
                        {/* MAIN FAB ACTION */}
                        <div className="relative -top-6 mx-1">
                             <button onClick={() => { setEditingId(null); setForm({ ...form, client: '', detail: '', price: '', paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} className="h-16 w-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-200 active:scale-95 transition-transform border-4 border-[#FAFAF9] z-50">
                                <Plus size={30} strokeWidth={2.5} />
                            </button>
                        </div>

                        <button onClick={() => setActiveTab('debts')} className={`mobile-nav-item ${activeTab === 'debts' ? 'active' : ''} pb-3 pt-2`}><Receipt size={20} strokeWidth={activeTab === 'debts' ? 2.5 : 2} /><span className="text-[10px] mt-1">Deudas</span></button>
                        <button onClick={() => setActiveTab('finances')} className={`mobile-nav-item ${activeTab === 'finances' ? 'active' : ''} pb-3 pt-2`}><Wallet size={20} strokeWidth={activeTab === 'finances' ? 2.5 : 2} /><span className="text-[10px] mt-1">Finanzas</span></button>
                    </div>

                    {/* MODAL: ORDER */}
                    <Modal isOpen={isModalOpen} onClose={closeModal} title={editingId ? "Editar Pedido" : "Nuevo Pedido"}>
                        <form onSubmit={handleSaveOrder} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Cliente</label><input type="text" placeholder="Nombre..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.client} onChange={e => setForm({...form, client: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><textarea rows={3} placeholder="Producto..." className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.detail} onChange={e => setForm({...form, detail: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Precio</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={form.price} onChange={e => setForm({...form, price: e.target.value})} /></div>
                            <div className="flex items-center gap-2 py-2"><button type="button" onClick={() => setForm({...form, important: !form.important})} className={`flex-1 py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${form.important ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white text-stone-400'}`}><Star size={18} fill={form.important ? "currentColor" : "none"} /> <span className="text-sm font-bold">Importante</span></button></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingId ? 'Guardar Cambios' : 'Confirmar Pedido')}</button>
                        </form>
                    </Modal>

                    {/* MODAL: INVENTORY */}
                    <Modal isOpen={isInventoryModalOpen} onClose={() => setIsInventoryModalOpen(false)} title={editingProductId ? "Editar Producto" : "Nuevo Producto"}>
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            if(isSaving || !user) return;
                            setIsSaving(true);
                            try {
                                const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'inventory');
                                const data = { name: inventoryForm.name, detail: inventoryForm.detail, price: parseFloat(inventoryForm.price) || 0 };
                                if(editingProductId) await updateDoc(doc(colRef, editingProductId), data);
                                else await addDoc(colRef, data);
                                setIsInventoryModalOpen(false);
                            } catch(e){ console.error(e); } finally { setIsSaving(false); }
                        }} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Producto</label><input type="text" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.name} onChange={e => setInventoryForm({...inventoryForm, name: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><input type="text" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.detail} onChange={e => setInventoryForm({...inventoryForm, detail: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Precio</label><input type="number" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={inventoryForm.price} onChange={e => setInventoryForm({...inventoryForm, price: e.target.value})} /></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 text-white py-4 rounded-xl font-bold">{isSaving ? 'Guardando...' : 'Guardar'}</button>
                        </form>
                    </Modal>

                     {/* MODAL: PAYMENT METHOD */}
                     <Modal isOpen={isPaymentModalOpen} onClose={() => setIsPaymentModalOpen(false)} title="Método de Pago">
                        <div className="grid grid-cols-2 gap-4 pt-2">
                            <button onClick={async () => { if(user && pendingPaymentId) { await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'orders',pendingPaymentId), {paid:true, paymentMethod:'cash'}); setIsPaymentModalOpen(false); setPendingPaymentId(null); } }} className="flex flex-col items-center justify-center p-6 bg-green-50 border border-green-200 rounded-2xl hover:bg-green-100 transition-colors gap-3"><div className="bg-green-100 text-green-700 p-3 rounded-full"><Banknote size={32} /></div><span className="font-bold text-green-800">Efectivo</span></button>
                            <button onClick={async () => { if(user && pendingPaymentId) { await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'orders',pendingPaymentId), {paid:true, paymentMethod:'transfer'}); setIsPaymentModalOpen(false); setPendingPaymentId(null); } }} className="flex flex-col items-center justify-center p-6 bg-blue-50 border border-blue-200 rounded-2xl hover:bg-blue-100 transition-colors gap-3"><div className="bg-blue-100 text-blue-700 p-3 rounded-full"><CreditCard size={32} /></div><span className="font-bold text-blue-800">Transferencia</span></button>
                        </div>
                    </Modal>

                     {/* SETTINGS MODAL */}
                     <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} title="Configuración">
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            setIsSearchingCity(true);
                            try {
                                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(settingsCity)}&count=1&language=es&format=json`);
                                const data = await res.json();
                                if(data.results?.[0]) {
                                    const place = data.results[0];
                                    const newConf = { name: place.name, lat: place.latitude, lon: place.longitude, country: place.country };
                                    setLocationConfig(newConf);
                                    if(user) await setDoc(doc(db,'artifacts',appId,'users',user.uid,'settings','general'), {location: newConf}, {merge:true});
                                    setIsSettingsOpen(false);
                                    addToast('Ubicación actualizada');
                                } else addToast('Ciudad no encontrada','error');
                            } catch(e){ console.error(e); } finally { setIsSearchingCity(false); }
                        }} className="space-y-4">
                            <p className="text-sm text-stone-500">Cambiar ubicación para el clima.</p>
                            <input type="text" placeholder="Ciudad..." className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={settingsCity} onChange={e => setSettingsCity(e.target.value)} />
                            <button type="submit" disabled={isSearchingCity} className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold">{isSearchingCity ? 'Buscando...' : 'Guardar'}</button>
                        </form>
                    </Modal>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MateManagerApp />);
    </script>
</body>
</html>
