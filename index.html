<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßâ</text></svg>">
    
    <title>Por Amor Al Mate - Gesti√≥n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF & AutoTable for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar personalizada sutil */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        /* Sidebar Scrollbar Dark */
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #44403c; border-radius: 10px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb:hover { background: #57534e; }

        .chart-bar { transition: height 1s ease-out; }
        
        /* Animaciones para Toasts */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Estilos m√≥vil */
        .mobile-nav-item {
            @apply flex flex-col items-center justify-center text-stone-400 transition-colors py-2 flex-1;
        }
        .mobile-nav-item.active {
            @apply text-emerald-600;
        }
        .mobile-nav-item.active svg {
            @apply stroke-[2.5px];
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#FAFAF9] text-stone-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Check, X, TrendingUp, Package, DollarSign, Calendar, Search, 
            Trash2, Leaf, Award, Zap, Plus, AlertCircle, BarChart3, 
            BrainCircuit, Home, PieChart, Star, Pencil, Filter, 
            MoreHorizontal, Sun, Cloud, CloudRain, ChevronLeft, 
            ChevronRight, Wind, CloudLightning, MapPin, Settings, Loader2,
            Wallet, ArrowUpRight, ArrowDownLeft, Banknote, CreditCard,
            TrendingDown, Activity, Info, FileJson, LogOut, Lock, Shield, User, Wifi, WifiOff, Stethoscope, Coins, ShoppingBag, Minus, Layers, AlertTriangle, Tag, List, Receipt, CheckCircle2, Circle, Repeat, Truck, Phone, Mail, Code, ArrowUpCircle, ArrowDownCircle, Printer, Boxes, AlertOctagon, Split, Clock, Edit3, ShoppingCart, ToggleLeft, ToggleRight
        } from 'lucide-react';

        // --- FIREBASE SETUP ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch, getDoc } from "firebase/firestore";

        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const localConfig = {
            apiKey: "AIzaSyDnsoEp_t5lvF4K1vkhK7cWJ-B3NGE3_AI",
            authDomain: "por-amor-al-mate.firebaseapp.com",
            projectId: "por-amor-al-mate",
            storageBucket: "por-amor-al-mate.firebasestorage.app",
            messagingSenderId: "136176515954",
            appId: "1:136176515954:web:1e530cab217c2bf5b67beb",
            measurementId: "G-GWN0PYZ2PK"
        };

        let firebaseConfig;
        let isConfigured = true;

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = localConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            isConfigured = false;
        }

        // --- PANTALLA DE ERROR DE CONFIGURACI√ìN ---
        const ConfigErrorScreen = () => (
            <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-3xl p-8 shadow-2xl text-stone-800">
                    <div className="bg-red-100 text-red-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6"><AlertCircle size={32} /></div>
                    <h1 className="text-2xl font-bold mb-2">Error Cr√≠tico</h1>
                    <p className="text-stone-500 mb-6">No se pudo iniciar la conexi√≥n con Firebase.</p>
                    <button onClick={() => window.location.reload()} className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">Reintentar</button>
                </div>
            </div>
        );

        // --- PANTALLA DE LOGIN ---
        const LoginScreen = ({ onLogin, credentials }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                setTimeout(() => {
                    if (username === credentials.user && password === credentials.pass) {
                        onLogin();
                    } else {
                        setError('Usuario o contrase√±a incorrectos');
                        setIsLoading(false);
                    }
                }, 800);
            };

            return (
                <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-500 relative">
                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-emerald-600 to-teal-700 opacity-10 pointer-events-none"></div>

                        <div className="p-8 pb-6 flex flex-col items-center justify-center relative z-10">
                            <div className="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-5 rounded-2xl mb-5 shadow-xl shadow-emerald-900/20 transform hover:scale-105 transition-transform duration-300">
                                <MateIcon size={48} strokeWidth={1.5} />
                            </div>
                            <h2 className="font-bold text-2xl text-stone-800 mb-1 tracking-tight text-center">Por Amor Al Mate</h2>
                            <p className="text-stone-500 text-sm font-medium tracking-wide uppercase">Sistema de Gesti√≥n</p>
                        </div>

                        <form onSubmit={handleSubmit} className="px-8 pb-8 pt-2 space-y-5">
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Usuario</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Info size={18} /></div>
                                    <input 
                                        type="text" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="Ingrese usuario" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        autoFocus 
                                    />
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Contrase√±a</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Lock size={18} /></div>
                                    <input 
                                        type="password" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                    />
                                </div>
                            </div>
                            {error && <div className="text-red-500 text-sm font-medium flex items-center gap-2 bg-red-50 p-3.5 rounded-xl animate-in slide-in-from-top-2 border border-red-100"><AlertCircle size={16} /> {error}</div>}
                            
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-gradient-to-r from-stone-800 to-stone-900 hover:from-stone-700 hover:to-stone-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-stone-900/20 transition-all active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4"
                            >
                                {isLoading ? <Loader2 size={20} className="animate-spin text-emerald-400" /> : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>
                        
                         <div className="bg-stone-50 p-4 text-center border-t border-stone-100">
                             <p className="text-[10px] text-stone-400 font-medium">¬© {new Date().getFullYear()} Por Amor Al Mate</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- UTILS & COMPONENTS ---
        const getHash = (str) => {
            if (!str) return 0;
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return hash;
        };

        const GenerativePattern = ({ hash, color }) => {
            const patternType = Math.abs(hash) % 4; 
            return (
                <svg width="100%" height="100%" className="absolute inset-0 opacity-10 pointer-events-none">
                    <pattern id={`pattern-${hash}`} x="0" y="0" width="12" height="12" patternUnits="userSpaceOnUse">
                        {patternType === 0 && <circle cx="6" cy="6" r="2" fill={color} />}
                        {patternType === 1 && <path d="M0 12L12 0M-2 2L2 -2M10 14L14 10" stroke={color} strokeWidth="1.5" />}
                        {patternType === 2 && <rect x="3" y="3" width="6" height="6" rx="1" stroke={color} strokeWidth="1.5" fill="none" />}
                        {patternType === 3 && <path d="M6 0L6 12M0 6L12 6" stroke={color} strokeWidth="1" />}
                    </pattern>
                    <rect width="100%" height="100%" fill={`url(#pattern-${hash})`} />
                </svg>
            );
        };

        const MateIcon = ({ size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M7 10c0 4.5 2.5 8 7 8s7-3.5 7-8" /> <ellipse cx="14" cy="10" rx="7" ry="2.5" /> <path d="M14 10l-3-8" /> <path d="M11 2l-2 2" />
            </svg>
        );

        const SmartIcon = ({ iconName, color, detail }) => {
            const hash = getHash(detail);
            const IconMap = { 'pen-tool': Zap, 'leaf': Leaf, 'flask-conical': Package, 'crown': Award, 'mate': MateIcon };
            const IconComponent = IconMap[iconName] || MateIcon;
            return (
                <div className="relative w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden shadow-sm transition-transform hover:scale-105 duration-300 bg-white border border-stone-100">
                    <div className="absolute inset-0 opacity-20" style={{ backgroundColor: color }}></div>
                    <GenerativePattern hash={hash} color={color} />
                    <div className="relative z-10 drop-shadow-sm" style={{ color: color }}>
                        <IconComponent size={26} strokeWidth={2} />
                    </div>
                </div>
            );
        };

        const identifyCategory = (text) => {
            if (!text) return 'Varios';
            const t = text.toLowerCase();
            if (t.includes('imperial')) return 'Imperial';
            if (t.includes('camionero')) return 'Camionero';
            if (t.includes('torpedo')) return 'Torpedo';
            if (t.includes('bombilla')) return 'Accesorios';
            if (t.includes('termo') || t.includes('set') || t.includes('canasta')) return 'Sets';
            if (t.includes('yerba')) return 'Consumibles';
            return 'Varios';
        };

        const getSmartIconName = (description) => {
            if (!description) return 'mate';
            const lowerDesc = description.toLowerCase();
            if (lowerDesc.includes('bombilla')) return 'pen-tool'; 
            if (lowerDesc.includes('yerba')) return 'leaf';
            if (lowerDesc.includes('termo') || lowerDesc.includes('set')) return 'flask-conical';
            if (lowerDesc.includes('imperial') || lowerDesc.includes('camionero')) return 'crown';
            return 'mate'; 
        };

        const generateColorFromText = (text) => {
            if (!text) return '#5D8C57';
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center px-6 py-4 border-b border-stone-100 bg-stone-50/50 shrink-0">
                            <h3 className="font-bold text-lg text-stone-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-stone-200 rounded-full transition-colors text-stone-400 hover:text-stone-600"><X size={20} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, title, message, onConfirm, isDanger }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-300">
                        <div className="p-6 flex flex-col items-center text-center">
                            <div className={`p-4 rounded-full mb-4 ${isDanger ? 'bg-red-50 text-red-500' : 'bg-stone-100 text-stone-500'}`}>
                                {isDanger ? <Trash2 size={32} /> : <AlertCircle size={32} />}
                            </div>
                            <h3 className="text-xl font-bold text-stone-800 mb-2">{title}</h3>
                            <p className="text-stone-500 text-sm mb-6">{message}</p>
                            <div className="flex gap-3 w-full">
                                <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors">Cancelar</button>
                                <button onClick={() => { onConfirm(); onClose(); }} className={`flex-1 py-3 rounded-xl font-bold text-white transition-colors ${isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-stone-900 hover:bg-stone-800'}`}>Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgClass = type === 'success' ? 'bg-stone-900 text-white' : 'bg-red-500 text-white';
            return (
                <div className={`toast-enter fixed bottom-4 right-4 z-[80] px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 ${bgClass}`}>
                    {type === 'success' ? <Check size={18} /> : <AlertCircle size={18} />}
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const DailyVibe = ({ onOpenSettings, customLocation }) => {
            const [weather, setWeather] = useState({ icon: Sun, temp: 24, label: 'Soleado', city: 'Cargando...' });
            const [phrase, setPhrase] = useState('');
            
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        let lat, lon, city;
                        if (customLocation?.lat) { lat = customLocation.lat; lon = customLocation.lon; city = customLocation.name; } 
                        else {
                            lat = -34.7633; lon = -61.8942; city = "General Pinto";
                        }
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const data = await response.json();
                        if (data.current_weather) {
                            const { temperature, weathercode } = data.current_weather;
                            let icon = Sun; let label = 'Soleado';
                            if (weathercode === 0) { icon = Sun; label = 'Despejado'; }
                            else if (weathercode >= 1 && weathercode <= 3) { icon = Cloud; label = 'Nublado'; }
                            else if (weathercode >= 45 && weathercode <= 48) { icon = Cloud; label = 'Neblina'; }
                            else if (weathercode >= 51 && weathercode <= 67) { icon = CloudRain; label = 'Lluvioso'; }
                            else if (weathercode >= 80 && weathercode <= 82) { icon = CloudRain; label = 'Lluvias'; }
                            else if (weathercode >= 95) { icon = CloudLightning; label = 'Tormenta'; }
                            setWeather({ icon, temp: Math.round(temperature), label, city });
                        }
                    } catch { setWeather(prev => ({ ...prev, city: customLocation?.name || 'Sin conexi√≥n' })); }
                };
                fetchWeather();
                const phrases = ["Hoy es un buen d√≠a para unos amargos.", "El mate no se le niega a nadie.", "Cebando sue√±os, cosechando momentos.", "La vida es como el mate, hay que saber cebarla.", "Arrancando la jornada con buena energ√≠a.", "Mate en mano, problemas volando.", "Unos verdes para aclarar las ideas.", "Charla que va, mate que viene."];
                setPhrase(phrases[Math.floor(Math.random() * phrases.length)]);
            }, [customLocation]);

            const today = new Date();
            const dateStr = new Intl.DateTimeFormat('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(today);
            const WeatherIcon = weather.icon;

            return (
                <div className="bg-stone-900 text-white px-5 py-4 rounded-3xl shadow-md mb-4 relative overflow-hidden group flex-shrink-0">
                    <div className="absolute top-0 right-0 p-4 opacity-10 transform translate-x-4 -translate-y-4"><WeatherIcon size={80} /></div>
                    <div className="relative z-10 flex items-center justify-between">
                        <div className="flex-1">
                            <div className="flex items-center gap-3 text-stone-400 text-xs font-medium mb-1 uppercase tracking-wider">
                                <span>{dateStr.charAt(0).toUpperCase() + dateStr.slice(1)}</span>
                                <div className="h-1 w-1 rounded-full bg-stone-600"></div>
                                <div className="flex items-center gap-1 text-emerald-400"><MapPin size={10} /><span>{weather.city}</span></div>
                            </div>
                            <div className="flex items-center gap-4">
                                <h2 className="text-lg md:text-xl font-bold leading-tight text-[#e8dcc0] flex-1">"{phrase}"</h2>
                                <div className="flex items-center gap-2 text-white bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm border border-white/5 shrink-0">
                                    <WeatherIcon size={16} /><span className="font-bold text-sm">{weather.temp}¬∞</span>
                                </div>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="ml-4 p-2 rounded-full bg-white/5 hover:bg-white/10 text-stone-400 hover:text-white transition-colors" title="Cambiar ubicaci√≥n"><Settings size={16} /></button>
                    </div>
                </div>
            );
        };

        const SimpleChart = ({ data, scope }) => {
            if (!data || data.length === 0) return <div className="h-32 flex items-center justify-center text-stone-400 text-sm">Sin datos para graficar</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="flex items-end gap-2 h-40 pt-4 pb-2 w-full overflow-x-auto">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center gap-1 group min-w-[20px]">
                            <div className="w-full bg-emerald-500/20 rounded-t-sm relative group-hover:bg-emerald-500 transition-colors chart-bar" style={{ height: maxVal > 0 ? `${(d.value / maxVal) * 100}%` : '0%' }}>
                                <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-stone-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10">${d.value.toLocaleString()}</div>
                            </div>
                            <span className="text-[10px] text-stone-400 font-medium rotate-0 truncate w-full text-center">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const MateManagerApp = () => {
            const [isLocked, setIsLocked] = useState(true);
            const [credentials, setCredentials] = useState(() => {
                const saved = localStorage.getItem('mate_credentials');
                return saved ? JSON.parse(saved) : { user: 'Mate', pass: '9193' };
            });
            const [activeTab, setActiveTab] = useState('orders');
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [debts, setDebts] = useState([]);
            const [incomes, setIncomes] = useState([]); 
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [toasts, setToasts] = useState([]);
            
            // Filters
            const [orderFilter, setOrderFilter] = useState('all');

            // Connection Status
            const [connectionStatus, setConnectionStatus] = useState('checking'); 
            const [authErrorDetails, setAuthErrorDetails] = useState('');

            // Settings
            const DEFAULT_LOCATION = { name: 'General Pinto', lat: -34.7633, lon: -61.8942, country: 'Argentina' };
            const [locationConfig, setLocationConfig] = useState(DEFAULT_LOCATION);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [settingsTab, setSettingsTab] = useState('location');
            const [settingsCity, setSettingsCity] = useState('');
            const [isSearchingCity, setIsSearchingCity] = useState(false);
            const [tempCredentials, setTempCredentials] = useState({ user: '', pass: '' });
            const [diagMessage, setDiagMessage] = useState(null);
            
            // Contact
            const [isContactModalOpen, setIsContactModalOpen] = useState(false);

            const [currentDate, setCurrentDate] = useState(new Date());
            const [statScope, setStatScope] = useState('month'); 
            const isFirstLoad = useRef(true); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            
            // Order Form - UPDATED FOR MULTIPLE ITEMS
            const [form, setForm] = useState({ 
                client: '', items: [], price: 0, paid: false, paymentMethod: null, 
                delivered: false, important: false, date: '' 
            });
            // Sub-state for adding item to list
            const [subItem, setSubItem] = useState({ productId: '', quantity: 1, unitPrice: 0, detail: '' });
            const [isCustomItem, setIsCustomItem] = useState(false); // NEW STATE FOR MANUAL ITEM

            const [searchTerm, setSearchTerm] = useState('');
            
            // Payment Modal Logic updated for Mixed Payment
            const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
            const [pendingPaymentId, setPendingPaymentId] = useState(null);
            const [paymentModalStep, setPaymentModalStep] = useState('select'); // 'select' or 'mixed'
            const [mixedAmounts, setMixedAmounts] = useState({ cash: 0, transfer: 0 });

            // Delivery Modal Logic
            const [isDeliveryModalOpen, setIsDeliveryModalOpen] = useState(false);
            const [pendingDeliveryId, setPendingDeliveryId] = useState(null);
            const [deliveryDateInput, setDeliveryDateInput] = useState('');

            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
            const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });
            
            // Income Modal
            const [isIncomeModalOpen, setIsIncomeModalOpen] = useState(false);
            const [incomeForm, setIncomeForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });

            // Inventory (Price List)
            const [isInventoryModalOpen, setIsInventoryModalOpen] = useState(false);
            const [editingProductId, setEditingProductId] = useState(null);
            const [inventoryForm, setInventoryForm] = useState({ name: '', detail: '', price: '', stock: '' });
            const [searchProduct, setSearchProduct] = useState('');
            
            // Debts
            const [isDebtModalOpen, setIsDebtModalOpen] = useState(false);
            const [isDebtStatsOpen, setIsDebtStatsOpen] = useState(false);
            const [debtForm, setDebtForm] = useState({ detail: '', type: 'unique', installments: '', amount: '' });
            const [editingDebtId, setEditingDebtId] = useState(null);

            // Movement Edit Modal
            const [isEditMovementModalOpen, setIsEditMovementModalOpen] = useState(false);
            const [editingMovement, setEditingMovement] = useState(null);
            const [editMovementForm, setEditMovementForm] = useState({ 
                date: '', 
                amount: '', 
                method: 'cash', 
                mixedCash: '', 
                mixedTransfer: '' 
            });

            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDanger: false });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                const savedAuth = localStorage.getItem('mate_auth_token');
                if (savedAuth === `valid_${credentials.pass}`) {
                    setIsLocked(false);
                }
            }, [credentials.pass]);

            const handleAppUnlock = () => {
                localStorage.setItem('mate_auth_token', `valid_${credentials.pass}`);
                setIsLocked(false);
                addToast('¬°Bienvenido de nuevo!');
            };

            const handleLogout = () => {
                localStorage.removeItem('mate_auth_token');
                setIsLocked(true);
            };

            const openSettings = () => {
                setSettingsTab('location');
                setTempCredentials({ ...credentials });
                setDiagMessage(null);
                setIsSettingsOpen(true);
            };

            const runDiagnostic = async () => {
                setDiagMessage({ type: 'loading', text: 'Probando conexi√≥n...' });
                try {
                    if (!user) throw new Error("No hay usuario autenticado.");
                    const testRef = collection(db, 'artifacts', appId, 'public', 'data', 'diagnostic');
                    await addDoc(testRef, { timestamp: new Date(), test: true });
                    setDiagMessage({ type: 'success', text: '¬°Conexi√≥n exitosa! Base de datos sincronizada.' });
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'permission-denied') msg = "Permisos denegados. Revisa las reglas en Firebase Console.";
                    if (err.code === 'unavailable') msg = "Sin conexi√≥n a internet o Firebase ca√≠do.";
                    setDiagMessage({ type: 'error', text: `Error: ${msg}` });
                }
            };

            const handleUpdateCredentials = (e) => {
                e.preventDefault();
                if (!tempCredentials.user || !tempCredentials.pass) {
                    addToast('Completa todos los campos', 'error');
                    return;
                }
                setCredentials(tempCredentials);
                localStorage.setItem('mate_credentials', JSON.stringify(tempCredentials));
                if (!isLocked) {
                    localStorage.setItem('mate_auth_token', `valid_${tempCredentials.pass}`);
                }
                addToast('Credenciales actualizadas', 'success');
                setIsSettingsOpen(false);
            };

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            // MODIFIED FOR MULTI-ITEM SUPPORT
            const openModal = (order = null) => {
                setEditingId(order ? order.id : null);
                const defaultDate = order ? order.date.split('T')[0] : new Date().toISOString().split('T')[0];
                
                if (order) {
                    // Normalize old orders to have an 'items' array if they don't
                    let items = order.items || [];
                    if (items.length === 0 && order.detail) {
                        items = [{
                            id: Date.now(), // temp id for UI list
                            productId: order.productId || null,
                            detail: order.detail,
                            quantity: parseInt(order.quantity) || 1,
                            unitPrice: order.price / (parseInt(order.quantity) || 1), // Estimate unit price
                            total: order.price,
                            name: order.detail // Backwards compat name
                        }];
                    }
                    setForm({ ...order, date: defaultDate, items: items });
                } else {
                    setForm({ 
                        client: '', items: [], price: 0, paid: false, paymentMethod: null, 
                        delivered: false, important: false, date: defaultDate
                    });
                }
                setSubItem({ productId: '', quantity: 1, unitPrice: 0, detail: '' }); // Reset sub-form
                setIsCustomItem(false); // Reset to default mode
                setIsModalOpen(true);
            };
            const closeModal = () => setIsModalOpen(false);

            useEffect(() => {
                if (!isConfigured) return; 
                const initAuth = async () => {
                    try { 
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth error:", e);
                        setConnectionStatus('disconnected');
                        setAuthErrorDetails(e.message);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { 
                    setUser(u); 
                    setIsAuthLoading(false);
                    if (u) setConnectionStatus('connected');
                    else setConnectionStatus('disconnected');
                });
                return () => unsubscribe();
            }, []);

            // === CORE DATA SYNC ===
            useEffect(() => {
                if (!user || !isConfigured) return;
                
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                onSnapshot(settingsRef, (s) => { 
                    if (s.exists() && s.data().location) {
                        setLocationConfig(s.data().location); 
                    } else {
                        setLocationConfig(DEFAULT_LOCATION);
                    }
                });
                
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                const unsubOrders = onSnapshot(query(ordersRef), (s) => {
                    // Ordenar por fecha descendente
                    const loaded = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                    setOrders(loaded);
                    if (isFirstLoad.current && loaded.length > 0) { setCurrentDate(new Date(loaded[0].date)); isFirstLoad.current = false; }
                });
                
                const expensesRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                const unsubExpenses = onSnapshot(query(expensesRef), (s) => {
                    setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                });

                const inventoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
                const unsubInventory = onSnapshot(query(inventoryRef), (s) => {
                    setInventory(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                });

                const debtsRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');
                const unsubDebts = onSnapshot(query(debtsRef), (s) => {
                    setDebts(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                });
                
                const incomesRef = collection(db, 'artifacts', appId, 'public', 'data', 'extra_incomes');
                const unsubIncomes = onSnapshot(query(incomesRef), (s) => {
                    setIncomes(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                });

                return () => { unsubOrders(); unsubExpenses(); unsubIncomes(); unsubInventory(); unsubDebts(); };
            }, [user]);

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };

            const monthLabel = new Intl.DateTimeFormat('es-AR', { month: 'long', year: 'numeric' }).format(currentDate);
            const capitalizedMonthLabel = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            const filteredOrders = useMemo(() => orders.filter(o => {
                const d = new Date(o.date);
                const matchesDate = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                const matchesSearch = (o.client + o.detail).toLowerCase().includes(searchTerm.toLowerCase());
                
                let matchesFilter = true;
                if (orderFilter === 'pending_pay') matchesFilter = !o.paid;
                if (orderFilter === 'pending_delivery') matchesFilter = !o.delivered;
                if (orderFilter === 'delivered') matchesFilter = o.delivered;
                if (orderFilter === 'important') matchesFilter = o.important;

                return matchesDate && matchesSearch && matchesFilter;
            }).sort((a, b) => {
                if (orderFilter === 'delivered') {
                    const dateA = a.deliveryDate ? new Date(a.deliveryDate) : new Date(a.date);
                    const dateB = b.deliveryDate ? new Date(b.deliveryDate) : new Date(b.date);
                    return dateB - dateA;
                }
                return new Date(b.date) - new Date(a.date);
            }), [orders, currentDate, searchTerm, orderFilter]);

            const filteredInventory = useMemo(() => {
                return inventory.filter(item => 
                    item.name.toLowerCase().includes(searchProduct.toLowerCase()) || 
                    (item.detail && item.detail.toLowerCase().includes(searchProduct.toLowerCase()))
                );
            }, [inventory, searchProduct]);

            const filteredDebts = useMemo(() => {
                 return debts.filter(d => {
                     const date = new Date(d.date);
                     return date.getMonth() === currentDate.getMonth() && date.getFullYear() === currentDate.getFullYear();
                 });
            }, [debts, currentDate]);

            const debtsStats = useMemo(() => {
                const year = currentDate.getFullYear();
                const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const data = months.map((m, i) => {
                     const monthlyDebts = debts.filter(d => {
                         const date = new Date(d.date);
                         return date.getMonth() === i && date.getFullYear() === year;
                     });
                     const total = monthlyDebts.reduce((acc, d) => acc + (d.amount || 0), 0);
                     return { label: m, value: total };
                });
                return data;
            }, [debts, currentDate]);

            const finances = useMemo(() => {
                const monthOrders = orders.filter(o => {
                    const d = new Date(o.paymentDate || o.date);
                    return o.paid && d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });
                
                const monthExpenses = expenses.filter(e => {
                    const d = new Date(e.date);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });
                const monthIncomes = incomes.filter(i => {
                    const d = new Date(i.date);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });

                const incomeMonth = monthOrders.reduce((acc, o) => acc + o.price, 0) + monthIncomes.reduce((acc, i) => acc + i.amount, 0);
                const expenseMonth = monthExpenses.reduce((acc, e) => acc + e.amount, 0);
                const netProfitMonth = incomeMonth - expenseMonth;

                const movements = [
                    ...monthOrders.map(o => {
                        let description = `Pedido: ${o.client} - ${o.detail}`;
                        if (o.paymentMethod === 'mixed' && o.paymentDetails) {
                            description += ` (E: $${(o.paymentDetails.cash || 0).toLocaleString()} / T: $${(o.paymentDetails.transfer || 0).toLocaleString()})`;
                        }
                        return { 
                            ...o, 
                            type: 'income', 
                            source: 'order',
                            description, 
                            amount: o.price, 
                            method: o.paymentMethod || 'cash',
                            date: o.paymentDate || o.date 
                        };
                    }),
                    ...monthIncomes.map(i => ({ ...i, type: 'income', source: 'income', description: `Ingreso: ${i.description}`, amount: i.amount, method: i.method || 'cash' })),
                    ...monthExpenses.map(e => ({ ...e, type: 'expense', source: 'expense', method: e.method || 'cash' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const allPaid = orders.filter(o => o.paid);
                
                const totalCashOrders = allPaid.reduce((sum, o) => {
                    if (o.paymentMethod === 'cash') return sum + o.price;
                    if (o.paymentMethod === 'mixed' && o.paymentDetails) return sum + (o.paymentDetails.cash || 0);
                    return sum;
                }, 0);

                const totalTransferOrders = allPaid.reduce((sum, o) => {
                    if (o.paymentMethod === 'transfer') return sum + o.price;
                    if (o.paymentMethod === 'mixed' && o.paymentDetails) return sum + (o.paymentDetails.transfer || 0);
                    return sum;
                }, 0);
                
                const totalCashExpenses = expenses.filter(e => e.method === 'cash').reduce((s,e) => s + e.amount, 0);
                const totalTransferExpenses = expenses.filter(e => e.method === 'transfer').reduce((s,e) => s + e.amount, 0);
                
                const totalCashIncomes = incomes.filter(i => i.method === 'cash').reduce((s,i) => s + i.amount, 0);
                const totalTransferIncomes = incomes.filter(i => i.method === 'transfer').reduce((s,i) => s + i.amount, 0);

                const totalCash = (totalCashOrders + totalCashIncomes) - totalCashExpenses;
                const totalTransfer = (totalTransferOrders + totalTransferIncomes) - totalTransferExpenses;
                
                return { movements, incomeMonth, expenseMonth, netProfitMonth, totalCash, totalTransfer, totalBalance: totalCash + totalTransfer };
            }, [orders, expenses, incomes, currentDate]);

            const statsAnalytics = useMemo(() => {
                const isMonth = statScope === 'month';
                const dataset = orders.filter(o => {
                    const d = new Date(o.paymentDate || o.date);
                    if (!o.paid) return false;
                    if (isMonth) return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                    else return d.getFullYear() === currentDate.getFullYear();
                });
                const prevDataset = orders.filter(o => {
                    const d = new Date(o.paymentDate || o.date);
                    if (!o.paid) return false;
                    if (isMonth) {
                        const prevDate = new Date(currentDate);
                        prevDate.setMonth(prevDate.getMonth() - 1);
                        return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
                    } else {
                        return d.getFullYear() === currentDate.getFullYear() - 1;
                    }
                });
                const totalRevenue = dataset.reduce((acc, o) => acc + o.price, 0);
                const prevRevenue = prevDataset.reduce((acc, o) => acc + o.price, 0);
                const growth = prevRevenue === 0 ? (totalRevenue > 0 ? 100 : 0) : Math.round(((totalRevenue - prevRevenue) / prevRevenue) * 100);
                const chartData = [];
                if (isMonth) {
                    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                    for(let i=1; i<=daysInMonth; i++) {
                        const val = dataset.filter(o => new Date(o.paymentDate || o.date).getDate() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: `${i}`, value: val });
                    }
                } else {
                    const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                    months.forEach((m, i) => {
                        const val = dataset.filter(o => new Date(o.paymentDate || o.date).getMonth() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: m, value: val });
                    });
                }
                const counts = {}; const revenues = {};
                const stopWords = ['mate','el','la','con','de','un','premium','calidad','detalle'];
                dataset.forEach(o => {
                    const words = o.detail.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(w => w.length > 3 && !stopWords.includes(w));
                    let main = words.length > 0 ? words[0] : "varios";
                    if (main.endsWith('s')) main = main.slice(0, -1);
                    main = main.charAt(0).toUpperCase() + main.slice(1);
                    counts[main] = (counts[main] || 0) + 1;
                    revenues[main] = (revenues[main] || 0) + o.price;
                });
                const products = Object.keys(counts).map(k => ({ name: k, count: counts[k], revenue: revenues[k] })).sort((a,b) => b.revenue - a.revenue);
                let insight = "";
                if (growth > 0) insight = `¬°Excelente! Has crecido un ${growth}% respecto al periodo anterior.`;
                else if (growth < 0) insight = `Ingresos un ${Math.abs(growth)}% menores al periodo anterior. ¬°A repuntar!`;
                else insight = "Mantienes el mismo nivel de ventas que el periodo anterior.";
                if (products.length > 0) insight += ` El producto estrella es "${products[0].name}".`;
                
                const totalOrders = dataset.length;
                const avgTicket = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;
                
                const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const dayCounts = new Array(7).fill(0);
                dataset.forEach(o => {
                    dayCounts[new Date(o.paymentDate || o.date).getDay()]++;
                });
                const bestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
                const bestDay = totalOrders > 0 ? days[bestDayIndex] : '-';

                const cashTotal = dataset.reduce((sum, o) => {
                    if (o.paymentMethod === 'cash') return sum + o.price;
                    if (o.paymentMethod === 'mixed' && o.paymentDetails) return sum + (o.paymentDetails.cash || 0);
                    return sum;
                }, 0);

                const transferTotal = dataset.reduce((sum, o) => {
                    if (o.paymentMethod === 'transfer') return sum + o.price;
                    if (o.paymentMethod === 'mixed' && o.paymentDetails) return sum + (o.paymentDetails.transfer || 0);
                    return sum;
                }, 0);
                
                const paymentStats = { cash: cashTotal, transfer: transferTotal };

                return { totalRevenue, growth, chartData, products, insight, avgTicket, bestDay, paymentStats };
            }, [orders, currentDate, statScope]);

            const inventoryStats = useMemo(() => {
                const totalItems = inventory.reduce((acc, item) => acc + (parseInt(item.stock) || 0), 0);
                const totalValue = inventory.reduce((acc, item) => acc + ((item.price || 0) * (parseInt(item.stock) || 0)), 0);
                return { totalItems, totalValue };
            }, [inventory]);

            const ordersAnalytics = useMemo(() => {
                const dataset = filteredOrders;
                const total = dataset.reduce((acc, o) => acc + (o.paid ? o.price : 0), 0);
                const pendingPay = dataset.reduce((acc, o) => acc + (!o.paid ? o.price : 0), 0);
                const pendingDel = dataset.filter(o => !o.delivered).length;
                return { total, pendingPay, pendingDel };
            }, [filteredOrders]);

            const handleSaveLocation = async (e) => {
                e.preventDefault(); 
                if (!settingsCity.trim()) {
                    addToast('Escribe una ciudad', 'error');
                    return; 
                }
                
                setIsSearchingCity(true);
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(settingsCity)}&count=1&language=es&format=json`);
                    const data = await res.json();
                    
                    if (data.results?.length > 0) {
                        const place = data.results[0];
                        const newConfig = { name: place.name, lat: place.latitude, lon: place.longitude, country: place.country };
                        
                        setLocationConfig(newConfig);
                        
                        if (user) {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), { location: newConfig }, { merge: true });
                        }
                        
                        setIsSettingsOpen(false);
                        setSettingsCity('');
                        addToast(`Ubicaci√≥n actualizada: ${place.name}`, 'success');
                    } else {
                        addToast("No se encontr√≥ la ciudad.", 'error');
                    }
                } catch (error) { 
                    console.error("Error fetching location:", error);
                    addToast("Error al buscar.", 'error'); 
                } finally { 
                    setIsSearchingCity(false); 
                }
            };

            // ITEM LOGIC
            const handleSelectProduct = (e) => {
                const prodId = e.target.value;
                if (!prodId) {
                    setSubItem(prev => ({ ...prev, productId: '' }));
                    return;
                }
                const product = inventory.find(p => p.id === prodId);
                if (product) {
                    setSubItem(prev => ({
                        ...prev,
                        productId: product.id,
                        unitPrice: product.price,
                        detail: product.name // Temp store name for display
                    }));
                }
            };

            const handleAddItem = () => {
                let newItem;
                const qty = parseInt(subItem.quantity) || 1;

                if (isCustomItem) {
                    // L√≥gica para √≠tem manual
                    if (!subItem.detail || !subItem.detail.trim() || !subItem.unitPrice || parseFloat(subItem.unitPrice) <= 0) {
                        addToast('Completa nombre y precio v√°lido', 'error');
                        return;
                    }
                    newItem = {
                        id: Date.now(),
                        productId: null, // Sin ID de inventario
                        name: subItem.detail,
                        detail: 'Personalizado',
                        quantity: qty,
                        unitPrice: parseFloat(subItem.unitPrice),
                        total: parseFloat(subItem.unitPrice) * qty
                    };
                } else {
                    // L√≥gica existente para stock
                    if (!subItem.productId) return;
                    const product = inventory.find(p => p.id === subItem.productId);
                    if (!product) return;
                    newItem = {
                        id: Date.now(),
                        productId: product.id,
                        name: product.name,
                        detail: product.detail || '',
                        quantity: qty,
                        unitPrice: product.price,
                        total: product.price * qty
                    };
                }

                const updatedItems = [...form.items, newItem];
                const updatedTotal = updatedItems.reduce((acc, item) => acc + item.total, 0);

                // Auto generate detail summary
                const summary = updatedItems.map(i => `${i.quantity}x ${i.name}`).join(', ');

                setForm(prev => ({
                    ...prev,
                    items: updatedItems,
                    price: updatedTotal,
                    detail: summary
                }));
                
                // Reset selection
                setSubItem({ productId: '', quantity: 1, unitPrice: 0, detail: '' });
                // No reseteamos isCustomItem para que pueda seguir agregando del mismo tipo si quiere
            };

            const handleRemoveItem = (itemId) => {
                const updatedItems = form.items.filter(i => i.id !== itemId);
                const updatedTotal = updatedItems.reduce((acc, item) => acc + item.total, 0);
                const summary = updatedItems.map(i => `${i.quantity}x ${i.name}`).join(', ');
                
                setForm(prev => ({
                    ...prev,
                    items: updatedItems,
                    price: updatedTotal,
                    detail: summary
                }));
            };

            const handleSaveOrder = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;

                if (!form.client.trim()) { addToast('Falta el nombre del cliente', 'error'); return; }
                if (form.items.length === 0) { addToast('Agrega al menos un producto', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }

                setIsSaving(true);
                
                let selectedDate;
                const now = new Date();
                const parts = form.date.split('-');
                
                const isToday = parseInt(parts[0]) === now.getFullYear() && 
                                (parseInt(parts[1]) - 1) === now.getMonth() && 
                                parseInt(parts[2]) === now.getDate();

                if (isToday && !editingId) {
                    selectedDate = now;
                } else {
                    selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                }

                // Determine dominant category and icons based on first item or fallback to generic
                const firstItemName = form.items[0]?.name || form.detail;
                
                const orderData = {
                    client: form.client, 
                    detail: form.detail, // Summary string
                    items: form.items,   // New structure
                    price: parseFloat(form.price) || 0,
                    quantity: form.items.length, // Item count logic change
                    paid: form.paid, paymentMethod: form.paid ? (form.paymentMethod || 'cash') : null,
                    paymentDate: form.paid ? (form.paymentDate || selectedDate.toISOString()) : null,
                    delivered: form.delivered, important: form.important,
                    deliveryDate: form.delivered ? (form.deliveryDate || selectedDate.toISOString()) : null,
                    date: selectedDate.toISOString(),
                    aiColor: generateColorFromText(firstItemName), 
                    aiIcon: getSmartIconName(firstItemName), 
                    category: identifyCategory(firstItemName),
                    productId: null // Deprecated top level
                };
                
                const batch = writeBatch(db);
                const ordersRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
                
                try {
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingId), orderData);
                        addToast('Pedido actualizado', 'success');
                    } else { 
                        batch.set(ordersRef, orderData);

                        // Deduct stock for ALL items THAT HAVE A PRODUCT ID
                        for (const item of form.items) {
                            if (item.productId) {
                                const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', item.productId);
                                const productDoc = await getDoc(productRef);
                                if (productDoc.exists()) {
                                    const currentStock = parseInt(productDoc.data().stock) || 0;
                                    batch.update(productRef, { stock: Math.max(0, currentStock - item.quantity) });
                                }
                            }
                        }

                        await batch.commit();
                        setCurrentDate(selectedDate);
                        addToast('Pedido guardado y stock actualizado', 'success');
                    }
                    closeModal();
                } catch (err) { 
                    console.error(err); 
                    addToast(`Error: ${err.message}`, 'error'); 
                } finally {
                    setIsSaving(false);
                }
            };

            const handleSaveExpense = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;
                
                if (!expenseForm.description.trim()) { addToast('Falta la descripci√≥n', 'error'); return; }
                if (!expenseForm.amount || parseFloat(expenseForm.amount) <= 0) { addToast('Falta el monto', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }
                
                setIsSaving(true);

                const parts = expenseForm.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                try {
                    await addDoc(colRef, { description: expenseForm.description, amount: parseFloat(expenseForm.amount) || 0, method: expenseForm.method, date: selectedDate.toISOString(), type: 'expense' });
                    setIsExpenseModalOpen(false); setExpenseForm({ description: '', amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
                    addToast('Gasto registrado', 'success');
                } catch(e) {
                     addToast(`Error: ${e.message}`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleSaveIncome = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;
                
                if (!incomeForm.description.trim()) { addToast('Falta la descripci√≥n', 'error'); return; }
                if (!incomeForm.amount || parseFloat(incomeForm.amount) <= 0) { addToast('Falta el monto', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }
                
                setIsSaving(true);

                const parts = incomeForm.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'extra_incomes');
                try {
                    await addDoc(colRef, { description: incomeForm.description, amount: parseFloat(incomeForm.amount) || 0, method: incomeForm.method, date: selectedDate.toISOString(), type: 'income' });
                    setIsIncomeModalOpen(false); setIncomeForm({ description: '', amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
                    addToast('Ingreso registrado', 'success');
                } catch(e) {
                     addToast(`Error al guardar ingreso`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            // --- MOVEMENT EDITING LOGIC ---
            const openEditMovement = (mov) => {
                setEditingMovement(mov);
                
                // Form Initialization
                const d = new Date(mov.date);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                const dateStr = d.toISOString().split('T')[0];

                let initialCash = '';
                let initialTransf = '';
                
                if (mov.method === 'mixed' && mov.paymentDetails) {
                    initialCash = mov.paymentDetails.cash;
                    initialTransf = mov.paymentDetails.transfer;
                } else if (mov.source === 'order' && mov.method === 'mixed') {
                     initialCash = 0;
                     initialTransf = mov.amount;
                }

                setEditMovementForm({
                    date: dateStr,
                    amount: mov.amount,
                    method: mov.method,
                    mixedCash: initialCash,
                    mixedTransfer: initialTransf
                });
                setIsEditMovementModalOpen(true);
            };

            const handleSaveMovement = async (e) => {
                e.preventDefault();
                if (!user || !editingMovement) return;

                setIsSaving(true);
                try {
                    const parts = editMovementForm.date.split('-');
                    const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0).toISOString();

                    if (editingMovement.source === 'order') {
                        const updateData = {
                            paymentDate: selectedDate,
                            paymentMethod: editMovementForm.method
                        };

                        if (editMovementForm.method === 'mixed') {
                             const cash = parseFloat(editMovementForm.mixedCash) || 0;
                             const transf = parseFloat(editMovementForm.mixedTransfer) || 0;
                             if (Math.abs((cash + transf) - editingMovement.amount) > 1) {
                                 addToast(`La suma debe dar $${editingMovement.amount.toLocaleString()}`, 'error');
                                 setIsSaving(false);
                                 return;
                             }
                             updateData.paymentDetails = { cash, transfer: transf };
                        } else {
                            updateData.paymentDetails = null;
                        }

                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingMovement.id), updateData);

                    } else {
                         const colName = editingMovement.source === 'expense' ? 'expenses' : 'extra_incomes';
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, editingMovement.id), {
                             date: selectedDate,
                             amount: parseFloat(editMovementForm.amount) || 0,
                             method: editMovementForm.method
                         });
                    }
                    addToast('Movimiento actualizado', 'success');
                    setIsEditMovementModalOpen(false);
                } catch(err) {
                    addToast(`Error: ${err.message}`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteMovement = (mov) => {
                const isOrder = mov.source === 'order';
                setConfirmModal({
                    isOpen: true,
                    title: isOrder ? 'Anular Pago' : 'Eliminar Movimiento',
                    message: isOrder 
                        ? 'El pedido volver√° a estar "Pendiente de Pago". No se elimina el pedido.' 
                        : 'Se eliminar√° permanentemente este registro.',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            if (isOrder) {
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', mov.id), {
                                    paid: false,
                                    paymentDate: null,
                                    paymentMethod: null,
                                    paymentDetails: null
                                });
                                addToast('Pago anulado. Pedido pendiente.', 'success');
                            } else {
                                const colName = mov.source === 'expense' ? 'expenses' : 'extra_incomes';
                                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, mov.id));
                                addToast('Movimiento eliminado', 'success');
                            }
                        } catch(e) {
                            addToast('Error al eliminar', 'error');
                            console.error(e);
                        }
                    }
                });
            };

            const handleMixedAmountChange = (type, value) => {
                const rawValue = value; 
                const numericVal = rawValue === '' ? 0 : parseFloat(rawValue);
                const total = editingMovement ? editingMovement.amount : 0;

                if (type === 'cash') {
                    setEditMovementForm(prev => ({ 
                        ...prev,
                        mixedCash: rawValue, 
                        mixedTransfer: Math.max(0, total - numericVal) 
                    }));
                } else {
                    setEditMovementForm(prev => ({ 
                        ...prev,
                        mixedCash: Math.max(0, total - numericVal), 
                        mixedTransfer: rawValue 
                    }));
                }
            };

            const handleNewPaymentMixedChange = (type, value) => {
                 const rawValue = value; 
                 const numericVal = rawValue === '' ? 0 : parseFloat(rawValue);
                 const order = orders.find(o => o.id === pendingPaymentId);
                 const total = order ? order.price : 0;

                 if (type === 'cash') {
                    setMixedAmounts({ cash: rawValue, transfer: Math.max(0, total - numericVal) });
                 } else {
                    setMixedAmounts({ cash: Math.max(0, total - numericVal), transfer: rawValue });
                 }
            };

            const openInventoryModal = (product = null) => {
                if (product) {
                    setEditingProductId(product.id);
                    setInventoryForm({
                        name: product.name,
                        detail: product.detail || '',
                        price: product.price,
                        stock: product.stock !== undefined ? product.stock : ''
                    });
                } else {
                    setEditingProductId(null);
                    setInventoryForm({ name: '', detail: '', price: '', stock: '' });
                }
                setIsInventoryModalOpen(true);
            };

            const handleSaveInventory = async (e) => {
                e.preventDefault();
                if (isSaving) return;
                if (!inventoryForm.name.trim()) { addToast('Falta el nombre', 'error'); return; }
                if (!inventoryForm.price || parseFloat(inventoryForm.price) <= 0) { addToast('Falta el precio', 'error'); return; }

                setIsSaving(true);
                const itemData = {
                    name: inventoryForm.name,
                    detail: inventoryForm.detail,
                    price: parseFloat(inventoryForm.price) || 0,
                    stock: parseInt(inventoryForm.stock) || 0
                };
                
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
                
                try {
                    if (editingProductId) {
                         await updateDoc(doc(colRef, editingProductId), itemData);
                         addToast('Producto actualizado', 'success');
                    } else {
                         await addDoc(colRef, itemData);
                         addToast('Producto agregado', 'success');
                    }
                    setIsInventoryModalOpen(false);
                } catch(e) {
                    addToast('Error al guardar', 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteInventoryItem = (id) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Producto',
                    message: '¬øEst√°s seguro? Se borrar√° de la lista.',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id));
                            addToast('Producto eliminado', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };
            
            const printPriceList = () => {
                if (!window.jspdf) {
                    addToast("Error: Librer√≠a PDF no cargada", "error");
                    return;
                }
                const doc = new window.jspdf.jsPDF();
                doc.setFontSize(22);
                doc.setTextColor(40);
                doc.text("POR AMOR AL MATE", 14, 20);
                const currentMonthName = new Intl.DateTimeFormat('es-AR', { month: 'long' }).format(new Date());
                doc.setFontSize(14);
                doc.setTextColor(100);
                doc.text(`LISTA DE PRECIOS (${currentMonthName.toUpperCase()})`, 14, 30);
                const tableColumn = ["Producto", "Detalle", "Precio", "Stock"];
                const tableRows = [];
                inventory.forEach(item => {
                    const itemData = [item.name, item.detail || '-', `$${item.price.toLocaleString()}`, item.stock ? item.stock.toString() : '0'];
                    tableRows.push(itemData);
                });
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, theme: 'grid', headStyles: { fillColor: [20, 83, 45] }, styles: { font: 'helvetica', fontSize: 10 } });
                doc.save(`Lista_Precios_${currentMonthName}.pdf`);
                addToast("PDF Descargado", "success");
            };

            const openDebtModal = (debt = null) => {
                if (debt) {
                    setEditingDebtId(debt.id);
                    setDebtForm({ detail: debt.detail, type: 'unique', installments: '', amount: debt.amount });
                } else {
                    setEditingDebtId(null);
                    setDebtForm({ detail: '', type: 'unique', installments: '', amount: '' });
                }
                setIsDebtModalOpen(true);
            };

            const handleSaveDebt = async (e) => {
                e.preventDefault();
                if (isSaving) return;
                if (!debtForm.detail.trim()) { addToast('Falta el detalle', 'error'); return; }
                if (!debtForm.amount || parseFloat(debtForm.amount) <= 0) { addToast('Falta el monto de la cuota', 'error'); return; }
                setIsSaving(true);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');
                const batch = writeBatch(db);
                try {
                    if (editingDebtId) {
                        await updateDoc(doc(colRef, editingDebtId), { detail: debtForm.detail, amount: parseFloat(debtForm.amount) });
                        addToast('Deuda actualizada', 'success');
                    } else {
                        const amount = parseFloat(debtForm.amount);
                        const baseDate = new Date(currentDate); 
                        baseDate.setDate(1);
                        if (debtForm.type === 'unique') {
                             const newRef = doc(colRef);
                             batch.set(newRef, { detail: debtForm.detail, amount, date: baseDate.toISOString(), paid: false });
                        } else if (debtForm.type === 'installments') {
                             const count = parseInt(debtForm.installments) || 2;
                             for (let i = 0; i < count; i++) {
                                 const d = new Date(baseDate);
                                 d.setMonth(d.getMonth() + i);
                                 const newRef = doc(colRef);
                                 batch.set(newRef, { detail: `${debtForm.detail} (${i+1}/${count})`, amount, date: d.toISOString(), paid: false });
                             }
                        } else if (debtForm.type === 'fixed') {
                             for (let i = 0; i < 12; i++) {
                                 const d = new Date(baseDate);
                                 d.setMonth(d.getMonth() + i);
                                 const newRef = doc(colRef);
                                 batch.set(newRef, { detail: debtForm.detail, amount, date: d.toISOString(), paid: false });
                             }
                        }
                        await batch.commit();
                        addToast('Deudas generadas correctamente', 'success');
                    }
                    setIsDebtModalOpen(false);
                } catch(e) { console.error(e); addToast('Error al guardar', 'error'); } finally { setIsSaving(false); }
            };

            const handleDeleteDebt = (id) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Deuda',
                    message: '¬øEst√°s seguro?',
                    isDanger: true,
                    onConfirm: async () => {
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', id)); addToast('Deuda eliminada', 'success'); } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            const toggleDebtPaid = async (debt) => {
                try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', debt.id), { paid: !debt.paid }); } catch(e) { console.error(e); }
            };

            const initiatePayment = (id) => { 
                const o = orders.find(x => x.id === id); 
                if(o.paid) { toggle(id,'paid'); } else { 
                    setPendingPaymentId(id); 
                    setPaymentModalStep('select');
                    setMixedAmounts({ cash: '', transfer: o.price });
                    setIsPaymentModalOpen(true); 
                }
            };

            const confirmPayment = async (method) => {
                if (!user || !pendingPaymentId) return;
                const updateData = { paid: true, paymentMethod: method, paymentDate: new Date().toISOString() };
                if (method === 'mixed') {
                    const order = orders.find(o => o.id === pendingPaymentId);
                    const total = order ? order.price : 0;
                    const cashVal = mixedAmounts.cash === '' ? 0 : parseFloat(mixedAmounts.cash);
                    const transferVal = mixedAmounts.transfer === '' ? 0 : parseFloat(mixedAmounts.transfer);
                    if (Math.abs((cashVal + transferVal) - total) > 1) { addToast(`La suma debe dar $${total}`, 'error'); return; }
                    updateData.paymentDetails = { cash: cashVal, transfer: transferVal };
                } else { updateData.paymentDetails = null; }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingPaymentId), updateData);
                setIsPaymentModalOpen(false); setPendingPaymentId(null); addToast('Pago registrado');
            };

            const handleDeliveryConfirm = async () => {
                if (!user || !pendingDeliveryId) return;
                const finalDate = deliveryDateInput ? new Date(deliveryDateInput).toISOString() : new Date().toISOString();
                try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingDeliveryId), { delivered: true, deliveryDate: finalDate }); addToast('Entrega registrada'); setIsDeliveryModalOpen(false); setPendingDeliveryId(null); } catch(e) { addToast('Error al registrar entrega', 'error'); }
            };

            const toggle = async (id, field) => {
                const order = orders.find(o => o.id === id);
                if (!order) return;
                const updates = {};
                if (field === 'paid') {
                    if (!order.paid) { updates.paid = true; updates.paymentDate = new Date().toISOString(); } 
                    else { updates.paid = false; updates.paymentDate = null; }
                } else if (field === 'delivered') {
                    if (!order.delivered) { setPendingDeliveryId(id); const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); setDeliveryDateInput(now.toISOString().slice(0, 16)); setIsDeliveryModalOpen(true); return; } 
                    else { updates.delivered = false; updates.deliveryDate = null; }
                } else { updates[field] = !order[field]; }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), updates);
            };
            
            const removeOrder = (id) => { 
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Pedido',
                    message: '¬øEst√°s seguro de eliminar este pedido? Esta acci√≥n no se puede deshacer.',
                    isDanger: true,
                    onConfirm: async () => {
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id)); addToast('Pedido eliminado', 'success'); } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            if (!isConfigured) return <ConfigErrorScreen />;
            if (isLocked) return <LoginScreen onLogin={handleAppUnlock} credentials={credentials} />;
            if (isAuthLoading) return <div className="h-full w-full flex flex-col items-center justify-center bg-[#FAFAF9] text-stone-500 gap-4"><Loader2 size={40} className="animate-spin text-[#5D8C57]" /><p className="font-medium animate-pulse">Cargando datos...</p></div>;

            return (
                <div className="h-full w-full bg-[#FAFAF9] font-sans text-stone-800 flex flex-col md:flex-row overflow-hidden">
                    {toasts.map(toast => (
                        <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
                    ))}
                    
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        onClose={() => setConfirmModal({...confirmModal, isOpen: false})} 
                        title={confirmModal.title}
                        message={confirmModal.message}
                        onConfirm={confirmModal.onConfirm}
                        isDanger={confirmModal.isDanger}
                    />

                    {/* --- MOVEMENT EDIT MODAL --- */}
                    <Modal isOpen={isEditMovementModalOpen} onClose={() => setIsEditMovementModalOpen(false)} title="Editar Movimiento">
                        <form onSubmit={handleSaveMovement} className="space-y-4">
                            {/* Date Field - Always Editable */}
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-stone-400 uppercase">Fecha</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl"
                                    value={editMovementForm.date}
                                    onChange={e => setEditMovementForm({...editMovementForm, date: e.target.value})}
                                />
                            </div>

                            {/* Logic Split based on Type */}
                            {editingMovement?.source === 'order' ? (
                                <>
                                    <div className="p-3 bg-stone-100 rounded-xl mb-2">
                                        <p className="text-xs font-bold text-stone-400 uppercase mb-1">Monto del Pedido (Fijo)</p>
                                        <p className="text-lg font-bold text-stone-800">${editingMovement.amount.toLocaleString()}</p>
                                    </div>

                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-stone-400 uppercase">Forma de Pago</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <button type="button" onClick={() => setEditMovementForm({...editMovementForm, method: 'cash'})} className={`py-2 text-xs rounded-lg border ${editMovementForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Efectivo</button>
                                            <button type="button" onClick={() => setEditMovementForm({...editMovementForm, method: 'transfer'})} className={`py-2 text-xs rounded-lg border ${editMovementForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Transf.</button>
                                            <button type="button" onClick={() => setEditMovementForm({...editMovementForm, method: 'mixed'})} className={`py-2 text-xs rounded-lg border ${editMovementForm.method === 'mixed' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Mixto</button>
                                        </div>
                                    </div>

                                    {editMovementForm.method === 'mixed' && (
                                        <div className="space-y-3 bg-stone-50 p-3 rounded-xl border border-stone-100 animate-in fade-in">
                                            <div>
                                                <label className="text-[10px] font-bold text-green-600 uppercase">Monto Efectivo</label>
                                                <input type="number" className="w-full p-2 bg-white border border-stone-200 rounded-lg text-sm font-bold" value={editMovementForm.mixedCash} onChange={e => handleMixedAmountChange('cash', e.target.value)} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-blue-600 uppercase">Monto Transferencia (Auto)</label>
                                                <input type="number" className="w-full p-2 bg-stone-100 border border-stone-200 rounded-lg text-sm font-bold text-stone-500" value={editMovementForm.mixedTransfer} readOnly />
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    {/* Editable Amount for Expenses/Incomes */}
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-stone-400 uppercase">Monto</label>
                                        <input 
                                            type="number" 
                                            className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono"
                                            value={editMovementForm.amount}
                                            onChange={e => setEditMovementForm({...editMovementForm, amount: e.target.value})}
                                        />
                                    </div>
                                    <div className="space-y-1">
                                         <label className="text-xs font-bold text-stone-400 uppercase">M√©todo</label>
                                         <div className="grid grid-cols-2 gap-2">
                                            <button type="button" onClick={() => setEditMovementForm({...editMovementForm, method: 'cash'})} className={`py-2 text-xs rounded-lg border ${editMovementForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Efectivo</button>
                                            <button type="button" onClick={() => setEditMovementForm({...editMovementForm, method: 'transfer'})} className={`py-2 text-xs rounded-lg border ${editMovementForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500'}`}>Transf.</button>
                                        </div>
                                    </div>
                                </>
                            )}

                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-4">
                                {isSaving ? <Loader2 size={18} className="animate-spin" /> : 'Guardar Cambios'}
                            </button>
                        </form>
                    </Modal>

                    <aside className="hidden md:flex flex-col w-64 bg-stone-900 border-r border-stone-800 h-full flex-shrink-0 sticky top-0">
                        <div className="p-8 pb-4 flex items-center gap-3">
                            <div className="bg-emerald-600 text-white p-2 rounded-xl"><MateIcon size={24} /></div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-white">Por Amor Al Mate</h1>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <div className={`w-2 h-2 rounded-full ${connectionStatus === 'connected' ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                                    <p className="text-xs text-stone-400" title={connectionStatus === 'disconnected' ? authErrorDetails : 'Conectado a Firebase'}>
                                        {connectionStatus === 'connected' ? 'En l√≠nea' : 'Desconectado'}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto sidebar-scrollbar">
                            <button onClick={() => setActiveTab('orders')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'orders' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Home size={20} /> Pedidos</button>
                            <button onClick={() => setActiveTab('inventory')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'inventory' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Tag size={20} /> Inventario</button>
                            <button onClick={() => setActiveTab('debts')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'debts' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Receipt size={20} /> Deudas</button>
                            <button onClick={() => setActiveTab('finances')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'finances' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Wallet size={20} /> Finanzas</button>
                            <button onClick={() => setActiveTab('stats')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'stats' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><BarChart3 size={20} /> Estad√≠sticas</button>
                        </nav>
                        <div className="p-4 border-t border-stone-800 flex flex-col gap-3">
                            <button onClick={() => openModal()} className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-emerald-900/20 active:scale-95 transition-all flex items-center justify-center gap-2 group relative overflow-hidden">
                                <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                                <Plus size={20} className="relative z-10" /> <span className="relative z-10">Nuevo Pedido</span>
                            </button>
                            
                            <div className="mt-auto pt-4 border-t border-stone-800/30 flex flex-col gap-1">
                                <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-xs font-bold text-stone-500 hover:text-white transition-colors py-3 rounded-xl hover:bg-white/5">
                                    <LogOut size={14} /> Cerrar Sesi√≥n
                                </button>
                                <button onClick={() => setIsContactModalOpen(true)} className="text-[10px] font-bold text-stone-600 hover:text-emerald-500 transition-colors tracking-widest uppercase py-2">
                                    Powered by JA
                                </button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 pb-24 md:pb-8 relative h-full overflow-y-auto custom-scrollbar">
                         {/* ... (Mobile Nav & Top Panel Logic kept same, only Main Content changes) ... */}
                         {/* DATE CONTROLS & HEADER */}
                         <div className="p-4 md:p-8 max-w-5xl mx-auto space-y-6 animate-in fade-in duration-500">
                             <DailyVibe onOpenSettings={openSettings} customLocation={locationConfig} />
                             <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-stone-100">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronLeft size={20} /></button>
                                <div className="flex items-center gap-2"><Calendar size={16} className="text-stone-400" /><span className="font-bold text-lg text-stone-800 capitalize">{capitalizedMonthLabel}</span></div>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronRight size={20} /></button>
                            </div>

                            {activeTab === 'orders' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">Ingresos (Mes)</p><p className="text-xl font-bold text-stone-900">${ordersAnalytics.total.toLocaleString()}</p></div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">Por Cobrar</p><p className="text-xl font-bold text-amber-600">${ordersAnalytics.pendingPay.toLocaleString()}</p></div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">En Local</p><p className="text-xl font-bold text-stone-800">{ordersAnalytics.pendingDel}</p></div>
                                    </div>
                                    <div className="relative"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder={`Buscar en ${monthLabel}...`} className="w-full pl-11 pr-4 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-stone-200 text-stone-700 placeholder:text-stone-400" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                    <div className="flex gap-2 pb-2 overflow-x-auto no-scrollbar">
                                        <button onClick={() => setOrderFilter('all')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'all' ? 'bg-stone-800 text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Todos</button>
                                        <button onClick={() => setOrderFilter('pending_pay')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'pending_pay' ? 'bg-amber-100 text-amber-700 border border-amber-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Por Cobrar</button>
                                        <button onClick={() => setOrderFilter('pending_delivery')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'pending_delivery' ? 'bg-blue-100 text-blue-700 border border-blue-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Por Entregar</button>
                                        <button onClick={() => setOrderFilter('delivered')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'delivered' ? 'bg-emerald-100 text-emerald-700 border border-emerald-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Entregados</button>
                                        <button onClick={() => setOrderFilter('important')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap flex items-center gap-1 ${orderFilter === 'important' ? 'bg-yellow-100 text-yellow-700 border border-yellow-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}><Star size={14} className={orderFilter === 'important' ? "fill-current" : ""} /> Favoritos</button> 
                                    </div>
                                    <div className="space-y-4">
                                        {filteredOrders.length === 0 ? <div className="flex flex-col items-center justify-center py-20 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200"><Package size={48} className="mb-4 opacity-20" /><p>No hay pedidos en esta selecci√≥n.</p></div> : 
                                            filteredOrders.map(order => (
                                                <div key={order.id} className={`group bg-white rounded-3xl p-5 border transition-all duration-300 hover:shadow-lg relative overflow-hidden ${order.important ? 'border-amber-200 ring-4 ring-amber-50' : 'border-stone-100 shadow-sm'}`}>
                                                    {order.important && <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-amber-100/50 to-transparent -mr-8 -mt-8 rounded-full pointer-events-none"></div>}
                                                    <div className="flex justify-between items-start mb-3 relative z-10">
                                                        <div className="flex items-center gap-3">
                                                             <div className="bg-stone-50 p-2.5 rounded-2xl text-stone-600"><SmartIcon iconName={order.aiIcon} color={order.aiColor} detail={order.detail} /></div>
                                                             <div>
                                                                <h3 className="font-bold text-stone-900 text-lg leading-tight">{order.client}</h3>
                                                                <span className="text-[11px] font-bold tracking-wide uppercase text-stone-400">{order.category} ‚Ä¢ {new Date(order.date).toLocaleDateString()}{order.deliveryDate && order.delivered && <span className="text-emerald-500 ml-1"> ‚Ä¢ Entregado: {new Date(order.deliveryDate).toLocaleString(undefined, {day:'numeric', month:'numeric', hour:'2-digit', minute:'2-digit'})}</span>}</span>
                                                             </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                             <button onClick={() => toggle(order.id, 'important')} className={`p-2 rounded-xl transition-all ${order.important ? 'text-amber-400 bg-amber-50' : 'text-stone-300 hover:bg-stone-100 hover:text-stone-500'}`}><Star size={18} fill={order.important ? "currentColor" : "none"} /></button>
                                                             <div className="h-8 w-px bg-stone-100 mx-1"></div>
                                                             <button onClick={() => openModal(order)} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-xl transition-colors"><Pencil size={18} /></button>
                                                        </div>
                                                    </div>
                                                    <p className="text-stone-600 text-sm mb-5 leading-relaxed pl-1">
                                                        {order.detail}
                                                        {order.items && order.items.length > 1 && <span className="text-xs text-stone-400 block mt-1 italic">({order.items.length} productos)</span>}
                                                    </p>
                                                    <div className="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-dashed border-stone-100">
                                                        <div className="flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-xl">
                                                             <span className="text-lg font-black text-stone-800">${order.price.toLocaleString()}</span>
                                                             {order.paymentMethod && (
                                                                <div className={`flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider ${order.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : (order.paymentMethod === 'transfer' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700')}`}>
                                                                    {order.paymentMethod === 'cash' && <Banknote size={12}/>}
                                                                    {order.paymentMethod === 'transfer' && <CreditCard size={12}/>}
                                                                    {order.paymentMethod === 'mixed' && <div className="flex gap-0.5"><Banknote size={12}/><CreditCard size={12}/></div>}
                                                                    <span>{order.paymentMethod === 'cash' ? 'Efectivo' : (order.paymentMethod === 'transfer' ? 'Transf' : 'Mixto')}</span>
                                                                </div>
                                                             )}
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => initiatePayment(order.id)} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${order.paid ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}>{order.paid ? <CheckCircle2 size={16} /> : <Circle size={16} />}{order.paid ? 'Pagado' : 'Cobrar'}</button>
                                                            <button onClick={() => toggle(order.id, 'delivered')} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${order.delivered ? 'bg-blue-100 text-blue-700 ring-1 ring-blue-200' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}><Package size={16} />{order.delivered ? 'Entregado' : 'Pendiente'}</button>
                                                            <button onClick={() => removeOrder(order.id)} className="p-2 text-stone-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors ml-1"><Trash2 size={18} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </>
                            )}

                            {activeTab === 'inventory' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="relative"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder="Buscar producto..." className="w-full pl-11 pr-4 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-stone-200 text-stone-700 placeholder:text-stone-400" value={searchProduct} onChange={e => setSearchProduct(e.target.value)} /></div>
                                    <div className="flex justify-between items-center"><h3 className="font-bold text-lg">Inventario & Stock</h3><div className="flex gap-2"><button onClick={printPriceList} className="bg-emerald-50 text-emerald-700 border border-emerald-200 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-emerald-100 transition-colors"><Printer size={16} /> Imprimir PDF</button><button onClick={() => openInventoryModal()} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar</button></div></div>
                                    <div className="space-y-3">
                                        {filteredInventory.map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between group hover:shadow-md transition-all">
                                                <div className="flex items-center gap-4"><div className={`p-2.5 rounded-xl ${parseInt(item.stock) > 0 ? 'bg-stone-50 text-stone-500' : 'bg-red-50 text-red-500'}`}><Tag size={20} /></div><div><h4 className="font-bold text-stone-800 text-lg leading-tight">{item.name}</h4><p className="text-sm text-stone-500 mt-1 flex items-center gap-2">{item.detail && <span>{item.detail}</span>}<span className="text-stone-300">|</span><span className={`font-bold ${parseInt(item.stock) > 0 ? 'text-emerald-600' : 'text-red-500'}`}>Stock: {item.stock || 0}</span></p></div></div>
                                                <div className="flex items-center gap-4"><span className="block text-xl font-bold text-stone-900">${item.price.toLocaleString()}</span><div className="flex gap-1"><button onClick={() => openInventoryModal(item)} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg transition-colors"><Pencil size={18} /></button><button onClick={() => handleDeleteInventoryItem(item.id)} className="p-2 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button></div></div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6 pt-6 border-t border-stone-200"><div className="p-4 rounded-2xl border border-stone-200 bg-stone-50/50"><p className="text-xs text-stone-400 font-bold uppercase mb-1">Total Unidades</p><p className="text-2xl font-bold text-stone-800">{inventoryStats.totalItems}</p></div><div className="p-4 rounded-2xl border border-stone-200 bg-stone-50/50"><p className="text-xs text-stone-400 font-bold uppercase mb-1">Valor Inventario (Stock x Precio)</p><p className="text-2xl font-bold text-stone-800">${inventoryStats.totalValue.toLocaleString()}</p></div></div>
                                </div>
                            )}
                            
                            {/* ... (Existing Debts, Finances, Stats tabs logic kept same) ... */}
                            {activeTab === 'debts' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="flex items-center justify-between"><div><h3 className="font-bold text-lg text-stone-800">Deudas de {monthLabel}</h3><p className="text-sm text-stone-500">Control de pagos mensuales</p></div><div className="flex gap-2"><button onClick={() => setIsDebtStatsOpen(true)} className="p-2 bg-stone-100 rounded-xl text-stone-500 hover:text-stone-800 transition-colors"><BarChart3 size={20} /></button><button onClick={() => openDebtModal()} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar Deuda</button></div></div>
                                    <div className="space-y-3">
                                        {filteredDebts.length === 0 ? <div className="flex flex-col items-center justify-center py-16 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200"><Receipt size={48} className="mb-4 opacity-20" /><p>No hay deudas registradas este mes.</p></div> : 
                                            filteredDebts.map(debt => (
                                                <div key={debt.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                                                    <div className="flex items-center gap-4"><button onClick={() => toggleDebtPaid(debt)} className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${debt.paid ? 'bg-emerald-100 text-emerald-600' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}>{debt.paid ? <CheckCircle2 size={20} /> : <Circle size={20} />}</button><div><h4 className={`font-bold text-lg leading-tight ${debt.paid ? 'text-stone-400 line-through' : 'text-stone-800'}`}>{debt.detail}</h4><p className="text-xs text-stone-400">{new Date(debt.date).toLocaleDateString()}</p></div></div>
                                                    <div className="flex items-center gap-4"><span className={`block text-xl font-bold ${debt.paid ? 'text-stone-300' : 'text-stone-900'}`}>${debt.amount.toLocaleString()}</span><div className="flex gap-1"><button onClick={() => openDebtModal(debt)} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg transition-colors"><Pencil size={18} /></button><button onClick={() => handleDeleteDebt(debt.id)} className="p-2 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button></div></div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            )}

                            {activeTab === 'finances' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="bg-stone-900 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                        <div className="absolute right-0 top-0 p-6 opacity-10"><Wallet size={120}/></div>
                                        <div className="relative z-10">
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                                                <div><p className="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Caja Total Disponible</p><h3 className="text-4xl md:text-5xl font-bold tracking-tight">${finances.totalBalance.toLocaleString()}</h3></div>
                                                <div className="flex gap-2 w-full md:w-auto"><button onClick={() => setIsIncomeModalOpen(true)} className="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20"><ArrowUpCircle size={18} /> Registrar Ingreso</button><button onClick={() => setIsExpenseModalOpen(true)} className="flex-1 md:flex-none bg-red-500 hover:bg-red-400 text-white px-4 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2 shadow-lg shadow-red-900/20"><ArrowDownCircle size={18} /> Registrar Gasto</button></div>
                                            </div>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-sm"><div className="flex items-center gap-2 text-emerald-400 mb-2"><Banknote size={18} /><span className="text-xs font-bold uppercase tracking-wider">Efectivo</span></div><p className="text-xl font-bold text-white">${finances.totalCash.toLocaleString()}</p></div><div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-sm"><div className="flex items-center gap-2 text-blue-400 mb-2"><CreditCard size={18} /><span className="text-xs font-bold uppercase tracking-wider">Digital</span></div><p className="text-xl font-bold text-white">${finances.totalTransfer.toLocaleString()}</p></div></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div className="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><div className="flex items-center gap-2 text-stone-400 mb-2"><ArrowDownLeft size={16} className="text-emerald-500" /><span className="text-xs font-bold uppercase">Ingresos ({monthLabel})</span></div><p className="text-2xl font-bold text-emerald-600">+${finances.incomeMonth.toLocaleString()}</p></div><div className="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><div className="flex items-center gap-2 text-stone-400 mb-2"><ArrowUpRight size={16} className="text-red-500" /><span className="text-xs font-bold uppercase">Gastos ({monthLabel})</span></div><p className="text-2xl font-bold text-red-500">-${finances.expenseMonth.toLocaleString()}</p></div><div className={`p-5 rounded-2xl border shadow-sm flex flex-col justify-between ${finances.netProfitMonth >= 0 ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}`}><div className="flex items-center gap-2 mb-2"><Coins size={16} className={finances.netProfitMonth >= 0 ? 'text-emerald-600' : 'text-red-600'} /><span className={`text-xs font-bold uppercase ${finances.netProfitMonth >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>Ganancia Neta</span></div><p className={`text-2xl font-bold ${finances.netProfitMonth >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>{finances.netProfitMonth >= 0 ? '+' : ''}${finances.netProfitMonth.toLocaleString()}</p></div></div>
                                    <div className="bg-white rounded-2xl border border-stone-200 shadow-sm overflow-hidden">
                                        <div className="p-4 border-b border-stone-100 bg-stone-50/50"><h3 className="font-bold text-stone-800">Movimientos de {monthLabel}</h3></div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-stone-500 uppercase bg-stone-50 border-b border-stone-200"><tr><th className="px-4 py-3">Fecha</th><th className="px-4 py-3">Descripci√≥n</th><th className="px-4 py-3 text-center">M√©todo</th><th className="px-4 py-3 text-right">Monto</th><th className="px-4 py-3 w-10"></th></tr></thead>
                                                <tbody>
                                                    {finances.movements.length === 0 ? <tr><td colSpan={5} className="px-4 py-8 text-center text-stone-400">Sin movimientos este mes.</td></tr> : finances.movements.map((mov) => (
                                                        <tr key={mov.id} className="border-b border-stone-100 hover:bg-stone-50/50">
                                                            <td className="px-4 py-3 text-stone-500 w-32">{new Date(mov.date).toLocaleDateString(undefined, {day:'2-digit', month:'2-digit'})}<span className="block text-[10px] text-stone-400">{new Date(mov.date).toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'})}</span></td>
                                                            <td className="px-4 py-3 font-medium text-stone-800">{mov.description} {mov.type === 'income' ? <span className="text-[10px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-1">Ingreso</span> : <span className="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded ml-1">Gasto</span>}</td>
                                                            <td className="px-4 py-3 text-center text-stone-500">{mov.method === 'cash' && <Banknote size={14} className="mx-auto"/>}{mov.method === 'transfer' && <CreditCard size={14} className="mx-auto"/>}{mov.method === 'mixed' && <div className="flex justify-center gap-1"><Banknote size={14} /><CreditCard size={14} /></div>}</td>
                                                            <td className={`px-4 py-3 text-right font-bold ${mov.type === 'income' ? 'text-emerald-600' : 'text-red-500'}`}>{mov.type === 'income' ? '+' : '-'}${mov.amount.toLocaleString()}</td>
                                                            <td className="px-4 py-3 text-right">
                                                                <div className="flex gap-1 justify-end">
                                                                    <button onClick={() => openEditMovement(mov)} className="text-stone-300 hover:text-stone-600 p-1"><Pencil size={14} /></button>
                                                                    <button onClick={() => handleDeleteMovement(mov)} className="text-stone-300 hover:text-red-500 p-1"><Trash2 size={14} /></button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="bg-stone-900 rounded-3xl p-8 text-white relative overflow-hidden"><BrainCircuit size={120} className="absolute -right-10 -bottom-10 opacity-10" /><div className="relative z-10 flex justify-between items-start mb-6"><div><h2 className="text-2xl font-bold">An√°lisis Inteligente</h2><p className="text-stone-400 text-sm">{statsAnalytics.insight}</p></div><div className="bg-white/10 p-1 rounded-lg flex text-xs font-bold"><button onClick={() => setStatScope('month')} className={`px-3 py-1 rounded-md transition-all ${statScope === 'month' ? 'bg-white text-stone-900' : 'text-stone-400 hover:text-white'}`}>Mensual</button><button onClick={() => setStatScope('year')} className={`px-3 py-1 rounded-md transition-all ${statScope === 'year' ? 'bg-white text-stone-900' : 'text-stone-400 hover:text-white'}`}>Anual</button></div></div><div className="relative z-10 mb-8"><div className="flex items-baseline gap-2"><h3 className="text-4xl font-bold">${statsAnalytics.totalRevenue.toLocaleString()}</h3><div className={`flex items-center gap-1 text-sm font-bold ${statsAnalytics.growth >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{statsAnalytics.growth >= 0 ? <TrendingUp size={16} /> : <TrendingDown size={16} />}<span>{Math.abs(statsAnalytics.growth)}% vs periodo anterior</span></div></div><p className="text-xs text-stone-500 mt-1 uppercase font-bold tracking-wider">Ingresos Totales ({statScope === 'month' ? monthLabel : currentDate.getFullYear()})</p></div><div className="relative z-10 h-40"><SimpleChart data={statsAnalytics.chartData} scope={statScope} /></div></div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4"><div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm"><p className="text-xs text-stone-400 font-bold uppercase mb-1">Ticket Promedio</p><div className="flex items-center gap-2"><ShoppingBag size={20} className="text-purple-500"/> <span className="text-xl font-bold">${statsAnalytics.avgTicket.toLocaleString()}</span></div></div><div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm"><p className="text-xs text-stone-400 font-bold uppercase mb-1">Mejor D√≠a</p><div className="flex items-center gap-2"><Calendar size={20} className="text-amber-500"/> <span className="text-xl font-bold">{statsAnalytics.bestDay}</span></div></div><div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm md:col-span-2"><p className="text-xs text-stone-400 font-bold uppercase mb-2">M√©todos de Pago (Real)</p><div className="flex items-center gap-4"><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-stone-600">Efectivo</span><span>${statsAnalytics.paymentStats.cash.toLocaleString()}</span></div><div className="w-full bg-stone-100 rounded-full h-2 overflow-hidden"><div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${(statsAnalytics.paymentStats.cash / (statsAnalytics.totalRevenue || 1)) * 100}%` }}></div></div></div><div className="flex-1"><div className="flex justify-between text-xs mb-1"><span className="font-bold text-stone-600">Digital</span><span>${statsAnalytics.paymentStats.transfer.toLocaleString()}</span></div><div className="w-full bg-stone-100 rounded-full h-2 overflow-hidden"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(statsAnalytics.paymentStats.transfer / (statsAnalytics.totalRevenue || 1)) * 100}%` }}></div></div></div></div></div></div>
                                    <div className="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm"><h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><PieChart size={18} className="text-blue-500"/> Top Productos</h3><div className="space-y-3">{statsAnalytics.products.slice(0, 5).map((p, i) => (<div key={i} className="flex items-center justify-between text-sm"><div className="flex items-center gap-2"><span className="font-mono text-stone-400 w-4">{i+1}</span><span className="font-medium text-stone-700">{p.name}</span></div><div className="text-stone-500">{p.count}u <span className="text-xs text-stone-300">|</span> <span className="font-bold text-stone-800">${p.revenue.toLocaleString()}</span></div></div>))}{statsAnalytics.products.length === 0 && <p className="text-stone-400 text-sm">Sin datos a√∫n.</p>}</div></div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MOBILE NAV (Bottom Bar) */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-0 pb-safe pt-1 z-50 flex justify-between items-end shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)]">
                        <button onClick={() => setActiveTab('orders')} className={`mobile-nav-item ${activeTab === 'orders' ? 'active' : ''} pb-3 pt-2`}><Home size={20} strokeWidth={activeTab === 'orders' ? 2.5 : 2} /><span className="text-[10px]">Pedidos</span></button>
                        <button onClick={() => setActiveTab('inventory')} className={`mobile-nav-item ${activeTab === 'inventory' ? 'active' : ''} pb-3 pt-2`}><Tag size={20} strokeWidth={activeTab === 'inventory' ? 2.5 : 2} /><span className="text-[10px]">Inventario</span></button>
                        <div className="relative -top-5 mx-1"><button onClick={() => openModal()} className="h-14 w-14 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-200 active:scale-95 transition-transform border-4 border-white"><Plus size={28} /></button></div>
                        <button onClick={() => setActiveTab('debts')} className={`mobile-nav-item ${activeTab === 'debts' ? 'active' : ''} pb-3 pt-2`}><Receipt size={20} strokeWidth={activeTab === 'debts' ? 2.5 : 2} /><span className="text-[10px]">Deudas</span></button>
                        <button onClick={() => setActiveTab('finances')} className={`mobile-nav-item ${activeTab === 'finances' ? 'active' : ''} pb-3 pt-2`}><Wallet size={20} strokeWidth={activeTab === 'finances' ? 2.5 : 2} /><span className="text-[10px]">Finanzas</span></button>
                    </div>

                    {/* NEW MODAL DESIGN FOR MULTI-ITEM ORDERS */}
                    <Modal isOpen={isModalOpen} onClose={closeModal} title={editingId ? "Editar Pedido" : "Nuevo Pedido"}>
                        <form onSubmit={handleSaveOrder} className="space-y-5">
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl text-sm" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div>
                                <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Cliente</label><input type="text" placeholder="Nombre..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl text-sm font-bold" value={form.client} onChange={e => setForm({...form, client: e.target.value})} /></div>
                            </div>

                            {/* ITEM LIST AREA */}
                            <div className="bg-stone-50 rounded-2xl p-4 border border-stone-200">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="text-xs font-bold text-stone-500 uppercase flex items-center gap-1"><ShoppingCart size={14} /> Carrito ({form.items.length})</h4>
                                    <span className="text-lg font-black text-stone-800">${parseFloat(form.price).toLocaleString()}</span>
                                </div>
                                
                                {form.items.length > 0 ? (
                                    <div className="space-y-2 mb-4 max-h-40 overflow-y-auto custom-scrollbar pr-1">
                                        {form.items.map((item, idx) => (
                                            <div key={item.id || idx} className="bg-white p-2.5 rounded-xl border border-stone-100 flex items-center justify-between shadow-sm">
                                                <div className="flex-1">
                                                    <p className="font-bold text-sm text-stone-800 leading-tight">{item.name}</p>
                                                    <p className="text-[10px] text-stone-400">{item.quantity} x ${item.unitPrice.toLocaleString()}</p>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-sm text-stone-900">${item.total.toLocaleString()}</span>
                                                    <button type="button" onClick={() => handleRemoveItem(item.id)} className="text-stone-300 hover:text-red-500 p-1"><X size={16} /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-6 text-stone-400 text-sm border-2 border-dashed border-stone-200 rounded-xl mb-4">
                                        Carrito vac√≠o
                                    </div>
                                )}

                                {/* ADD ITEM FORM */}
                                <div className="pt-3 border-t border-stone-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-[10px] font-bold text-stone-400 uppercase block">Agregar √çtem</label>
                                        <button 
                                            type="button" 
                                            onClick={() => { setIsCustomItem(!isCustomItem); setSubItem({ productId: '', quantity: 1, unitPrice: 0, detail: '' }); }}
                                            className="text-[10px] font-bold text-emerald-600 hover:text-emerald-700 underline decoration-dashed transition-colors"
                                        >
                                            {isCustomItem ? 'Seleccionar del Stock' : 'Agregar Manual / Servicio'}
                                        </button>
                                    </div>

                                    <div className="flex gap-2 items-end">
                                        {isCustomItem ? (
                                            <>
                                                <div className="flex-[2] space-y-1">
                                                     <input 
                                                        type="text" 
                                                        placeholder="Descripci√≥n..." 
                                                        className="w-full p-2.5 bg-white border border-stone-200 rounded-xl text-sm"
                                                        value={subItem.detail || ''}
                                                        onChange={e => setSubItem({...subItem, detail: e.target.value})}
                                                     />
                                                </div>
                                                <div className="flex-1 space-y-1">
                                                     <input 
                                                        type="number" 
                                                        placeholder="Precio" 
                                                        className="w-full p-2.5 bg-white border border-stone-200 rounded-xl text-sm font-mono"
                                                        value={subItem.unitPrice || ''}
                                                        onChange={e => setSubItem({...subItem, unitPrice: e.target.value})}
                                                     />
                                                </div>
                                            </>
                                        ) : (
                                            <div className="relative flex-[3]">
                                                <select 
                                                    className="w-full p-2.5 bg-white border border-stone-200 rounded-xl text-sm appearance-none pr-8" 
                                                    value={subItem.productId} 
                                                    onChange={handleSelectProduct}
                                                >
                                                    <option value="">Seleccionar...</option>
                                                    {inventory.map(p => (<option key={p.id} value={p.id}>{p.name}</option>))}
                                                </select>
                                                <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Boxes size={14}/></div>
                                            </div>
                                        )}

                                        <input 
                                            type="number" min="1" 
                                            className="w-16 p-2.5 bg-white border border-stone-200 rounded-xl text-sm text-center font-mono" 
                                            value={subItem.quantity} 
                                            onChange={e => setSubItem({...subItem, quantity: e.target.value})}
                                            placeholder="Cant"
                                        />
                                        <button 
                                            type="button" 
                                            onClick={handleAddItem}
                                            disabled={isCustomItem ? (!subItem.detail || !subItem.unitPrice) : !subItem.productId}
                                            className="bg-emerald-600 hover:bg-emerald-500 text-white p-2.5 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed shrink-0"
                                        >
                                            <Plus size={20} />
                                        </button>
                                    </div>
                                    {subItem.unitPrice > 0 && subItem.quantity > 0 && (
                                        <p className="text-[10px] text-right mt-1 text-emerald-600 font-bold">
                                            Subtotal: ${(subItem.unitPrice * subItem.quantity).toLocaleString()}
                                        </p>
                                    )}
                                </div>
                            </div>

                            <div className="flex items-center gap-2 py-1"><button type="button" onClick={() => setForm({...form, important: !form.important})} className={`flex-1 py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${form.important ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white text-stone-400'}`}><Star size={18} fill={form.important ? "currentColor" : "none"} /> <span className="text-sm font-bold">Importante</span></button></div>
                            <button type="submit" disabled={isSaving || form.items.length === 0} className={`w-full text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed transition-colors ${form.items.length === 0 ? 'bg-stone-400' : 'bg-stone-900 hover:bg-stone-800'}`}>{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingId ? 'Guardar Cambios' : 'Confirmar Pedido')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isPaymentModalOpen} onClose={() => setIsPaymentModalOpen(false)} title="Registrar Cobro">
                        {paymentModalStep === 'select' ? (
                            <div className="space-y-3 pt-2">
                                <div className="grid grid-cols-2 gap-3"><button onClick={() => confirmPayment('cash')} className="flex flex-col items-center justify-center p-6 bg-green-50 border border-green-200 rounded-2xl hover:bg-green-100 transition-colors gap-3 group"><div className="bg-green-100 text-green-700 p-3 rounded-full group-hover:scale-110 transition-transform"><Banknote size={28} /></div><span className="font-bold text-green-800">Efectivo</span></button><button onClick={() => confirmPayment('transfer')} className="flex flex-col items-center justify-center p-6 bg-blue-50 border border-blue-200 rounded-2xl hover:bg-blue-100 transition-colors gap-3 group"><div className="bg-blue-100 text-blue-700 p-3 rounded-full group-hover:scale-110 transition-transform"><CreditCard size={28} /></div><span className="font-bold text-blue-800">Transferencia</span></button></div>
                                <button onClick={() => setPaymentModalStep('mixed')} className="w-full flex items-center justify-center gap-3 p-4 bg-purple-50 border border-purple-200 rounded-2xl hover:bg-purple-100 transition-colors text-purple-800 font-bold"><div className="flex -space-x-1"><Banknote size={20}/><CreditCard size={20}/></div><span>Pago Mixto (Efectivo + Transferencia)</span></button>
                            </div>
                        ) : (
                            <div className="space-y-5 pt-2 animate-in slide-in-from-right-4">
                                <div className="bg-stone-50 p-4 rounded-2xl border border-stone-100 text-center"><p className="text-xs text-stone-400 uppercase font-bold mb-1">Total a Cobrar</p><p className="text-2xl font-bold text-stone-900">${orders.find(o => o.id === pendingPaymentId)?.price.toLocaleString()}</p></div>
                                <div className="space-y-4"><div><label className="text-xs font-bold text-green-600 uppercase mb-1 flex items-center gap-1"><Banknote size={12}/> Monto en Efectivo</label><input type="number" placeholder="0" className="w-full p-4 bg-white border border-stone-200 rounded-xl font-bold text-lg focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none" value={mixedAmounts.cash} onChange={(e) => handleNewPaymentMixedChange('cash', e.target.value)} onFocus={e => e.target.select()} autoFocus /></div><div className="flex justify-center"><ArrowDownCircle size={20} className="text-stone-300"/></div><div><label className="text-xs font-bold text-blue-600 uppercase mb-1 flex items-center gap-1"><CreditCard size={12}/> Resto en Transferencia (Auto)</label><input type="number" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl font-bold text-lg text-stone-500" value={mixedAmounts.transfer} readOnly /></div></div>
                                <div className="flex gap-3 pt-2"><button onClick={() => setPaymentModalStep('select')} className="flex-1 py-3 rounded-xl font-bold bg-stone-100 text-stone-500 hover:bg-stone-200">Volver</button><button onClick={() => confirmPayment('mixed')} className="flex-[2] py-3 rounded-xl font-bold bg-purple-600 text-white hover:bg-purple-700 shadow-lg shadow-purple-200">Confirmar Mixto</button></div>
                            </div>
                        )}
                    </Modal>

                     <Modal isOpen={isDeliveryModalOpen} onClose={() => setIsDeliveryModalOpen(false)} title="Confirmar Entrega">
                        <div className="space-y-4 animate-in fade-in zoom-in-95 duration-200">
                            <div className="bg-blue-50 p-4 rounded-2xl flex items-center gap-3 border border-blue-100"><div className="bg-blue-100 p-2 rounded-xl text-blue-600"><Truck size={24}/></div><div><p className="font-bold text-blue-800 text-sm">Est√°s por entregar el pedido:</p><p className="text-blue-600 text-xs">{orders.find(o => o.id === pendingDeliveryId)?.detail}</p></div></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha y Hora de Entrega</label><div className="relative"><div className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400"><Clock size={18}/></div><input type="datetime-local" className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none text-sm font-medium" value={deliveryDateInput} onChange={(e) => setDeliveryDateInput(e.target.value)} /></div><p className="text-[10px] text-stone-400 ml-1">Dejar como est√° para usar fecha actual.</p></div>
                            <div className="flex gap-3 pt-2"><button onClick={() => setIsDeliveryModalOpen(false)} className="flex-1 py-3 rounded-xl font-bold bg-stone-100 text-stone-500 hover:bg-stone-200 transition-colors">Cancelar</button><button onClick={handleDeliveryConfirm} className="flex-[2] py-3 rounded-xl font-bold bg-stone-900 text-white hover:bg-stone-800 transition-colors shadow-lg">Confirmar Entrega</button></div>
                        </div>
                    </Modal>

                    <Modal isOpen={isExpenseModalOpen} onClose={() => setIsExpenseModalOpen(false)} title="Registrar Gasto">
                        <form onSubmit={handleSaveExpense} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={expenseForm.date} onChange={e => setExpenseForm({...expenseForm, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Descripci√≥n</label><input type="text" placeholder="Ej: Compra de yerba..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={expenseForm.description} onChange={e => setExpenseForm({...expenseForm, description: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Monto</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} onFocus={e => e.target.select()} /></div>
                            <div className="grid grid-cols-2 gap-3"><button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'cash'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${expenseForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><Banknote size={18} /> <span className="text-sm font-bold">Efectivo</span></button><button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'transfer'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${expenseForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><CreditCard size={18} /> <span className="text-sm font-bold">Transf.</span></button></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : 'Registrar Salida'}</button>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isIncomeModalOpen} onClose={() => setIsIncomeModalOpen(false)} title="Registrar Ingreso Extra">
                        <form onSubmit={handleSaveIncome} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={incomeForm.date} onChange={e => setIncomeForm({...incomeForm, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Descripci√≥n</label><input type="text" placeholder="Ej: Inversi√≥n inicial..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={incomeForm.description} onChange={e => setIncomeForm({...incomeForm, description: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Monto</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={incomeForm.amount} onChange={e => setIncomeForm({...incomeForm, amount: e.target.value})} onFocus={e => e.target.select()} /></div>
                            <div className="grid grid-cols-2 gap-3"><button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'cash'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${incomeForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><Banknote size={18} /> <span className="text-sm font-bold">Efectivo</span></button><button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'transfer'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${incomeForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><CreditCard size={18} /> <span className="text-sm font-bold">Transf.</span></button></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : 'Registrar Ingreso'}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isInventoryModalOpen} onClose={() => setIsInventoryModalOpen(false)} title={editingProductId ? "Editar Producto" : "Nuevo Producto"}>
                        <form onSubmit={handleSaveInventory} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Producto</label><input type="text" placeholder="Ej: Mate Imperial" autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.name} onChange={e => setInventoryForm({...inventoryForm, name: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><input type="text" placeholder="Ej: Con virola de alpaca..." className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.detail} onChange={e => setInventoryForm({...inventoryForm, detail: e.target.value})} /></div>
                            <div className="flex gap-4"><div className="space-y-1 flex-1"><label className="text-xs font-bold text-stone-400 uppercase">Precio</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={inventoryForm.price} onChange={e => setInventoryForm({...inventoryForm, price: e.target.value})} onFocus={e => e.target.select()} /></div><div className="space-y-1 flex-1"><label className="text-xs font-bold text-stone-400 uppercase">Stock Inicial</label><input type="number" placeholder="0" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={inventoryForm.stock} onChange={e => setInventoryForm({...inventoryForm, stock: e.target.value})} onFocus={e => e.target.select()} /></div></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingProductId ? 'Guardar Cambios' : 'Guardar Producto')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isDebtModalOpen} onClose={() => setIsDebtModalOpen(false)} title={editingDebtId ? "Editar Deuda" : "Nueva Deuda"}>
                        <form onSubmit={handleSaveDebt} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><input type="text" placeholder="Ej: Tarjeta Visa..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={debtForm.detail} onChange={e => setDebtForm({...debtForm, detail: e.target.value})} /></div>
                            {!editingDebtId && (
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-stone-400 uppercase">Tipo</label>
                                    <div className="flex gap-2"><button type="button" onClick={() => setDebtForm({...debtForm, type: 'unique'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'unique' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>√önico</button><button type="button" onClick={() => setDebtForm({...debtForm, type: 'installments'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'installments' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>Cuotas</button><button type="button" onClick={() => setDebtForm({...debtForm, type: 'fixed'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'fixed' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>Fijo</button></div>
                                </div>
                            )}
                            {debtForm.type === 'installments' && !editingDebtId && (<div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Cantidad de Cuotas</label><input type="number" placeholder="Ej: 6" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={debtForm.installments} onChange={e => setDebtForm({...debtForm, installments: e.target.value})} onFocus={e => e.target.select()} /></div>)}
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Valor de la Cuota</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={debtForm.amount} onChange={e => setDebtForm({...debtForm, amount: e.target.value})} onFocus={e => e.target.select()} /></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingDebtId ? 'Guardar Cambios' : 'Agregar Deuda')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isDebtStatsOpen} onClose={() => setIsDebtStatsOpen(false)} title="Deudas Anuales">
                         <div className="space-y-4">
                            <div className="p-4 bg-stone-100 rounded-2xl">
                                <h4 className="font-bold text-stone-800 mb-4">Proyecci√≥n de Pagos ({currentDate.getFullYear()})</h4>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    {debtsStats.map((item, index) => (
                                        <div key={index} className="flex items-center justify-between text-sm"><span className="text-stone-500 w-10">{item.label}</span><div className="flex-1 mx-3 h-2 bg-stone-200 rounded-full overflow-hidden"><div className="bg-red-400 h-full rounded-full" style={{ width: `${(item.value / (Math.max(...debtsStats.map(d => d.value)) || 1)) * 100}%` }}></div></div><span className="font-bold text-stone-800 w-16 text-right">${item.value.toLocaleString()}</span></div>
                                    ))}
                                </div>
                            </div>
                            <div className="text-center text-xs text-stone-400">Total anual estimado: <span className="font-bold text-stone-600">${debtsStats.reduce((a,b) => a + b.value, 0).toLocaleString()}</span></div>
                        </div>
                    </Modal>

                    <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} title="Configuraci√≥n">
                        <div className="flex gap-2 mb-6 p-1 bg-stone-100 rounded-xl">
                            <button onClick={() => setSettingsTab('location')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${settingsTab === 'location' ? 'bg-white shadow-sm text-stone-900 ring-1 ring-black/5' : 'text-stone-400 hover:text-stone-600'}`}><MapPin size={14} /> Ubicaci√≥n</button>
                            <button onClick={() => setSettingsTab('security')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${settingsTab === 'security' ? 'bg-white shadow-sm text-stone-900 ring-1 ring-black/5' : 'text-stone-400 hover:text-stone-600'}`}><Shield size={14} /> Seguridad</button>
                        </div>
                        {settingsTab === 'location' ? (
                            <form onSubmit={handleSaveLocation} className="space-y-4 animate-in fade-in duration-300">
                                <p className="text-sm text-stone-500">Ingresa tu ciudad para obtener el clima exacto.</p>
                                <div className="relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder="Ej: Buenos Aires, Rosario..." className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={settingsCity} onChange={e => setSettingsCity(e.target.value)} autoFocus /></div>
                                <button type="submit" className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold disabled:opacity-50" disabled={isSearchingCity}>{isSearchingCity ? 'Buscando...' : 'Guardar Ubicaci√≥n'}</button>
                                {locationConfig && <div className="text-xs text-center text-emerald-600 font-medium bg-emerald-50 py-2 rounded-lg border border-emerald-100 mt-2">Ubicaci√≥n actual: {locationConfig.name}, {locationConfig.country}</div>}
                            </form>
                        ) : (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                <form onSubmit={handleUpdateCredentials} className="space-y-5">
                                    <div className="bg-blue-50 p-3 rounded-xl flex gap-3 items-start border border-blue-100"><Info className="text-blue-500 shrink-0 mt-0.5" size={16} /><p className="text-xs text-blue-700 leading-relaxed">Aqu√≠ puedes cambiar el usuario y contrase√±a para acceder al sistema.</p></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase ml-1">Nuevo Usuario</label><div className="relative"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} /><input type="text" className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={tempCredentials.user} onChange={e => setTempCredentials({...tempCredentials, user: e.target.value})} /></div></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase ml-1">Nueva Contrase√±a</label><div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} /><input type="text" className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={tempCredentials.pass} onChange={e => setTempCredentials({...tempCredentials, pass: e.target.value})} /></div></div>
                                    <button type="submit" className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold">Actualizar Credenciales</button>
                                </form>
                                <div className="border-t border-stone-100 pt-6">
                                    <h4 className="text-xs font-bold text-stone-400 uppercase mb-3">Diagn√≥stico de Conexi√≥n</h4>
                                    <button onClick={runDiagnostic} className="w-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"><Stethoscope size={18} /> Probar Conexi√≥n a Base de Datos</button>
                                    {diagMessage && (
                                        <div className={`mt-3 p-3 rounded-xl text-sm font-medium flex items-center gap-2 ${diagMessage.type === 'success' ? 'bg-green-100 text-green-800' : (diagMessage.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-stone-100 text-stone-600')}`}>
                                            {diagMessage.type === 'loading' && <Loader2 size={16} className="animate-spin" />}
                                            {diagMessage.type === 'success' && <Check size={16} />}
                                            {diagMessage.type === 'error' && <AlertCircle size={16} />}
                                            {diagMessage.text}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </Modal>
                    
                    <Modal isOpen={isContactModalOpen} onClose={() => setIsContactModalOpen(false)} title="Sobre el Creador">
                        <div className="flex flex-col items-center text-center p-4">
                            <div className="h-20 w-20 bg-stone-900 rounded-full flex items-center justify-center text-white text-2xl font-bold mb-4 shadow-lg">JA</div>
                            <h3 className="text-xl font-bold text-stone-800 mb-1">Javier Amado</h3>
                            <p className="text-sm text-stone-500 mb-6">Desarrollador Full Stack</p>
                            <div className="w-full space-y-3"><div className="flex items-center gap-3 p-3 bg-stone-50 rounded-xl border border-stone-100"><div className="bg-white p-2 rounded-lg text-stone-600 shadow-sm"><Phone size={18} /></div><div className="text-left"><p className="text-[10px] uppercase font-bold text-stone-400">Celular</p><p className="text-sm font-medium text-stone-800">2355-440269</p></div></div><div className="flex items-center gap-3 p-3 bg-stone-50 rounded-xl border border-stone-100"><div className="bg-white p-2 rounded-lg text-stone-600 shadow-sm"><Mail size={18} /></div><div className="text-left"><p className="text-[10px] uppercase font-bold text-stone-400">Email</p><p className="text-sm font-medium text-stone-800">javieramado91@gmail.com</p></div></div></div>
                            <button onClick={() => setIsContactModalOpen(false)} className="mt-6 text-sm text-stone-400 hover:text-stone-600">Cerrar</button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MateManagerApp />);
    </script>
</body>
</html>
