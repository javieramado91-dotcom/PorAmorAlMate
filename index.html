<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Por Amor Al Mate - Gestión</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar personalizada sutil */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        /* Sidebar Scrollbar Dark */
        .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: #44403c; border-radius: 10px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb:hover { background: #57534e; }

        .chart-bar { transition: height 1s ease-out; }
        
        /* Animaciones para Toasts */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Estilos móvil */
        .mobile-nav-item {
            @apply flex flex-col items-center justify-center text-stone-400 transition-colors py-2 flex-1;
        }
        .mobile-nav-item.active {
            @apply text-emerald-600;
        }
        .mobile-nav-item.active svg {
            @apply stroke-[2.5px];
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#FAFAF9] text-stone-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Check, X, TrendingUp, Package, DollarSign, Calendar, Search, 
            Trash2, Leaf, Award, Zap, Plus, AlertCircle, BarChart3, 
            BrainCircuit, Home, PieChart, Star, Pencil, Filter, 
            MoreHorizontal, Sun, Cloud, CloudRain, ChevronLeft, 
            ChevronRight, Wind, CloudLightning, MapPin, Settings, Loader2,
            Wallet, ArrowUpRight, ArrowDownLeft, Banknote, CreditCard,
            TrendingDown, Activity, Info, FileJson, LogOut, Lock, Shield, User, Wifi, WifiOff, Stethoscope, Coins, ShoppingBag, Minus, Layers, AlertTriangle, Tag, List, Receipt, CheckCircle2, Circle, Repeat, Truck, Phone, Mail, Code, ArrowUpCircle, ArrowDownCircle
        } from 'lucide-react';

        // --- FIREBASE SETUP ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch } from "firebase/firestore";

        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const localConfig = {
            apiKey: "AIzaSyDnsoEp_t5lvF4K1vkhK7cWJ-B3NGE3_AI",
            authDomain: "por-amor-al-mate.firebaseapp.com",
            projectId: "por-amor-al-mate",
            storageBucket: "por-amor-al-mate.firebasestorage.app",
            messagingSenderId: "136176515954",
            appId: "1:136176515954:web:1e530cab217c2bf5b67beb",
            measurementId: "G-GWN0PYZ2PK"
        };

        let firebaseConfig;
        let isConfigured = true;

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = localConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            isConfigured = false;
        }

        // --- PANTALLA DE ERROR DE CONFIGURACIÓN ---
        const ConfigErrorScreen = () => (
            <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-3xl p-8 shadow-2xl text-stone-800">
                    <div className="bg-red-100 text-red-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6"><AlertCircle size={32} /></div>
                    <h1 className="text-2xl font-bold mb-2">Error Crítico</h1>
                    <p className="text-stone-500 mb-6">No se pudo iniciar la conexión con Firebase.</p>
                    <button onClick={() => window.location.reload()} className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">Reintentar</button>
                </div>
            </div>
        );

        // --- PANTALLA DE LOGIN ---
        const LoginScreen = ({ onLogin, credentials }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                setTimeout(() => {
                    if (username === credentials.user && password === credentials.pass) {
                        onLogin();
                    } else {
                        setError('Usuario o contraseña incorrectos');
                        setIsLoading(false);
                    }
                }, 800);
            };

            return (
                <div className="h-full w-full bg-stone-900 flex items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-500 relative">
                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-emerald-600 to-teal-700 opacity-10 pointer-events-none"></div>

                        <div className="p-8 pb-6 flex flex-col items-center justify-center relative z-10">
                            <div className="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-5 rounded-2xl mb-5 shadow-xl shadow-emerald-900/20 transform hover:scale-105 transition-transform duration-300">
                                <MateIcon size={48} strokeWidth={1.5} />
                            </div>
                            <h2 className="font-bold text-2xl text-stone-800 mb-1 tracking-tight text-center">Por Amor Al Mate</h2>
                            <p className="text-stone-500 text-sm font-medium tracking-wide uppercase">Sistema de Gestión</p>
                        </div>

                        <form onSubmit={handleSubmit} className="px-8 pb-8 pt-2 space-y-5">
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Usuario</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Info size={18} /></div>
                                    <input 
                                        type="text" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="Ingrese usuario" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        autoFocus 
                                    />
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-stone-500 uppercase tracking-wider ml-1">Contraseña</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-600 transition-colors"><Lock size={18} /></div>
                                    <input 
                                        type="password" 
                                        className="w-full pl-11 pr-4 py-3.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-stone-300 font-medium text-stone-700"
                                        placeholder="••••••••" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                    />
                                </div>
                            </div>
                            {error && <div className="text-red-500 text-sm font-medium flex items-center gap-2 bg-red-50 p-3.5 rounded-xl animate-in slide-in-from-top-2 border border-red-100"><AlertCircle size={16} /> {error}</div>}
                            
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-gradient-to-r from-stone-800 to-stone-900 hover:from-stone-700 hover:to-stone-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-stone-900/20 transition-all active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4"
                            >
                                {isLoading ? <Loader2 size={20} className="animate-spin text-emerald-400" /> : 'Iniciar Sesión'}
                            </button>
                        </form>
                        
                         <div className="bg-stone-50 p-4 text-center border-t border-stone-100">
                             <p className="text-[10px] text-stone-400 font-medium">© {new Date().getFullYear()} Por Amor Al Mate</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- UTILS & COMPONENTS ---
        const getHash = (str) => {
            if (!str) return 0;
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return hash;
        };

        const GenerativePattern = ({ hash, color }) => {
            const patternType = Math.abs(hash) % 4; 
            return (
                <svg width="100%" height="100%" className="absolute inset-0 opacity-10 pointer-events-none">
                    <pattern id={`pattern-${hash}`} x="0" y="0" width="12" height="12" patternUnits="userSpaceOnUse">
                        {patternType === 0 && <circle cx="6" cy="6" r="2" fill={color} />}
                        {patternType === 1 && <path d="M0 12L12 0M-2 2L2 -2M10 14L14 10" stroke={color} strokeWidth="1.5" />}
                        {patternType === 2 && <rect x="3" y="3" width="6" height="6" rx="1" stroke={color} strokeWidth="1.5" fill="none" />}
                        {patternType === 3 && <path d="M6 0L6 12M0 6L12 6" stroke={color} strokeWidth="1" />}
                    </pattern>
                    <rect width="100%" height="100%" fill={`url(#pattern-${hash})`} />
                </svg>
            );
        };

        const MateIcon = ({ size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M7 10c0 4.5 2.5 8 7 8s7-3.5 7-8" /> <ellipse cx="14" cy="10" rx="7" ry="2.5" /> <path d="M14 10l-3-8" /> <path d="M11 2l-2 2" />
            </svg>
        );

        const SmartIcon = ({ iconName, color, detail }) => {
            const hash = getHash(detail);
            const IconMap = { 'pen-tool': Zap, 'leaf': Leaf, 'flask-conical': Package, 'crown': Award, 'mate': MateIcon };
            const IconComponent = IconMap[iconName] || MateIcon;
            return (
                <div className="relative w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden shadow-sm transition-transform hover:scale-105 duration-300 bg-white border border-stone-100">
                    <div className="absolute inset-0 opacity-20" style={{ backgroundColor: color }}></div>
                    <GenerativePattern hash={hash} color={color} />
                    <div className="relative z-10 drop-shadow-sm" style={{ color: color }}>
                        <IconComponent size={26} strokeWidth={2} />
                    </div>
                </div>
            );
        };

        const identifyCategory = (text) => {
            if (!text) return 'Varios';
            const t = text.toLowerCase();
            if (t.includes('imperial')) return 'Imperial';
            if (t.includes('camionero')) return 'Camionero';
            if (t.includes('torpedo')) return 'Torpedo';
            if (t.includes('bombilla')) return 'Accesorios';
            if (t.includes('termo') || t.includes('set') || t.includes('canasta')) return 'Sets';
            if (t.includes('yerba')) return 'Consumibles';
            return 'Varios';
        };

        const getSmartIconName = (description) => {
            if (!description) return 'mate';
            const lowerDesc = description.toLowerCase();
            if (lowerDesc.includes('bombilla')) return 'pen-tool'; 
            if (lowerDesc.includes('yerba')) return 'leaf';
            if (lowerDesc.includes('termo') || lowerDesc.includes('set')) return 'flask-conical';
            if (lowerDesc.includes('imperial') || lowerDesc.includes('camionero')) return 'crown';
            return 'mate'; 
        };

        const generateColorFromText = (text) => {
            if (!text) return '#5D8C57';
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center px-6 py-4 border-b border-stone-100 bg-stone-50/50 shrink-0">
                            <h3 className="font-bold text-lg text-stone-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-stone-200 rounded-full transition-colors text-stone-400 hover:text-stone-600"><X size={20} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, title, message, onConfirm, isDanger }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-300">
                        <div className="p-6 flex flex-col items-center text-center">
                            <div className={`p-4 rounded-full mb-4 ${isDanger ? 'bg-red-50 text-red-500' : 'bg-stone-100 text-stone-500'}`}>
                                {isDanger ? <Trash2 size={32} /> : <AlertCircle size={32} />}
                            </div>
                            <h3 className="text-xl font-bold text-stone-800 mb-2">{title}</h3>
                            <p className="text-stone-500 text-sm mb-6">{message}</p>
                            <div className="flex gap-3 w-full">
                                <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors">Cancelar</button>
                                <button onClick={() => { onConfirm(); onClose(); }} className={`flex-1 py-3 rounded-xl font-bold text-white transition-colors ${isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-stone-900 hover:bg-stone-800'}`}>Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgClass = type === 'success' ? 'bg-stone-900 text-white' : 'bg-red-500 text-white';
            return (
                <div className={`toast-enter fixed bottom-4 right-4 z-[80] px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 ${bgClass}`}>
                    {type === 'success' ? <Check size={18} /> : <AlertCircle size={18} />}
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const DailyVibe = ({ onOpenSettings, customLocation }) => {
            const [weather, setWeather] = useState({ icon: Sun, temp: 24, label: 'Soleado', city: 'Cargando...' });
            const [phrase, setPhrase] = useState('');
            
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        let lat, lon, city;
                        if (customLocation?.lat) { lat = customLocation.lat; lon = customLocation.lon; city = customLocation.name; } 
                        else {
                            // Default location if none provided (should be covered by parent but safe to fallback)
                            lat = -34.7633; lon = -61.8942; city = "General Pinto";
                        }
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const data = await response.json();
                        if (data.current_weather) {
                            const { temperature, weathercode } = data.current_weather;
                            let icon = Sun; let label = 'Soleado';
                            if (weathercode === 0) { icon = Sun; label = 'Despejado'; }
                            else if (weathercode >= 1 && weathercode <= 3) { icon = Cloud; label = 'Nublado'; }
                            else if (weathercode >= 45 && weathercode <= 48) { icon = Cloud; label = 'Neblina'; }
                            else if (weathercode >= 51 && weathercode <= 67) { icon = CloudRain; label = 'Lluvioso'; }
                            else if (weathercode >= 80 && weathercode <= 82) { icon = CloudRain; label = 'Lluvias'; }
                            else if (weathercode >= 95) { icon = CloudLightning; label = 'Tormenta'; }
                            setWeather({ icon, temp: Math.round(temperature), label, city });
                        }
                    } catch { setWeather(prev => ({ ...prev, city: customLocation?.name || 'Sin conexión' })); }
                };
                fetchWeather();
                const phrases = ["Hoy es un buen día para unos amargos.", "El mate no se le niega a nadie.", "Cebando sueños, cosechando momentos.", "La vida es como el mate, hay que saber cebarla.", "Arrancando la jornada con buena energía.", "Mate en mano, problemas volando.", "Unos verdes para aclarar las ideas.", "Charla que va, mate que viene."];
                setPhrase(phrases[Math.floor(Math.random() * phrases.length)]);
            }, [customLocation]);

            const today = new Date();
            const dateStr = new Intl.DateTimeFormat('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(today);
            const WeatherIcon = weather.icon;

            return (
                <div className="bg-stone-900 text-white px-5 py-4 rounded-3xl shadow-md mb-4 relative overflow-hidden group flex-shrink-0">
                    <div className="absolute top-0 right-0 p-4 opacity-10 transform translate-x-4 -translate-y-4"><WeatherIcon size={80} /></div>
                    <div className="relative z-10 flex items-center justify-between">
                        <div className="flex-1">
                            <div className="flex items-center gap-3 text-stone-400 text-xs font-medium mb-1 uppercase tracking-wider">
                                <span>{dateStr.charAt(0).toUpperCase() + dateStr.slice(1)}</span>
                                <div className="h-1 w-1 rounded-full bg-stone-600"></div>
                                <div className="flex items-center gap-1 text-emerald-400"><MapPin size={10} /><span>{weather.city}</span></div>
                            </div>
                            <div className="flex items-center gap-4">
                                <h2 className="text-lg md:text-xl font-bold leading-tight text-[#e8dcc0] flex-1">"{phrase}"</h2>
                                <div className="flex items-center gap-2 text-white bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm border border-white/5 shrink-0">
                                    <WeatherIcon size={16} /><span className="font-bold text-sm">{weather.temp}°</span>
                                </div>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="ml-4 p-2 rounded-full bg-white/5 hover:bg-white/10 text-stone-400 hover:text-white transition-colors" title="Cambiar ubicación"><Settings size={16} /></button>
                    </div>
                </div>
            );
        };

        const SimpleChart = ({ data, scope }) => {
            if (!data || data.length === 0) return <div className="h-32 flex items-center justify-center text-stone-400 text-sm">Sin datos para graficar</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="flex items-end gap-2 h-40 pt-4 pb-2 w-full overflow-x-auto">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center gap-1 group min-w-[20px]">
                            <div className="w-full bg-emerald-500/20 rounded-t-sm relative group-hover:bg-emerald-500 transition-colors chart-bar" style={{ height: maxVal > 0 ? `${(d.value / maxVal) * 100}%` : '0%' }}>
                                <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-stone-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10">${d.value.toLocaleString()}</div>
                            </div>
                            <span className="text-[10px] text-stone-400 font-medium rotate-0 truncate w-full text-center">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const MateManagerApp = () => {
            const [isLocked, setIsLocked] = useState(true);
            const [credentials, setCredentials] = useState(() => {
                const saved = localStorage.getItem('mate_credentials');
                return saved ? JSON.parse(saved) : { user: 'Mate', pass: '9193' };
            });
            const [activeTab, setActiveTab] = useState('orders');
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [debts, setDebts] = useState([]);
            const [incomes, setIncomes] = useState([]); // New state for manual incomes
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [toasts, setToasts] = useState([]);
            
            // Filters
            const [orderFilter, setOrderFilter] = useState('all');

            // Connection Status
            const [connectionStatus, setConnectionStatus] = useState('checking'); 
            const [authErrorDetails, setAuthErrorDetails] = useState('');

            // Settings
            const DEFAULT_LOCATION = { name: 'General Pinto', lat: -34.7633, lon: -61.8942, country: 'Argentina' };
            const [locationConfig, setLocationConfig] = useState(DEFAULT_LOCATION);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [settingsTab, setSettingsTab] = useState('location');
            const [settingsCity, setSettingsCity] = useState('');
            const [isSearchingCity, setIsSearchingCity] = useState(false);
            const [tempCredentials, setTempCredentials] = useState({ user: '', pass: '' });
            const [diagMessage, setDiagMessage] = useState(null);
            
            // Contact
            const [isContactModalOpen, setIsContactModalOpen] = useState(false);

            const [currentDate, setCurrentDate] = useState(new Date());
            const [statScope, setStatScope] = useState('month'); 
            const isFirstLoad = useRef(true); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [form, setForm] = useState({ client: '', detail: '', price: '', paid: false, paymentMethod: null, delivered: false, important: false, date: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
            const [pendingPaymentId, setPendingPaymentId] = useState(null);
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
            const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });
            
            // Income Modal
            const [isIncomeModalOpen, setIsIncomeModalOpen] = useState(false);
            const [incomeForm, setIncomeForm] = useState({ description: '', amount: '', method: 'cash', date: new Date().toISOString() });

            // Inventory (Price List)
            const [isInventoryModalOpen, setIsInventoryModalOpen] = useState(false);
            const [editingProductId, setEditingProductId] = useState(null);
            const [inventoryForm, setInventoryForm] = useState({ name: '', detail: '', price: '' });
            const [searchProduct, setSearchProduct] = useState('');
            
            // Debts
            const [isDebtModalOpen, setIsDebtModalOpen] = useState(false);
            const [isDebtStatsOpen, setIsDebtStatsOpen] = useState(false);
            const [debtForm, setDebtForm] = useState({ detail: '', type: 'unique', installments: '', amount: '' });
            const [editingDebtId, setEditingDebtId] = useState(null);

            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDanger: false });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                const savedAuth = localStorage.getItem('mate_auth_token');
                if (savedAuth === `valid_${credentials.pass}`) {
                    setIsLocked(false);
                }
            }, [credentials.pass]);

            const handleAppUnlock = () => {
                localStorage.setItem('mate_auth_token', `valid_${credentials.pass}`);
                setIsLocked(false);
                addToast('¡Bienvenido de nuevo!');
            };

            const handleLogout = () => {
                localStorage.removeItem('mate_auth_token');
                setIsLocked(true);
            };

            const openSettings = () => {
                setSettingsTab('location');
                setTempCredentials({ ...credentials });
                setDiagMessage(null);
                setIsSettingsOpen(true);
            };

            const runDiagnostic = async () => {
                setDiagMessage({ type: 'loading', text: 'Probando conexión...' });
                try {
                    if (!user) throw new Error("No hay usuario autenticado.");
                    const testRef = collection(db, 'artifacts', appId, 'public', 'data', 'diagnostic');
                    await addDoc(testRef, { timestamp: new Date(), test: true });
                    setDiagMessage({ type: 'success', text: '¡Conexión exitosa! Base de datos sincronizada.' });
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'permission-denied') msg = "Permisos denegados. Revisa las reglas en Firebase Console.";
                    if (err.code === 'unavailable') msg = "Sin conexión a internet o Firebase caído.";
                    setDiagMessage({ type: 'error', text: `Error: ${msg}` });
                }
            };

            const handleUpdateCredentials = (e) => {
                e.preventDefault();
                if (!tempCredentials.user || !tempCredentials.pass) {
                    addToast('Completa todos los campos', 'error');
                    return;
                }
                setCredentials(tempCredentials);
                localStorage.setItem('mate_credentials', JSON.stringify(tempCredentials));
                if (!isLocked) {
                    localStorage.setItem('mate_auth_token', `valid_${tempCredentials.pass}`);
                }
                addToast('Credenciales actualizadas', 'success');
                setIsSettingsOpen(false);
            };

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            const openModal = (order = null) => {
                setEditingId(order ? order.id : null);
                const defaultDate = order ? order.date.split('T')[0] : new Date().toISOString().split('T')[0];
                
                setForm(order ? { ...order, date: defaultDate } : { 
                    client: '', detail: '', price: '', paid: false, paymentMethod: null, delivered: false, important: false, 
                    date: defaultDate 
                });
                setIsModalOpen(true);
            };
            const closeModal = () => setIsModalOpen(false);

            useEffect(() => {
                if (!isConfigured) return; 
                const initAuth = async () => {
                    try { 
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth error:", e);
                        setConnectionStatus('disconnected');
                        setAuthErrorDetails(e.message);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { 
                    setUser(u); 
                    setIsAuthLoading(false);
                    if (u) setConnectionStatus('connected');
                    else setConnectionStatus('disconnected');
                });
                return () => unsubscribe();
            }, []);

            // === CORE DATA SYNC CHANGE: USING SHARED PUBLIC PATH ===
            // This ensures data is the same regardless of the device/anonymous User ID
            useEffect(() => {
                if (!user || !isConfigured) return;
                
                // Settings - Moved to Public
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                onSnapshot(settingsRef, (s) => { 
                    if (s.exists() && s.data().location) {
                        setLocationConfig(s.data().location); 
                    } else {
                        // Ensure default is set if not in DB
                        setLocationConfig(DEFAULT_LOCATION);
                    }
                });
                
                // Orders - Moved to Public
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                const unsubOrders = onSnapshot(query(ordersRef), (s) => {
                    const loaded = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                    setOrders(loaded);
                    if (isFirstLoad.current && loaded.length > 0) { setCurrentDate(new Date(loaded[loaded.length - 1].date)); isFirstLoad.current = false; }
                }, (error) => console.error("Error fetching orders:", error));
                
                // Expenses - Moved to Public
                const expensesRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                const unsubExpenses = onSnapshot(query(expensesRef), (s) => {
                    setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, (error) => console.error("Error fetching expenses:", error));

                // Inventory - Moved to Public
                const inventoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
                const unsubInventory = onSnapshot(query(inventoryRef), (s) => {
                    setInventory(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                }, (error) => console.error("Error fetching inventory:", error));

                // Debts - Moved to Public
                const debtsRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');
                const unsubDebts = onSnapshot(query(debtsRef), (s) => {
                    setDebts(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                });
                
                // Incomes - Moved to Public
                const incomesRef = collection(db, 'artifacts', appId, 'public', 'data', 'extra_incomes');
                const unsubIncomes = onSnapshot(query(incomesRef), (s) => {
                    setIncomes(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, (error) => console.error("Error fetching incomes:", error));

                return () => { unsubOrders(); unsubExpenses(); unsubIncomes(); unsubInventory(); unsubDebts(); };
            }, [user]);

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };

            const monthLabel = new Intl.DateTimeFormat('es-AR', { month: 'long', year: 'numeric' }).format(currentDate);
            const capitalizedMonthLabel = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            const filteredOrders = useMemo(() => orders.filter(o => {
                const d = new Date(o.date);
                const matchesDate = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                const matchesSearch = (o.client + o.detail).toLowerCase().includes(searchTerm.toLowerCase());
                
                let matchesFilter = true;
                if (orderFilter === 'pending_pay') matchesFilter = !o.paid;
                if (orderFilter === 'pending_delivery') matchesFilter = !o.delivered;

                return matchesDate && matchesSearch && matchesFilter;
            }).sort((a, b) => (b.important - a.important) || (new Date(b.date) - new Date(a.date))), [orders, currentDate, searchTerm, orderFilter]);

            // --- FILTERED INVENTORY (PRICE LIST) ---
            const filteredInventory = useMemo(() => {
                return inventory.filter(item => 
                    item.name.toLowerCase().includes(searchProduct.toLowerCase()) || 
                    (item.detail && item.detail.toLowerCase().includes(searchProduct.toLowerCase()))
                );
            }, [inventory, searchProduct]);

            // --- FILTERED DEBTS ---
            const filteredDebts = useMemo(() => {
                 return debts.filter(d => {
                     const date = new Date(d.date);
                     return date.getMonth() === currentDate.getMonth() && date.getFullYear() === currentDate.getFullYear();
                 });
            }, [debts, currentDate]);

            const debtsStats = useMemo(() => {
                const year = currentDate.getFullYear();
                const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const data = months.map((m, i) => {
                     const monthlyDebts = debts.filter(d => {
                         const date = new Date(d.date);
                         return date.getMonth() === i && date.getFullYear() === year;
                     });
                     const total = monthlyDebts.reduce((acc, d) => acc + (d.amount || 0), 0);
                     return { label: m, value: total };
                });
                return data;
            }, [debts, currentDate]);

            const finances = useMemo(() => {
                const monthOrders = orders.filter(o => {
                    const d = new Date(o.date);
                    return o.paid && d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });
                const monthExpenses = expenses.filter(e => {
                    const d = new Date(e.date);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });
                const monthIncomes = incomes.filter(i => {
                    const d = new Date(i.date);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });

                const incomeMonth = monthOrders.reduce((acc, o) => acc + o.price, 0) + monthIncomes.reduce((acc, i) => acc + i.amount, 0);
                const expenseMonth = monthExpenses.reduce((acc, e) => acc + e.amount, 0);
                const netProfitMonth = incomeMonth - expenseMonth;

                const movements = [
                    ...monthOrders.map(o => ({ ...o, type: 'income', description: `Pedido: ${o.client} - ${o.detail}`, amount: o.price, method: o.paymentMethod || 'cash' })),
                    ...monthIncomes.map(i => ({ ...i, type: 'income', description: `Ingreso: ${i.description}`, amount: i.amount, method: i.method || 'cash' })),
                    ...monthExpenses.map(e => ({ ...e, type: 'expense', method: e.method || 'cash' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const allPaid = orders.filter(o => o.paid);
                const totalCashOrders = allPaid.filter(o => o.paymentMethod === 'cash').reduce((s,o) => s + o.price, 0);
                const totalTransferOrders = allPaid.filter(o => o.paymentMethod === 'transfer').reduce((s,o) => s + o.price, 0);
                
                const totalCashExpenses = expenses.filter(e => e.method === 'cash').reduce((s,e) => s + e.amount, 0);
                const totalTransferExpenses = expenses.filter(e => e.method === 'transfer').reduce((s,e) => s + e.amount, 0);
                
                const totalCashIncomes = incomes.filter(i => i.method === 'cash').reduce((s,i) => s + i.amount, 0);
                const totalTransferIncomes = incomes.filter(i => i.method === 'transfer').reduce((s,i) => s + i.amount, 0);

                const totalCash = (totalCashOrders + totalCashIncomes) - totalCashExpenses;
                const totalTransfer = (totalTransferOrders + totalTransferIncomes) - totalTransferExpenses;
                
                return { movements, incomeMonth, expenseMonth, netProfitMonth, totalCash, totalTransfer, totalBalance: totalCash + totalTransfer };
            }, [orders, expenses, incomes, currentDate]);

            const statsAnalytics = useMemo(() => {
                const isMonth = statScope === 'month';
                const dataset = orders.filter(o => {
                    const d = new Date(o.date);
                    if (!o.paid) return false;
                    if (isMonth) return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                    else return d.getFullYear() === currentDate.getFullYear();
                });
                const prevDataset = orders.filter(o => {
                    const d = new Date(o.date);
                    if (!o.paid) return false;
                    if (isMonth) {
                        const prevDate = new Date(currentDate);
                        prevDate.setMonth(prevDate.getMonth() - 1);
                        return d.getMonth() === prevDate.getMonth() && d.getFullYear() === prevDate.getFullYear();
                    } else {
                        return d.getFullYear() === currentDate.getFullYear() - 1;
                    }
                });
                const totalRevenue = dataset.reduce((acc, o) => acc + o.price, 0);
                const prevRevenue = prevDataset.reduce((acc, o) => acc + o.price, 0);
                const growth = prevRevenue === 0 ? (totalRevenue > 0 ? 100 : 0) : Math.round(((totalRevenue - prevRevenue) / prevRevenue) * 100);
                const chartData = [];
                if (isMonth) {
                    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                    for(let i=1; i<=daysInMonth; i++) {
                        const val = dataset.filter(o => new Date(o.date).getDate() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: `${i}`, value: val });
                    }
                } else {
                    const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                    months.forEach((m, i) => {
                        const val = dataset.filter(o => new Date(o.date).getMonth() === i).reduce((s,o) => s + o.price, 0);
                        chartData.push({ label: m, value: val });
                    });
                }
                const counts = {}; const revenues = {};
                const stopWords = ['mate','el','la','con','de','un','premium','calidad','detalle'];
                dataset.forEach(o => {
                    const words = o.detail.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(w => w.length > 3 && !stopWords.includes(w));
                    let main = words.length > 0 ? words[0] : "varios";
                    if (main.endsWith('s')) main = main.slice(0, -1);
                    main = main.charAt(0).toUpperCase() + main.slice(1);
                    counts[main] = (counts[main] || 0) + 1;
                    revenues[main] = (revenues[main] || 0) + o.price;
                });
                const products = Object.keys(counts).map(k => ({ name: k, count: counts[k], revenue: revenues[k] })).sort((a,b) => b.revenue - a.revenue);
                let insight = "";
                if (growth > 0) insight = `¡Excelente! Has crecido un ${growth}% respecto al periodo anterior.`;
                else if (growth < 0) insight = `Ingresos un ${Math.abs(growth)}% menores al periodo anterior. ¡A repuntar!`;
                else insight = "Mantienes el mismo nivel de ventas que el periodo anterior.";
                if (products.length > 0) insight += ` El producto estrella es "${products[0].name}".`;
                
                // Advanced Stats
                const totalOrders = dataset.length;
                const avgTicket = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;
                
                // Best Day Calculation
                const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                const dayCounts = new Array(7).fill(0);
                dataset.forEach(o => {
                    dayCounts[new Date(o.date).getDay()]++;
                });
                const bestDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
                const bestDay = totalOrders > 0 ? days[bestDayIndex] : '-';

                // Payment Methods
                const cashTotal = dataset.filter(o => o.paymentMethod === 'cash').reduce((s,o) => s + o.price, 0);
                const transferTotal = dataset.filter(o => o.paymentMethod === 'transfer').reduce((s,o) => s + o.price, 0);
                const paymentStats = { cash: cashTotal, transfer: transferTotal };

                return { totalRevenue, growth, chartData, products, insight, avgTicket, bestDay, paymentStats };
            }, [orders, currentDate, statScope]);

            // --- INVENTORY ANALYTICS ---
            const inventoryStats = useMemo(() => {
                const totalItems = inventory.length;
                const totalValue = inventory.reduce((acc, item) => acc + (item.price || 0), 0); // Simplified value (sum of prices)
                return { totalItems, totalValue };
            }, [inventory]);

            const ordersAnalytics = useMemo(() => {
                const dataset = filteredOrders;
                const total = dataset.reduce((acc, o) => acc + (o.paid ? o.price : 0), 0);
                const pendingPay = dataset.reduce((acc, o) => acc + (!o.paid ? o.price : 0), 0);
                const pendingDel = dataset.filter(o => !o.delivered).length;
                return { total, pendingPay, pendingDel };
            }, [filteredOrders]);

            const handleSaveLocation = async (e) => {
                e.preventDefault(); 
                if (!settingsCity.trim()) {
                    addToast('Escribe una ciudad', 'error');
                    return; 
                }
                
                setIsSearchingCity(true);
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(settingsCity)}&count=1&language=es&format=json`);
                    const data = await res.json();
                    
                    if (data.results?.length > 0) {
                        const place = data.results[0];
                        const newConfig = { name: place.name, lat: place.latitude, lon: place.longitude, country: place.country };
                        
                        setLocationConfig(newConfig);
                        
                        if (user) {
                            // Saving to Public Settings
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), { location: newConfig }, { merge: true });
                        }
                        
                        // Close modal and give feedback
                        setIsSettingsOpen(false);
                        setSettingsCity('');
                        addToast(`Ubicación actualizada: ${place.name}`, 'success');
                    } else {
                        addToast("No se encontró la ciudad.", 'error');
                    }
                } catch (error) { 
                    console.error("Error fetching location:", error);
                    addToast("Error al buscar.", 'error'); 
                } finally { 
                    setIsSearchingCity(false); 
                }
            };

            const handleSaveOrder = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;

                if (!form.client.trim()) { addToast('Falta el nombre del cliente', 'error'); return; }
                if (!form.detail.trim()) { addToast('Falta el detalle del pedido', 'error'); return; }
                if (!form.price || parseFloat(form.price) <= 0) { addToast('El precio debe ser mayor a 0', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }

                setIsSaving(true);
                
                // Construct Date object safely
                // form.date should be YYYY-MM-DD from input type="date"
                const parts = form.date.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JS months are 0-11
                const day = parseInt(parts[2]);
                
                // Create date object at noon to avoid timezone rolling to previous day
                const selectedDate = new Date(year, month, day, 12, 0, 0);

                const orderData = {
                    client: form.client, detail: form.detail, price: parseFloat(form.price) || 0,
                    paid: form.paid, paymentMethod: form.paid ? (form.paymentMethod || 'cash') : null,
                    delivered: form.delivered, important: form.important,
                    date: selectedDate.toISOString(),
                    aiColor: generateColorFromText(form.detail), aiIcon: getSmartIconName(form.detail), category: identifyCategory(form.detail)
                };
                
                // Saving to Public Orders
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                
                try {
                    if (editingId) {
                        await updateDoc(doc(colRef, editingId), orderData);
                        addToast('Pedido actualizado', 'success');
                    } else { 
                        await addDoc(colRef, orderData); 
                        // Update current view to the date of the new order so user can see it
                        setCurrentDate(selectedDate);
                        addToast('Pedido guardado', 'success');
                    }
                    closeModal();
                } catch (err) { 
                    console.error(err); 
                    if (err.code === 'permission-denied') {
                        addToast('Faltan permisos (Revisar Reglas de Firebase)', 'error');
                    } else {
                        addToast(`Error (${err.code}): ${err.message}`, 'error'); 
                    }
                } finally {
                    setIsSaving(false);
                }
            };

            const handleSaveExpense = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;
                
                if (!expenseForm.description.trim()) { addToast('Falta la descripción', 'error'); return; }
                if (!expenseForm.amount || parseFloat(expenseForm.amount) <= 0) { addToast('Falta el monto', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }
                
                setIsSaving(true);

                 // Date handling for expense
                const parts = expenseForm.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                // Saving to Public Expenses
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                try {
                    await addDoc(colRef, { description: expenseForm.description, amount: parseFloat(expenseForm.amount) || 0, method: expenseForm.method, date: selectedDate.toISOString(), type: 'expense' });
                    setIsExpenseModalOpen(false); setExpenseForm({ description: '', amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
                    addToast('Gasto registrado', 'success');
                } catch(e) {
                    if (e.code === 'permission-denied') {
                        addToast('Error: Permisos denegados', 'error');
                    } else {
                        addToast(`Error (${e.code}): ${e.message}`, 'error');
                    }
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleSaveIncome = async (e) => {
                e.preventDefault(); 
                if (isSaving) return;
                
                if (!incomeForm.description.trim()) { addToast('Falta la descripción', 'error'); return; }
                if (!incomeForm.amount || parseFloat(incomeForm.amount) <= 0) { addToast('Falta el monto', 'error'); return; }
                if (!user) { addToast(`Error: ${authErrorDetails || 'No conectado'}`, 'error'); return; }
                
                setIsSaving(true);

                // Date handling for income
                const parts = incomeForm.date.split('-');
                const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);

                // Saving to Public Incomes
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'extra_incomes');
                try {
                    await addDoc(colRef, { description: incomeForm.description, amount: parseFloat(incomeForm.amount) || 0, method: incomeForm.method, date: selectedDate.toISOString(), type: 'income' });
                    setIsIncomeModalOpen(false); setIncomeForm({ description: '', amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
                    addToast('Ingreso registrado', 'success');
                } catch(e) {
                     addToast(`Error al guardar ingreso`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            // NEW: Open Inventory Modal for Edit or Create
            const openInventoryModal = (product = null) => {
                if (product) {
                    setEditingProductId(product.id);
                    setInventoryForm({
                        name: product.name,
                        detail: product.detail || '',
                        price: product.price
                    });
                } else {
                    setEditingProductId(null);
                    setInventoryForm({ name: '', detail: '', price: '' });
                }
                setIsInventoryModalOpen(true);
            };

            const handleSaveInventory = async (e) => {
                e.preventDefault();
                if (isSaving) return;
                if (!inventoryForm.name.trim()) { addToast('Falta el nombre', 'error'); return; }
                if (!inventoryForm.price || parseFloat(inventoryForm.price) <= 0) { addToast('Falta el precio', 'error'); return; }

                setIsSaving(true);
                const itemData = {
                    name: inventoryForm.name,
                    detail: inventoryForm.detail,
                    price: parseFloat(inventoryForm.price) || 0
                };
                
                // Saving to Public Inventory
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
                
                try {
                    if (editingProductId) {
                         await updateDoc(doc(colRef, editingProductId), itemData);
                         addToast('Producto actualizado', 'success');
                    } else {
                         await addDoc(colRef, itemData);
                         addToast('Producto agregado', 'success');
                    }
                    setIsInventoryModalOpen(false);
                } catch(e) {
                    addToast('Error al guardar', 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteInventoryItem = (id) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Producto',
                    message: '¿Estás seguro? Se borrará de la lista.',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            // Deleting from Public Inventory
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id));
                            addToast('Producto eliminado', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            // DEBTS LOGIC
            const openDebtModal = (debt = null) => {
                if (debt) {
                    setEditingDebtId(debt.id);
                    setDebtForm({ detail: debt.detail, type: 'unique', installments: '', amount: debt.amount });
                } else {
                    setEditingDebtId(null);
                    setDebtForm({ detail: '', type: 'unique', installments: '', amount: '' });
                }
                setIsDebtModalOpen(true);
            };

            const handleSaveDebt = async (e) => {
                e.preventDefault();
                if (isSaving) return;
                if (!debtForm.detail.trim()) { addToast('Falta el detalle', 'error'); return; }
                if (!debtForm.amount || parseFloat(debtForm.amount) <= 0) { addToast('Falta el monto de la cuota', 'error'); return; }

                setIsSaving(true);
                // Saving to Public Debts
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'debts');
                const batch = writeBatch(db);
                
                try {
                    if (editingDebtId) {
                        // Editing existing single debt
                        await updateDoc(doc(colRef, editingDebtId), { detail: debtForm.detail, amount: parseFloat(debtForm.amount) });
                        addToast('Deuda actualizada', 'success');
                    } else {
                        // Creating new debt(s)
                        const amount = parseFloat(debtForm.amount);
                        const baseDate = new Date(currentDate); 
                        // Ensure we start from current view month. 
                        baseDate.setDate(1);

                        if (debtForm.type === 'unique') {
                             const newRef = doc(colRef);
                             batch.set(newRef, { detail: debtForm.detail, amount, date: baseDate.toISOString(), paid: false });
                        } else if (debtForm.type === 'installments') {
                             const count = parseInt(debtForm.installments) || 2;
                             for (let i = 0; i < count; i++) {
                                 const d = new Date(baseDate);
                                 d.setMonth(d.getMonth() + i);
                                 const newRef = doc(colRef);
                                 batch.set(newRef, { detail: `${debtForm.detail} (${i+1}/${count})`, amount, date: d.toISOString(), paid: false });
                             }
                        } else if (debtForm.type === 'fixed') {
                             // Generate for 12 months
                             for (let i = 0; i < 12; i++) {
                                 const d = new Date(baseDate);
                                 d.setMonth(d.getMonth() + i);
                                 const newRef = doc(colRef);
                                 batch.set(newRef, { detail: debtForm.detail, amount, date: d.toISOString(), paid: false });
                             }
                        }
                        await batch.commit();
                        addToast('Deudas generadas correctamente', 'success');
                    }
                    setIsDebtModalOpen(false);
                } catch(e) { 
                    console.error(e);
                    addToast('Error al guardar', 'error'); 
                } 
                finally { setIsSaving(false); }
            };

            const handleDeleteDebt = (id) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Deuda',
                    message: '¿Estás seguro?',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            // Deleting from Public Debts
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', id));
                            addToast('Deuda eliminada', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            const toggleDebtPaid = async (debt) => {
                try {
                    // Toggling Public Debt
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', debt.id), { paid: !debt.paid });
                } catch(e) { console.error(e); }
            };


            const confirmPayment = async (method) => {
                if (!user || !pendingPaymentId) return;
                // Updating Public Order
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingPaymentId), { paid: true, paymentMethod: method });
                setIsPaymentModalOpen(false); setPendingPaymentId(null);
                addToast('Pago registrado');
            };

            const toggle = async (id, field) => {
                const order = orders.find(o => o.id === id);
                if (order) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { [field]: !order[field] });
            };
            const initiatePayment = (id) => { const o = orders.find(x => x.id === id); if(o.paid) toggle(id,'paid'); else { setPendingPaymentId(id); setIsPaymentModalOpen(true); }};
            
            const removeOrder = (id) => { 
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Pedido',
                    message: '¿Estás seguro de eliminar este pedido? Esta acción no se puede deshacer.',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            // Deleting from Public Orders
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                            addToast('Pedido eliminado', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            const removeExpense = (id) => { 
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Gasto',
                    message: '¿Estás seguro de eliminar este gasto?',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            // Deleting from Public Expenses
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
                            addToast('Gasto eliminado', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };
            
            const removeIncome = (id) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Eliminar Ingreso',
                    message: '¿Estás seguro de eliminar este ingreso?',
                    isDanger: true,
                    onConfirm: async () => {
                        try {
                            // Deleting from Public Incomes
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'extra_incomes', id));
                            addToast('Ingreso eliminado', 'success');
                        } catch(e) { addToast('Error al eliminar', 'error'); }
                    }
                });
            };

            if (!isConfigured) return <ConfigErrorScreen />;
            if (isLocked) return <LoginScreen onLogin={handleAppUnlock} credentials={credentials} />;
            if (isAuthLoading) return <div className="h-full w-full flex flex-col items-center justify-center bg-[#FAFAF9] text-stone-500 gap-4"><Loader2 size={40} className="animate-spin text-[#5D8C57]" /><p className="font-medium animate-pulse">Cargando datos...</p></div>;

            return (
                <div className="h-full w-full bg-[#FAFAF9] font-sans text-stone-800 flex flex-col md:flex-row overflow-hidden">
                    {toasts.map(toast => (
                        <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
                    ))}
                    
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        onClose={() => setConfirmModal({...confirmModal, isOpen: false})} 
                        title={confirmModal.title}
                        message={confirmModal.message}
                        onConfirm={confirmModal.onConfirm}
                        isDanger={confirmModal.isDanger}
                    />
                    
                    <Modal isOpen={isContactModalOpen} onClose={() => setIsContactModalOpen(false)} title="Sobre el Creador">
                        <div className="flex flex-col items-center text-center p-4">
                            <div className="h-20 w-20 bg-stone-900 rounded-full flex items-center justify-center text-white text-2xl font-bold mb-4 shadow-lg">JA</div>
                            <h3 className="text-xl font-bold text-stone-800 mb-1">Javier Amado</h3>
                            <p className="text-sm text-stone-500 mb-6">Desarrollador Full Stack</p>
                            
                            <div className="w-full space-y-3">
                                <div className="flex items-center gap-3 p-3 bg-stone-50 rounded-xl border border-stone-100">
                                    <div className="bg-white p-2 rounded-lg text-stone-600 shadow-sm"><Phone size={18} /></div>
                                    <div className="text-left">
                                        <p className="text-[10px] uppercase font-bold text-stone-400">Celular</p>
                                        <p className="text-sm font-medium text-stone-800">2355-440269</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3 p-3 bg-stone-50 rounded-xl border border-stone-100">
                                    <div className="bg-white p-2 rounded-lg text-stone-600 shadow-sm"><Mail size={18} /></div>
                                    <div className="text-left">
                                        <p className="text-[10px] uppercase font-bold text-stone-400">Email</p>
                                        <p className="text-sm font-medium text-stone-800">javieramado91@gmail.com</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onClick={() => setIsContactModalOpen(false)} className="mt-6 text-sm text-stone-400 hover:text-stone-600">Cerrar</button>
                        </div>
                    </Modal>

                    <aside className="hidden md:flex flex-col w-64 bg-stone-900 border-r border-stone-800 h-full flex-shrink-0 sticky top-0">
                        <div className="p-8 pb-4 flex items-center gap-3">
                            <div className="bg-emerald-600 text-white p-2 rounded-xl"><MateIcon size={24} /></div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-white">Por Amor Al Mate</h1>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <div className={`w-2 h-2 rounded-full ${connectionStatus === 'connected' ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                                    <p className="text-xs text-stone-400" title={connectionStatus === 'disconnected' ? authErrorDetails : 'Conectado a Firebase'}>
                                        {connectionStatus === 'connected' ? 'En línea' : 'Desconectado'}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto sidebar-scrollbar">
                            <button onClick={() => setActiveTab('orders')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'orders' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Home size={20} /> Pedidos</button>
                            <button onClick={() => setActiveTab('inventory')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'inventory' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Tag size={20} /> Lista Precios</button>
                            <button onClick={() => setActiveTab('debts')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'debts' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Receipt size={20} /> Deudas</button>
                            <button onClick={() => setActiveTab('finances')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'finances' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><Wallet size={20} /> Finanzas</button>
                            <button onClick={() => setActiveTab('stats')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${activeTab === 'stats' ? 'bg-white/10 text-white' : 'text-stone-400 hover:text-white hover:bg-white/5'}`}><BarChart3 size={20} /> Estadísticas</button>
                        </nav>
                        <div className="p-4 border-t border-stone-800 flex flex-col gap-3">
                            <button onClick={() => { setEditingId(null); setForm({ client: '', detail: '', price: '', paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-emerald-900/20 active:scale-95 transition-all flex items-center justify-center gap-2 group relative overflow-hidden">
                                <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                                <Plus size={20} className="relative z-10" /> <span className="relative z-10">Nuevo Pedido</span>
                            </button>
                            
                            {/* FOOTER PREMIUM */}
                            <div className="mt-auto pt-4 border-t border-stone-800/30 flex flex-col gap-1">
                                <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-xs font-bold text-stone-500 hover:text-white transition-colors py-3 rounded-xl hover:bg-white/5">
                                    <LogOut size={14} /> Cerrar Sesión
                                </button>
                                <button onClick={() => setIsContactModalOpen(true)} className="text-[10px] font-bold text-stone-600 hover:text-emerald-500 transition-colors tracking-widest uppercase py-2">
                                    Powered by JA
                                </button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 pb-24 md:pb-8 relative h-full overflow-y-auto custom-scrollbar">
                        <div className="md:hidden bg-white/80 backdrop-blur-md sticky top-0 z-30 px-4 py-3 border-b border-stone-100 flex items-center justify-between">
                            <div className="flex items-center gap-2"><div className="bg-emerald-600 text-white p-1.5 rounded-lg"><MateIcon size={18} /></div><span className="font-bold text-stone-800">Por Amor Al Mate</span></div>
                            <div className="flex gap-2">
                                <button onClick={handleLogout} className="h-8 w-8 bg-stone-100 rounded-full flex items-center justify-center text-stone-500"><LogOut size={14} /></button>
                            </div>
                        </div>

                        <div className="p-4 md:p-8 max-w-5xl mx-auto space-y-6 animate-in fade-in duration-500">
                            {/* TOP PANEL: DATE & WEATHER */}
                            <DailyVibe onOpenSettings={openSettings} customLocation={locationConfig} />

                            {/* DATE CONTROLS */}
                            <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-stone-100">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronLeft size={20} /></button>
                                <div className="flex items-center gap-2"><Calendar size={16} className="text-stone-400" /><span className="font-bold text-lg text-stone-800 capitalize">{capitalizedMonthLabel}</span></div>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-stone-100 rounded-xl transition-colors text-stone-500"><ChevronRight size={20} /></button>
                            </div>

                            {/* --- ORDERS TAB --- */}
                            {activeTab === 'orders' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">Ingresos (Mes)</p><p className="text-xl font-bold text-stone-900">${ordersAnalytics.total.toLocaleString()}</p></div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">Por Cobrar</p><p className="text-xl font-bold text-amber-600">${ordersAnalytics.pendingPay.toLocaleString()}</p></div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><p className="text-xs text-stone-400 uppercase font-bold">En Local</p><p className="text-xl font-bold text-stone-800">{ordersAnalytics.pendingDel}</p></div>
                                    </div>
                                    <div className="relative"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder={`Buscar en ${monthLabel}...`} className="w-full pl-11 pr-4 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-stone-200 text-stone-700 placeholder:text-stone-400" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                    
                                    <div className="flex gap-2 pb-2 overflow-x-auto no-scrollbar">
                                        <button onClick={() => setOrderFilter('all')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'all' ? 'bg-stone-800 text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Todos</button>
                                        <button onClick={() => setOrderFilter('pending_pay')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'pending_pay' ? 'bg-amber-100 text-amber-700 border border-amber-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Por Cobrar</button>
                                        <button onClick={() => setOrderFilter('pending_delivery')} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap ${orderFilter === 'pending_delivery' ? 'bg-blue-100 text-blue-700 border border-blue-200 shadow-sm' : 'bg-white text-stone-500 border border-stone-200 hover:bg-stone-50'}`}>Por Entregar</button>
                                    </div>

                                    <div className="space-y-4">
                                        {filteredOrders.length === 0 ? <div className="flex flex-col items-center justify-center py-20 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200"><Package size={48} className="mb-4 opacity-20" /><p>No hay pedidos en {monthLabel}.</p></div> : 
                                            filteredOrders.map(order => (
                                                <div key={order.id} className={`group bg-white rounded-3xl p-5 border transition-all duration-300 hover:shadow-lg relative overflow-hidden ${order.important ? 'border-amber-200 ring-4 ring-amber-50' : 'border-stone-100 shadow-sm'}`}>
                                                    {order.important && <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-amber-100/50 to-transparent -mr-8 -mt-8 rounded-full pointer-events-none"></div>}
                                                    
                                                    <div className="flex justify-between items-start mb-3 relative z-10">
                                                        <div className="flex items-center gap-3">
                                                             <div className="bg-stone-50 p-2.5 rounded-2xl text-stone-600">
                                                                <SmartIcon iconName={order.aiIcon} color={order.aiColor} detail={order.detail} /> 
                                                             </div>
                                                             <div>
                                                                <h3 className="font-bold text-stone-900 text-lg leading-tight">{order.client}</h3>
                                                                <span className="text-[11px] font-bold tracking-wide uppercase text-stone-400">{order.category} • {new Date(order.date).toLocaleDateString()}</span>
                                                             </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                             <button onClick={() => toggle(order.id, 'important')} className={`p-2 rounded-xl transition-all ${order.important ? 'text-amber-400 bg-amber-50' : 'text-stone-300 hover:bg-stone-100 hover:text-stone-500'}`}>
                                                                <Star size={18} fill={order.important ? "currentColor" : "none"} />
                                                             </button>
                                                             <div className="h-8 w-px bg-stone-100 mx-1"></div>
                                                             <button onClick={() => { setEditingId(order.id); setForm(order); setIsModalOpen(true); }} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-xl transition-colors"><Pencil size={18} /></button>
                                                        </div>
                                                    </div>
                                                
                                                    <p className="text-stone-600 text-sm mb-5 leading-relaxed pl-1">{order.detail}</p>
                                                
                                                    <div className="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-dashed border-stone-100">
                                                        <div className="flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-xl">
                                                             <span className="text-lg font-black text-stone-800">${order.price.toLocaleString()}</span>
                                                             {order.paymentMethod && (
                                                                <div className={`flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider ${order.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                    {order.paymentMethod === 'cash' ? <Banknote size={12}/> : <CreditCard size={12}/>}
                                                                    <span>{order.paymentMethod === 'cash' ? 'Efectivo' : 'Transf'}</span>
                                                                </div>
                                                             )}
                                                        </div>
                                                
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                onClick={() => initiatePayment(order.id)} 
                                                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${order.paid ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}
                                                            >
                                                                {order.paid ? <CheckCircle2 size={16} /> : <Circle size={16} />}
                                                                {order.paid ? 'Pagado' : 'Cobrar'}
                                                            </button>
                                                            
                                                            <button 
                                                                onClick={() => toggle(order.id, 'delivered')} 
                                                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${order.delivered ? 'bg-blue-100 text-blue-700 ring-1 ring-blue-200' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}
                                                            >
                                                                <Package size={16} />
                                                                {order.delivered ? 'Entregado' : 'Pendiente'}
                                                            </button>
                                                            
                                                            <button onClick={() => removeOrder(order.id)} className="p-2 text-stone-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors ml-1"><Trash2 size={18} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </>
                            )}

                            {/* --- INVENTORY TAB (PRICE LIST) --- */}
                            {activeTab === 'inventory' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="relative">
                                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} />
                                        <input type="text" placeholder="Buscar producto..." className="w-full pl-11 pr-4 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-stone-200 text-stone-700 placeholder:text-stone-400" value={searchProduct} onChange={e => setSearchProduct(e.target.value)} />
                                    </div>
                                    
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-lg">Lista de Precios</h3>
                                        <button onClick={() => openInventoryModal()} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar</button>
                                    </div>

                                    <div className="space-y-3">
                                        {filteredInventory.map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between group hover:shadow-md transition-all">
                                                <div className="flex items-center gap-4">
                                                    <div className="bg-stone-50 p-2.5 rounded-xl text-stone-500"><Tag size={20} /></div>
                                                    <div>
                                                        <h4 className="font-bold text-stone-800 text-lg leading-tight">{item.name}</h4>
                                                        {item.detail && <p className="text-sm text-stone-500 mt-1">{item.detail}</p>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <span className="block text-xl font-bold text-stone-900">${item.price.toLocaleString()}</span>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => openInventoryModal(item)} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg transition-colors"><Pencil size={18} /></button>
                                                        <button onClick={() => handleDeleteInventoryItem(item.id)} className="p-2 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {filteredInventory.length === 0 && <div className="text-center py-12 text-stone-400"><p>No se encontraron productos.</p></div>}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6 pt-6 border-t border-stone-200">
                                        <div className="p-4 rounded-2xl border border-stone-200 bg-stone-50/50">
                                            <p className="text-xs text-stone-400 font-bold uppercase mb-1">Total Items</p>
                                            <p className="text-2xl font-bold text-stone-800">{inventoryStats.totalItems}</p>
                                        </div>
                                        <div className="p-4 rounded-2xl border border-stone-200 bg-stone-50/50">
                                            <p className="text-xs text-stone-400 font-bold uppercase mb-1">Valor Inventario</p>
                                            <p className="text-2xl font-bold text-stone-800">${inventoryStats.totalValue.toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- DEBTS TAB --- */}
                            {activeTab === 'debts' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="font-bold text-lg text-stone-800">Deudas de {monthLabel}</h3>
                                            <p className="text-sm text-stone-500">Control de pagos mensuales</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsDebtStatsOpen(true)} className="p-2 bg-stone-100 rounded-xl text-stone-500 hover:text-stone-800 transition-colors"><BarChart3 size={20} /></button>
                                            <button onClick={() => openDebtModal()} className="bg-stone-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md"><Plus size={16} /> Agregar Deuda</button>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {filteredDebts.length === 0 ? <div className="flex flex-col items-center justify-center py-16 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200"><Receipt size={48} className="mb-4 opacity-20" /><p>No hay deudas registradas este mes.</p></div> : 
                                            filteredDebts.map(debt => (
                                                <div key={debt.id} className="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                                                    <div className="flex items-center gap-4">
                                                        <button onClick={() => toggleDebtPaid(debt)} className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${debt.paid ? 'bg-emerald-100 text-emerald-600' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}>
                                                            {debt.paid ? <CheckCircle2 size={20} /> : <Circle size={20} />}
                                                        </button>
                                                        <div>
                                                            <h4 className={`font-bold text-lg leading-tight ${debt.paid ? 'text-stone-400 line-through' : 'text-stone-800'}`}>{debt.detail}</h4>
                                                            <p className="text-xs text-stone-400">{new Date(debt.date).toLocaleDateString()}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <span className={`block text-xl font-bold ${debt.paid ? 'text-stone-300' : 'text-stone-900'}`}>${debt.amount.toLocaleString()}</span>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => openDebtModal(debt)} className="p-2 text-stone-400 hover:text-stone-800 hover:bg-stone-50 rounded-lg transition-colors"><Pencil size={18} /></button>
                                                            <button onClick={() => handleDeleteDebt(debt.id)} className="p-2 text-stone-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            )}

                            {/* --- FINANCES TAB --- */}
                            {activeTab === 'finances' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="bg-stone-900 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                        <div className="absolute right-0 top-0 p-6 opacity-10"><Wallet size={120}/></div>
                                        <div className="relative z-10">
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                                                <div>
                                                    <p className="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Caja Total Disponible</p>
                                                    <h3 className="text-4xl md:text-5xl font-bold tracking-tight">${finances.totalBalance.toLocaleString()}</h3>
                                                </div>
                                                <div className="flex gap-2 w-full md:w-auto">
                                                    <button onClick={() => setIsIncomeModalOpen(true)} className="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20"><ArrowUpCircle size={18} /> Registrar Ingreso</button>
                                                    <button onClick={() => setIsExpenseModalOpen(true)} className="flex-1 md:flex-none bg-red-500 hover:bg-red-400 text-white px-4 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2 shadow-lg shadow-red-900/20"><ArrowDownCircle size={18} /> Registrar Gasto</button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-sm"><div className="flex items-center gap-2 text-emerald-400 mb-2"><Banknote size={18} /><span className="text-xs font-bold uppercase tracking-wider">Efectivo</span></div><p className="text-xl font-bold text-white">${finances.totalCash.toLocaleString()}</p></div>
                                                <div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-sm"><div className="flex items-center gap-2 text-blue-400 mb-2"><CreditCard size={18} /><span className="text-xs font-bold uppercase tracking-wider">Digital</span></div><p className="text-xl font-bold text-white">${finances.totalTransfer.toLocaleString()}</p></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><div className="flex items-center gap-2 text-stone-400 mb-2"><ArrowDownLeft size={16} className="text-emerald-500" /><span className="text-xs font-bold uppercase">Ingresos ({monthLabel})</span></div><p className="text-2xl font-bold text-emerald-600">+${finances.incomeMonth.toLocaleString()}</p></div>
                                        <div className="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-between"><div className="flex items-center gap-2 text-stone-400 mb-2"><ArrowUpRight size={16} className="text-red-500" /><span className="text-xs font-bold uppercase">Gastos ({monthLabel})</span></div><p className="text-2xl font-bold text-red-500">-${finances.expenseMonth.toLocaleString()}</p></div>
                                        <div className={`p-5 rounded-2xl border shadow-sm flex flex-col justify-between ${finances.netProfitMonth >= 0 ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}`}><div className="flex items-center gap-2 mb-2"><Coins size={16} className={finances.netProfitMonth >= 0 ? 'text-emerald-600' : 'text-red-600'} /><span className={`text-xs font-bold uppercase ${finances.netProfitMonth >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>Ganancia Neta</span></div><p className={`text-2xl font-bold ${finances.netProfitMonth >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>{finances.netProfitMonth >= 0 ? '+' : ''}${finances.netProfitMonth.toLocaleString()}</p></div>
                                    </div>

                                    <div className="bg-white rounded-2xl border border-stone-200 shadow-sm overflow-hidden">
                                        <div className="p-4 border-b border-stone-100 bg-stone-50/50"><h3 className="font-bold text-stone-800">Movimientos de {monthLabel}</h3></div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-stone-500 uppercase bg-stone-50 border-b border-stone-200"><tr><th className="px-4 py-3">Fecha</th><th className="px-4 py-3">Descripción</th><th className="px-4 py-3 text-center">Método</th><th className="px-4 py-3 text-right">Monto</th><th className="px-4 py-3 w-10"></th></tr></thead>
                                                <tbody>
                                                    {finances.movements.length === 0 ? <tr><td colSpan={5} className="px-4 py-8 text-center text-stone-400">Sin movimientos este mes.</td></tr> : finances.movements.map((mov) => (
                                                        <tr key={mov.id} className="border-b border-stone-100 hover:bg-stone-50/50">
                                                            <td className="px-4 py-3 text-stone-500 w-24">{new Date(mov.date).toLocaleDateString(undefined, {day:'2-digit', month:'2-digit'})}</td>
                                                            <td className="px-4 py-3 font-medium text-stone-800">{mov.description} {mov.type === 'income' ? <span className="text-[10px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-1">Ingreso</span> : <span className="text-[10px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded ml-1">Gasto</span>}</td>
                                                            <td className="px-4 py-3 text-center text-stone-500">{mov.method === 'cash' ? <Banknote size={14} className="mx-auto"/> : <CreditCard size={14} className="mx-auto"/>}</td>
                                                            <td className={`px-4 py-3 text-right font-bold ${mov.type === 'income' ? 'text-emerald-600' : 'text-red-500'}`}>{mov.type === 'income' ? '+' : '-'}${mov.amount.toLocaleString()}</td>
                                                            <td className="px-4 py-3 text-right">
                                                                {mov.type === 'expense' && <button onClick={() => removeExpense(mov.id)} className="text-stone-300 hover:text-red-500"><Trash2 size={14} /></button>}
                                                                {mov.type === 'income' && !mov.description.startsWith('Pedido:') && <button onClick={() => removeIncome(mov.id)} className="text-stone-300 hover:text-red-500"><Trash2 size={14} /></button>}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- STATS TAB --- */}
                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                    <div className="bg-stone-900 rounded-3xl p-8 text-white relative overflow-hidden">
                                        <BrainCircuit size={120} className="absolute -right-10 -bottom-10 opacity-10" />
                                        <div className="relative z-10 flex justify-between items-start mb-6">
                                            <div>
                                                <h2 className="text-2xl font-bold">Análisis Inteligente</h2>
                                                <p className="text-stone-400 text-sm">{statsAnalytics.insight}</p>
                                            </div>
                                            <div className="bg-white/10 p-1 rounded-lg flex text-xs font-bold">
                                                <button onClick={() => setStatScope('month')} className={`px-3 py-1 rounded-md transition-all ${statScope === 'month' ? 'bg-white text-stone-900' : 'text-stone-400 hover:text-white'}`}>Mensual</button>
                                                <button onClick={() => setStatScope('year')} className={`px-3 py-1 rounded-md transition-all ${statScope === 'year' ? 'bg-white text-stone-900' : 'text-stone-400 hover:text-white'}`}>Anual</button>
                                            </div>
                                        </div>

                                        <div className="relative z-10 mb-8">
                                            <div className="flex items-baseline gap-2">
                                                <h3 className="text-4xl font-bold">${statsAnalytics.totalRevenue.toLocaleString()}</h3>
                                                <div className={`flex items-center gap-1 text-sm font-bold ${statsAnalytics.growth >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {statsAnalytics.growth >= 0 ? <TrendingUp size={16} /> : <TrendingDown size={16} />}
                                                    <span>{Math.abs(statsAnalytics.growth)}% vs periodo anterior</span>
                                                </div>
                                            </div>
                                            <p className="text-xs text-stone-500 mt-1 uppercase font-bold tracking-wider">Ingresos Totales ({statScope === 'month' ? monthLabel : currentDate.getFullYear()})</p>
                                        </div>

                                        <div className="relative z-10 h-40">
                                            <SimpleChart data={statsAnalytics.chartData} scope={statScope} />
                                        </div>
                                    </div>

                                    {/* NEW STAT CARDS */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm">
                                            <p className="text-xs text-stone-400 font-bold uppercase mb-1">Ticket Promedio</p>
                                            <div className="flex items-center gap-2"><ShoppingBag size={20} className="text-purple-500"/> <span className="text-xl font-bold">${statsAnalytics.avgTicket.toLocaleString()}</span></div>
                                        </div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm">
                                            <p className="text-xs text-stone-400 font-bold uppercase mb-1">Mejor Día</p>
                                            <div className="flex items-center gap-2"><Calendar size={20} className="text-amber-500"/> <span className="text-xl font-bold">{statsAnalytics.bestDay}</span></div>
                                        </div>
                                        <div className="bg-white p-4 rounded-2xl border border-stone-200 shadow-sm md:col-span-2">
                                            <p className="text-xs text-stone-400 font-bold uppercase mb-2">Métodos de Pago</p>
                                            <div className="flex items-center gap-4">
                                                <div className="flex-1">
                                                    <div className="flex justify-between text-xs mb-1"><span className="font-bold text-stone-600">Efectivo</span><span>${statsAnalytics.paymentStats.cash.toLocaleString()}</span></div>
                                                    <div className="w-full bg-stone-100 rounded-full h-2 overflow-hidden"><div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${(statsAnalytics.paymentStats.cash / (statsAnalytics.totalRevenue || 1)) * 100}%` }}></div></div>
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between text-xs mb-1"><span className="font-bold text-stone-600">Digital</span><span>${statsAnalytics.paymentStats.transfer.toLocaleString()}</span></div>
                                                    <div className="w-full bg-stone-100 rounded-full h-2 overflow-hidden"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(statsAnalytics.paymentStats.transfer / (statsAnalytics.totalRevenue || 1)) * 100}%` }}></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                                        <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><PieChart size={18} className="text-blue-500"/> Top Productos</h3>
                                        <div className="space-y-3">
                                            {statsAnalytics.products.slice(0, 5).map((p, i) => (
                                                <div key={i} className="flex items-center justify-between text-sm">
                                                    <div className="flex items-center gap-2"><span className="font-mono text-stone-400 w-4">{i+1}</span><span className="font-medium text-stone-700">{p.name}</span></div>
                                                    <div className="text-stone-500">{p.count}u <span className="text-xs text-stone-300">|</span> <span className="font-bold text-stone-800">${p.revenue.toLocaleString()}</span></div>
                                                </div>
                                            ))}
                                            {statsAnalytics.products.length === 0 && <p className="text-stone-400 text-sm">Sin datos aún.</p>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MOBILE NAV */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-0 pb-safe pt-1 z-50 flex justify-between items-end shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)]">
                        <button onClick={() => setActiveTab('orders')} className={`mobile-nav-item ${activeTab === 'orders' ? 'active' : ''} pb-3 pt-2`}>
                            <Home size={20} strokeWidth={activeTab === 'orders' ? 2.5 : 2} />
                            <span className="text-[10px]">Pedidos</span>
                        </button>
                        <button onClick={() => setActiveTab('inventory')} className={`mobile-nav-item ${activeTab === 'inventory' ? 'active' : ''} pb-3 pt-2`}>
                            <Tag size={20} strokeWidth={activeTab === 'inventory' ? 2.5 : 2} />
                            <span className="text-[10px]">Precios</span>
                        </button>
                        
                        {/* FAB CONTAINER - Lifted up */}
                        <div className="relative -top-5 mx-1">
                             <button 
                                onClick={() => { setEditingId(null); setForm({ client: '', detail: '', price: '', paid: false, delivered: false, important: false, date: new Date().toISOString().split('T')[0] }); setIsModalOpen(true); }} 
                                className="h-14 w-14 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-200 active:scale-95 transition-transform border-4 border-white"
                            >
                                <Plus size={28} />
                            </button>
                        </div>

                        <button onClick={() => setActiveTab('debts')} className={`mobile-nav-item ${activeTab === 'debts' ? 'active' : ''} pb-3 pt-2`}>
                            <Receipt size={20} strokeWidth={activeTab === 'debts' ? 2.5 : 2} />
                            <span className="text-[10px]">Deudas</span>
                        </button>
                         {/* Group Finances & Stats or put one? Let's put Finances. Stats can be top right */}
                        <button onClick={() => setActiveTab('finances')} className={`mobile-nav-item ${activeTab === 'finances' ? 'active' : ''} pb-3 pt-2`}>
                            <Wallet size={20} strokeWidth={activeTab === 'finances' ? 2.5 : 2} />
                            <span className="text-[10px]">Finanzas</span>
                        </button>
                    </div>

                    {/* MODALS */}
                    <Modal isOpen={isModalOpen} onClose={closeModal} title={editingId ? "Editar Pedido" : "Nuevo Pedido"}>
                        <form onSubmit={handleSaveOrder} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Cliente</label><input type="text" placeholder="Nombre..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.client} onChange={e => setForm({...form, client: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><textarea rows={3} placeholder="Producto..." className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={form.detail} onChange={e => setForm({...form, detail: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Precio</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={form.price} onChange={e => setForm({...form, price: e.target.value})} /></div>
                            <div className="flex items-center gap-2 py-2"><button type="button" onClick={() => setForm({...form, important: !form.important})} className={`flex-1 py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${form.important ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white text-stone-400'}`}><Star size={18} fill={form.important ? "currentColor" : "none"} /> <span className="text-sm font-bold">Importante</span></button></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingId ? 'Guardar Cambios' : 'Confirmar Pedido')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isPaymentModalOpen} onClose={() => setIsPaymentModalOpen(false)} title="¿Cómo pagó?">
                        <div className="grid grid-cols-2 gap-4 pt-2">
                            <button onClick={() => confirmPayment('cash')} className="flex flex-col items-center justify-center p-6 bg-green-50 border border-green-200 rounded-2xl hover:bg-green-100 transition-colors gap-3"><div className="bg-green-100 text-green-700 p-3 rounded-full"><Banknote size={32} /></div><span className="font-bold text-green-800">Efectivo</span></button>
                            <button onClick={() => confirmPayment('transfer')} className="flex flex-col items-center justify-center p-6 bg-blue-50 border border-blue-200 rounded-2xl hover:bg-blue-100 transition-colors gap-3"><div className="bg-blue-100 text-blue-700 p-3 rounded-full"><CreditCard size={32} /></div><span className="font-bold text-blue-800">Transferencia</span></button>
                        </div>
                    </Modal>

                    <Modal isOpen={isExpenseModalOpen} onClose={() => setIsExpenseModalOpen(false)} title="Registrar Gasto">
                        <form onSubmit={handleSaveExpense} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={expenseForm.date} onChange={e => setExpenseForm({...expenseForm, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Descripción</label><input type="text" placeholder="Ej: Compra de yerba..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={expenseForm.description} onChange={e => setExpenseForm({...expenseForm, description: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Monto</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'cash'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${expenseForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><Banknote size={18} /> <span className="text-sm font-bold">Efectivo</span></button>
                                <button type="button" onClick={() => setExpenseForm({...expenseForm, method: 'transfer'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${expenseForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><CreditCard size={18} /> <span className="text-sm font-bold">Transf.</span></button>
                            </div>
                            <button type="submit" disabled={isSaving} className="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : 'Registrar Salida'}</button>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isIncomeModalOpen} onClose={() => setIsIncomeModalOpen(false)} title="Registrar Ingreso Extra">
                        <form onSubmit={handleSaveIncome} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Fecha</label><input type="date" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={incomeForm.date} onChange={e => setIncomeForm({...incomeForm, date: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Descripción</label><input type="text" placeholder="Ej: Inversión inicial..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={incomeForm.description} onChange={e => setIncomeForm({...incomeForm, description: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Monto</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={incomeForm.amount} onChange={e => setIncomeForm({...incomeForm, amount: e.target.value})} /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'cash'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${incomeForm.method === 'cash' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><Banknote size={18} /> <span className="text-sm font-bold">Efectivo</span></button>
                                <button type="button" onClick={() => setIncomeForm({...incomeForm, method: 'transfer'})} className={`py-3 px-4 rounded-xl border flex items-center justify-center gap-2 ${incomeForm.method === 'transfer' ? 'bg-stone-800 text-white' : 'bg-white text-stone-400'}`}><CreditCard size={18} /> <span className="text-sm font-bold">Transf.</span></button>
                            </div>
                            <button type="submit" disabled={isSaving} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : 'Registrar Ingreso'}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isInventoryModalOpen} onClose={() => setIsInventoryModalOpen(false)} title={editingProductId ? "Editar Producto" : "Nuevo Producto"}>
                        <form onSubmit={handleSaveInventory} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Producto</label><input type="text" placeholder="Ej: Mate Imperial" autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.name} onChange={e => setInventoryForm({...inventoryForm, name: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><input type="text" placeholder="Ej: Con virola de alpaca..." className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={inventoryForm.detail} onChange={e => setInventoryForm({...inventoryForm, detail: e.target.value})} /></div>
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Precio</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={inventoryForm.price} onChange={e => setInventoryForm({...inventoryForm, price: e.target.value})} /></div>
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingProductId ? 'Guardar Cambios' : 'Guardar Producto')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isDebtModalOpen} onClose={() => setIsDebtModalOpen(false)} title={editingDebtId ? "Editar Deuda" : "Nueva Deuda"}>
                        <form onSubmit={handleSaveDebt} className="space-y-5">
                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Detalle</label><input type="text" placeholder="Ej: Tarjeta Visa..." autoFocus className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={debtForm.detail} onChange={e => setDebtForm({...debtForm, detail: e.target.value})} /></div>
                            
                            {!editingDebtId && (
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-stone-400 uppercase">Tipo</label>
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setDebtForm({...debtForm, type: 'unique'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'unique' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>Único</button>
                                        <button type="button" onClick={() => setDebtForm({...debtForm, type: 'installments'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'installments' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>Cuotas</button>
                                        <button type="button" onClick={() => setDebtForm({...debtForm, type: 'fixed'})} className={`flex-1 py-2 text-sm rounded-xl border ${debtForm.type === 'fixed' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-500 border-stone-200'}`}>Fijo</button>
                                    </div>
                                </div>
                            )}

                            {debtForm.type === 'installments' && !editingDebtId && (
                                <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Cantidad de Cuotas</label><input type="number" placeholder="Ej: 6" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl" value={debtForm.installments} onChange={e => setDebtForm({...debtForm, installments: e.target.value})} /></div>
                            )}

                            <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase">Valor de la Cuota</label><input type="number" placeholder="0.00" className="w-full p-3 bg-stone-50 border border-stone-200 rounded-xl font-mono" value={debtForm.amount} onChange={e => setDebtForm({...debtForm, amount: e.target.value})} /></div>
                            
                            <button type="submit" disabled={isSaving} className="w-full bg-stone-900 hover:bg-stone-800 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-70">{isSaving ? <Loader2 size={20} className="animate-spin" /> : (editingDebtId ? 'Guardar Cambios' : 'Agregar Deuda')}</button>
                        </form>
                    </Modal>

                    <Modal isOpen={isDebtStatsOpen} onClose={() => setIsDebtStatsOpen(false)} title="Deudas Anuales">
                         <div className="space-y-4">
                            <div className="p-4 bg-stone-100 rounded-2xl">
                                <h4 className="font-bold text-stone-800 mb-4">Proyección de Pagos ({currentDate.getFullYear()})</h4>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    {debtsStats.map((item, index) => (
                                        <div key={index} className="flex items-center justify-between text-sm">
                                            <span className="text-stone-500 w-10">{item.label}</span>
                                            <div className="flex-1 mx-3 h-2 bg-stone-200 rounded-full overflow-hidden">
                                                <div className="bg-red-400 h-full rounded-full" style={{ width: `${(item.value / (Math.max(...debtsStats.map(d => d.value)) || 1)) * 100}%` }}></div>
                                            </div>
                                            <span className="font-bold text-stone-800 w-16 text-right">${item.value.toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="text-center text-xs text-stone-400">
                                Total anual estimado: <span className="font-bold text-stone-600">${debtsStats.reduce((a,b) => a + b.value, 0).toLocaleString()}</span>
                            </div>
                        </div>
                    </Modal>

                    <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} title="Configuración">
                        <div className="flex gap-2 mb-6 p-1 bg-stone-100 rounded-xl">
                            <button onClick={() => setSettingsTab('location')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${settingsTab === 'location' ? 'bg-white shadow-sm text-stone-900 ring-1 ring-black/5' : 'text-stone-400 hover:text-stone-600'}`}><MapPin size={14} /> Ubicación</button>
                            <button onClick={() => setSettingsTab('security')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${settingsTab === 'security' ? 'bg-white shadow-sm text-stone-900 ring-1 ring-black/5' : 'text-stone-400 hover:text-stone-600'}`}><Shield size={14} /> Seguridad</button>
                        </div>
                        {settingsTab === 'location' ? (
                            <form onSubmit={handleSaveLocation} className="space-y-4 animate-in fade-in duration-300">
                                <p className="text-sm text-stone-500">Ingresa tu ciudad para obtener el clima exacto.</p>
                                <div className="relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} /><input type="text" placeholder="Ej: Buenos Aires, Rosario..." className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={settingsCity} onChange={e => setSettingsCity(e.target.value)} autoFocus /></div>
                                <button type="submit" className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold disabled:opacity-50" disabled={isSearchingCity}>{isSearchingCity ? 'Buscando...' : 'Guardar Ubicación'}</button>
                                {locationConfig && <div className="text-xs text-center text-emerald-600 font-medium bg-emerald-50 py-2 rounded-lg border border-emerald-100 mt-2">Ubicación actual: {locationConfig.name}, {locationConfig.country}</div>}
                            </form>
                        ) : (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                <form onSubmit={handleUpdateCredentials} className="space-y-5">
                                    <div className="bg-blue-50 p-3 rounded-xl flex gap-3 items-start border border-blue-100"><Info className="text-blue-500 shrink-0 mt-0.5" size={16} /><p className="text-xs text-blue-700 leading-relaxed">Aquí puedes cambiar el usuario y contraseña para acceder al sistema.</p></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase ml-1">Nuevo Usuario</label><div className="relative"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} /><input type="text" className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={tempCredentials.user} onChange={e => setTempCredentials({...tempCredentials, user: e.target.value})} /></div></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-stone-400 uppercase ml-1">Nueva Contraseña</label><div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={18} /><input type="text" className="w-full pl-11 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl" value={tempCredentials.pass} onChange={e => setTempCredentials({...tempCredentials, pass: e.target.value})} /></div></div>
                                    <button type="submit" className="w-full bg-stone-900 text-white py-3 rounded-xl font-bold">Actualizar Credenciales</button>
                                </form>
                                <div className="border-t border-stone-100 pt-6">
                                    <h4 className="text-xs font-bold text-stone-400 uppercase mb-3">Diagnóstico de Conexión</h4>
                                    <button onClick={runDiagnostic} className="w-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"><Stethoscope size={18} /> Probar Conexión a Base de Datos</button>
                                    {diagMessage && (
                                        <div className={`mt-3 p-3 rounded-xl text-sm font-medium flex items-center gap-2 ${diagMessage.type === 'success' ? 'bg-green-100 text-green-800' : (diagMessage.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-stone-100 text-stone-600')}`}>
                                            {diagMessage.type === 'loading' && <Loader2 size={16} className="animate-spin" />}
                                            {diagMessage.type === 'success' && <Check size={16} />}
                                            {diagMessage.type === 'error' && <AlertCircle size={16} />}
                                            {diagMessage.text}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MateManagerApp />);
    </script>
</body>
</html>
